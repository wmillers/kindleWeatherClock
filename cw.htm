<!DOCTYPE html>
<html lang="zh-CN">
<head>
  <meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
  <meta name="viewport" content="width=device-width,initial-scale=1.0,maximum-scale=1.0, user-scalable=0">
  <script type="text/javascript">
    var testStatus=false;
    var testInterval=0;
    var info={
      version: '1.5',
      description: '(bug-fix changes are in commit logs)',
      author: 'wmillers@github',
      license: 'LGPL2.1'
    }
  </script>
  <title>tomatoClock</title>
  <link id='ico' href="" rel="icon" type="image/x-icon" />

	<style>
    table {
      border-spacing: 0;
    }
    .cleaner {
        background: black;
        position: fixed;
        width: 100%;
        height: 100%;
        display: none;
        z-index: 20;
        top: 0;
        left: 0;
    }
    .app {
      padding-top: 5.5rem;
      height: 45rem;
      width: 41rem;
      font-family: Arial,sans-serif;
      text-align: center;
    }
    .rotate {
      transform:rotate(270deg);
      -ms-transform:rotate(270deg); /* Internet Explorer 9*/
      -moz-transform:rotate(270deg); /* Firefox */
      -webkit-transform:rotate(270deg); /* Safari 和 Chrome */
      -o-transform:rotate(270deg); /* Opera */
    }
    .tickList {
      position: absolute;
      font-size: .5rem;
      left: -3.5rem;
      text-align: left;
      z-index: 1;
      white-space: pre-wrap;
    }
    .tl_to {
      width:1.5rem;
      background:white;
      display:inline;
      margin-left:-1.5rem;
      position:absolute;
    }
    .tl_co {
      text-align:right;
      font-size:1.5rem;
      background: white;
    }
    .tl_su {
      display: block;
      padding: 0;
    }
    .tl_de {
      font-size: 1.5rem;
      padding: .05rem 0;
      float: left;
      background: white;
      color: black;
    }
    .danmu_fr {
      position: absolute;
      font-size: 1rem;
      margin-top: 14rem;
      margin-left: -4rem;
      text-align: left;
      height: 15rem;
      width: 18rem;
      overflow: hidden;
      z-index: 1;
      word-break: break-all;
    }
    .danmu_info{
      display: block;
      font-size: .8rem;
      white-space: pre-wrap;
    }
    .time {
      font-size: 16rem;
      font-variant-numeric: tabular-nums;
      font-weight: 900;
    }
    .tomato {
      font-size: 2rem;
      font-weight: bold;
    }
    .date {
      font-size: 2rem;
      font-weight: bold;
    }
    .weath {
      margin-top: 1rem;
      margin-left: -3rem;
      width: 22.5rem;
      height: 2.8rem;
      display: block;
      -webkit-transform: scale(2.6);
      transform: scale(2.6);
      -webkit-transform-origin: 0 0;
      transform-origin: 0 0;
    }
    .basket{
      margin-top: 6rem;
      font-size: 1rem;
      overflow: hidden;
      word-break: break-all;
      height: 2rem;
    }
    .tImg{
      content: url('data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAQAAAAEACAMAAABrrFhUAAAAjVBMVEVHcEwAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAABHlAdGAAAALnRSTlMABd4y/W4R7fYg8kugJgL7Zq11e0PRCT7MGY3G48Ca6C3XDbRYFJRfUbqHpziBjswJ2QAAC15JREFUGBntwAeColoCBdALSEaSEXPO3v0vb6arq5oHgooRf3FQqVQqlUqlUqlUKpVKpVKpVCqVSqVSqVQqlcpzLdV+tzuy8VttdH4ZRviVfI/fBgp+H2nFmGXjt3H3FHkb/C5SwCRvg19lzzSviV9kx1OWgl/DZ5ZBhF9iYjDTUMKvMJOZY4dfwWGe2gG/QJP5pm3857VlnnHEf16DCfKIIiPCf9zSosiauAFFDv7jVkzYAO0pBbU6/gOiib1Y+OtNc6IhaWlQNAKAiUHBCAmzib1WG40wVBcdEx9hszUY07urdR3/NCiSZ/gjpMBY4tvMPs7HFE3XKD1pz1ODkS3hD2lMkY0vUouCEH+Y4dDjqRHKrsds+koBYFM0x7cOBVOg7Q+ZQ0W5mR5z9W0EFCn4MafAPurMpbdRaiHPmRoUBPhH4dVslJrD63UQG/JaPkpty6u1IFjwWguU2pRXCyFoW7xOzUSpjXk1E6I9rxOg3HReq4WEBa8yiFBuFq/VQ0LEawxNlJzFWDDaz6cWc2yQNGU2eTtqhL6vHlejXQelN2CsiT/qi9GYGUwkBTwl9zYRPsuUsQ2+uYeRwRTDRdKRKXpPwefpM6YipjV0JvSRsmGCrLbxiQLGehDNjgYFIVKiGmO6KuEz9RhzkFQf8p9aHWkO/xlp+FQqYz2khR6/rXBi2eJfYxufq8PYAicUmV8cCae0UY2k1Vvig7kyfwzaOOUuuqwFHWSLFr6t4bM1Pf5Vs/E72Tr/MBb4rTQ16PZ3ESqVyiyaKJ1ms6MopinhF5kd1rt9f+BRNO7OV2pTQxHasWUY42l/31Nt08UncBXVmfKMwfx4kHCdw5gCoztaT1yUWeQHOq9gzdUJLjN1ntADtY5yMhtdFiCvNkuc5zDbdKegbDS/z+JaPXuGXJLBXNOGiRJRRgZv5G3VCNnqPGu7cVEO9pD36YZLZJjwgkE4w/stWryfF9gu0mYeL7F2S7yX3eWDDI4RUua8zDrO8D6TIR/IcyZIqFu8gh5KeA9tVeODzTsQdXReY2rjHRZjPkF/4yK2PLYMXiGI8GpRwLPG8526aE6W+KMdTey1uhqOeYXuBAkzc2L7x33L4xm6j9fa6MylB6EdIdOyE84tXmBNkEVSfGfAXPMlXqc9Yp7WriPhLOnQ2Bo8p4VcSqNfY7ZBB69SbzHbVI1wlXanMR8zVxNnLNd9Zqo1XLyErTOL5RxQyMTfW8zUwHmTlc4s2wgvoNaYQfZnKE5qrgY81cMl7XWLGcYHPN2OGWRfwo3c5t5gSogrbKY8ZWzwXJLDU7Iv4VTdd1ryUJ3hIk1tMWGCa7iLKU+FeKbZlieMhoQ0Mwx0/iUruEJzy9gcV5J8nSd2eB6tyxPbOlLMsEuBbuIayt7jX9MlrhbteWKEZ9G6TBsvkDRT+0wJcB1zZZH0HA1F2AOmrfAcWpdpcw0J0U7niZqGK7U7C3uJgmYrpu3wDO0hU7yjC9FkZDBLB8+10ZnSwOO5AVPkA0RmwBwdPFm9xRQVD7diylaDYLYzmKMW4dnaDlPWeDCfKY6EmOuPmWuLF1CZ5HXwUE2PSTsIzD7zGQpeYe0xYWzigSKdCTUVAt9iPmOD17ANJrTaeBipz4TaGrFlwHyWU8erHHQmjPAwOyapiDXHzDEOVEXCC9lMWuNBOjUmNBBbe8zUDet4NWnMBKOOh5jJTOghtmOWaaOOd+gxqe/iEUZMcPBPO2CGoe3iPQ5MaeABOkzotvFD6/NEba/gfQZMMuq4mzSlSDfxQ+vyRP+Ad1oxZYi7NSiq2fihtZgmL/BeNtPWuFNkUdTAj3afKbVeG28285gynuE+DkV9F9+kOVMGTbxfn2k73GVSo8Co40ePKXsNJbBjmmHiHgFFDfxYMKkWohQ2POHgDgpFLQnfJgYTjA3KweSJWh23CyioKfimyUwYKCgLnSf2uFm9RoGDH3MmyCZKY8gTnolbjSjwTHxbMGFgojxGPNXDjZYGBSv82FI0rqNEQp6yNNwmpMCI8EOnQJ+gTBbMoOI2Uwp2+EdnrNZEqRyYYYqbdCjwIvzTZyxEuUTM0sEtRhQEiKn8J0DJtJnFwQ0knYImYu0Wv7VmKBuDGaw2irMpmEJkTvmlG6F0BsyyQXEOBSoS2v5Qt/qqhPKRmWWP4saMeRo+xZRZLAlFKRRs8TFazNREUQ0KVHyMFjP1UNSQAhMfY8pMLRQkGYy18DlkZqppKOZAwRGfY8BsNopRKWjic4yZbYdiHAo0fA6d2bYopsWYjA9iMJuOQiSPsT0+h1tjDhNF1CkI8W3Z2M97B5TZknmaKMKmoIm/Fjr/2JsorzrzqChCpcDEl5DfDBuldWCeFYrYUSDhD6XGH9YSZWUzzxxFOIzp+LJnrIGyWjNPF0VsGWvhy5ixOcoqZJ4BiugyNscXj7E+yqrHPB6KmDLm4MuUsRHKas5cbRQwYKyHLzvGbJRVi7kiFKAztsMXbcwffZSWwVwmCjAYa+Cvpse/xibKKmK+CQowGAvx7SDzj76J0uown4ICLMZC/Giv911ngxJbM5+CAizGGvgcPeaboACdsQY+x5D5JihAZqyHz2Exn4kCuoyN8DHqPGOJAoaMBfgYC54hoYCAsT4+Ro/5DBSxYkzGx+gzn4wiQsY8Fx9i5jHfEEUsKDDxITY8Y48iDhTY+BAjnrFDERoFKj7EgGesUciYMQefYcJzDihkyNgUnyHkORoKWTFWm+EjdHnGAMWsKbDxCSY8J0AxdQp2+AQ9nhOiIJ2xLj6ANOY5HRQUUBCh/GyeY7RRkEqBj/ILeM4QRdUp2KL0TI/nNFDYgDFvibJb8SwFha0oUFFyS4PnDFwU1qSgi5Lr8awVipN0ChSUWmTwrCZuMKLAQamNeNbYxQ0OFBgRSkyp8awdbjKl4IgS6/O8Om4SUmBpKC2f5/Vxm8ig4IiyMi2et8CNHAqsJcrJ3fK8gYQbTShaoZwavCDEzYYU1CYoo47H8ywNN2tSNEQJmWNecMQdhhT5KJ1ZixdYGu7QoUiPUDLtIS9p4C5biuYoF2nOSwYz3GXiUaSiTNpzXrTGnVYUGROUx2zIi/q411KnSNZQFmaLF9UU3G3NhK2LcuiMeVkPD7BlQg9l4IYeL5PbeADTYIKK9zOHvEKtiYfwmVBb4M0k1eI1dniQgAneBm/VafEqXQkPshwwwbPxKIdGL1RQhDLndaw6HqbjMcGw8RDKkH9Mwzau1Al4rQ0eSGWSt8b9lqMav41VCZfN/C6vdsRDOUxp4E6uqlMgr12c1bb3Bq8XuHiodp8pTht3cBdTprQWLvLU/bnBIrptPNhyypSuiZttWswgqxpORM0wGLMgOcLDmWOm6DZuIq27zGFsw2bUhqRp5qSz8Xf7vs4bjOt4gonONGeGwqJwwCfTFTzFRGea3EEhs8Xc47PpCp5kovOEE+Fay0Vg8Pl0BU9Tl3lCVyVcJNXXzpQvMZjgiaIWT8kLFzG3udvKOo1WsDqGvu+HR2c4qPFVpiaeStsyQ2vj4i/Jl/lOwyWeTFoxi6zOAEAb8q1GEp7PN5hFXylwh3wnT8VLKFNma434TvIBLzJzWEJzDa+z0Fkylo+XWjosla2JV9vILI3xGm/QPhoshZqzxHuY+xrfbz7B+0wCvlm/g/dS9jW+z7aJ9zNHFt/C2ysoh5nf5csNdhFKROkN+EL6qOmiZNxOb8qXGIxsCeVkqsGYl1mt+Sr0Nx2lbv5fXTnY67AXdMe8zNqGCsqtvl4NdeYwuk7YjJBD6/iroc4cRnekKi4+Q9RZH515fzrWLdLQdbm73e98u+7iMrPpH51tfzrWLdLQdbk/d3Z+03RRqVQqlUqlUqlUKpVKpVKpVCqVSqVSqVQqlcpt/gflLyIabDWsTgAAAABJRU5ErkJggg==');
      height: 2rem;
      width: auto;
      background-color: white;
    }
    .inform {
      margin-top: 0.5rem;
      font-size: 1.5rem;
      font-weight: normal;
    }
    .reminder {
      display: none;
      margin: -23rem 8.5rem; 
      padding: 1rem;
      width: 22rem;
      position: absolute;
      border: dotted;
      background-color: rgba(255, 255, 255, 0.8);
      font-size: 1.5rem;
      font-weight: bold;
    }
  </style>
</head>
<body>
  <div class="cleaner" id="cleaner"></div>
	<div class="app"><div class="rotate">
    <div class='tickList' id='tickList' onclick="showIcs()"><img class="tImg" style="padding:1rem"></div><div style='height:6rem;'></div>
    <div class='danmu_fr' id='danmu_frame' onclick="danmuSwitch()"><span class='danmu_info' id='danmu_info'></span><span id='danmu'></span></div>
    <div class="time" id="time"><span id="hour" onclick="switchTomato()">00:</span><span id="minute" onclick="pauseTomato()">00</span></div>
    <div class="tomato"><span id="tom" onclick="comment(runTime())">TOMA</span><span id="ato" onclick="initDateFromServer()">MATO</span></div>
    <div class="date" id="allDate" onclick="correctPrompt()"><span id="date">0月0日</span> <span id="week">星期零</span></div>
    <iframe class='weath' id="ifrmid" scrolling="no" frameborder="0" allowtransparency="true" src="//i.tianqi.com/index.php?c=code&id=2&bdc=%23&icon=5&num=3&site=15" sandbox="allow-scripts" style="pointer-events: none;"></iframe>
    <div class='basket' id="basket"></div>
    <div class="inform" id="inform" onclick="fridgeTomato();onlineWeather();">同步时间：<span id="sync">0000-00-00 00:00:00</span> <span id="timeoffset">+0s</span> <span id="net">未同步零</span></div>
    <div class='reminder' id='reminder' onclick="displayReminder(false)"></div>
  </div></div>
  <script type="text/javascript">
    if (testStatus){testInterval=setInterval('comment(how(), true)', 7*1000);setTimeout('testIcs()', 10*1000);}
    var initialTitle=document.getElementsByTagName('title')[0].innerHTML;
    var clearCommentTime=0;
    function comment(s, isJam){
      var basket=document.getElementById('basket');
      var lag=30*60*1000;
      s=String(s);
      setTimeout("clearComment()", lag+1000);
      if (basket.innerHTML.length==0||isJam)
        basket.innerHTML=s;
      else {
        basket.innerHTML+='|';
        if (s.length>100){
          basket.innerHTML+=s;
          while (basket.scrollHeight>basket.clientHeight*1.25)
            basket.innerHTML=basket.innerHTML.slice(1);
        } else
          for (var i=0;i<s.length;i++){
            basket.innerHTML+=s[i];
            if (basket.scrollHeight>basket.clientHeight*1.25)
              basket.innerHTML=basket.innerHTML.slice(-Math.floor(basket.innerHTML.length/2));
        }
      }
      clearCommentTime=new Date().getTime()+lag;
      return s;
    }
    function clearComment(){
      if (new Date().getTime()<clearCommentTime) return;
      document.getElementById('basket').innerHTML='';
    }
    if (!testStatus)
      window.onbeforeunload = function(e){
        var dialogText = '#preventReload';
        e.returnValue = dialogText;
        return dialogText;
      };
  </script>
  <script type="text/javascript">
    var toStatus, ispaused, weeklyTomato;
    var timerEntity;
    var signalTired=0;
    var toWorkTimer=25*60;//Second
    var timerEnd, restWhenPaused;
    var toRestTimer=5*60
    var expireTomato=30;//Day
    var tomatoMsg=[document.getElementById('tom'), document.getElementById('ato'), document.getElementsByTagName('title')[0]];
    var buttonStyle=[document.getElementById('hour').style, document.getElementById('minute').style]
    var shinningSignal=[document.getElementById('ato').style, document.getElementById('inform').style, document.getElementById('allDate').style];
    prepareTomato();
    //dumpTomato();gatherTomato(719);
    function dumpTomato(){rottenTomato(-1);}
    function gatherTomato(fakeTomatos){
      if (!weeklyTomato.length) eatTomato();
      if (fakeTomatos)
        for (var i=0;i<fakeTomatos;i++)
          weeklyTomato.push(-1);
      else
          weeklyTomato.push(Math.floor(new Date().getTime()/(24*3600*1000)));
      canTomato();
      showTomato("Gather");
    }
    function canTomato(){document.cookie = "tomato="+compressTomato()+";expires="+ new Date(0x7fffffff * 1e3).toUTCString();}
    function compressTomato(){
      var compressed="";
      for (var i in weeklyTomato){
        if (i!=0) compressed+='.';
        compressed+=Math.floor(weeklyTomato[i]).toString(36);
      }
      return compressed;
    }
    function showTomato(source){
      var _doc=document.getElementById('basket');
      _doc.textContent="";
      var f=[1,2,20,60,180];
      var res=0;
      var tomatos=weeklyTomato.length;
      for (var i=f.length-1;i>=0&&tomatos!=0;i--){
        res=Math.floor(tomatos/f[i]);
        tomatos%=f[i];
        for (var j=0;j<res;j++)
          enchantTomato(_doc, ['opacity: 0.5;',"",'border:0.1rem dashed black;','border:0.1rem solid black;','border:0.1rem solid black; background-color: #c0c0c0'][i]);
      }
      if (weeklyTomato.length!=0) _doc.insertAdjacentHTML("beforeend", weeklyTomato.length);
      logTomato(source);
    }
    function enchantTomato(_doc, magicType){
        var script=document.createElement('img');
        script.setAttribute('class','tImg');
        if (magicType) script.setAttribute('style',magicType);
        _doc.appendChild(script);
    }
    function eatTomato(){
      var offset=document.cookie.indexOf("tomato=");
      var end = document.cookie.indexOf(";",offset);
      if (offset!=-1){
        offset+="tomato=".length
        if (end==-1) end=document.cookie.length;
        var content=document.cookie.substring(offset, end);
        if (content){
          weeklyTomato=Array();
          content=content.split(".");
          for(var i in content)
            if (parseInt(content[i], 36))
              weeklyTomato.push(parseInt(content[i], 36));
        }
        logTomato("Read");
      }
    }
    function logTomato(source){
      if (weeklyTomato.length==0)
        console.log("Empty >ToMaMaTo< Store from "+source);
      else
        console.log("Len:"+weeklyTomato.length+" "+source+":"+weeklyTomato.slice(0,5));
    }
    function rottenTomato(expire){
      var date=Math.floor(new Date().getTime()/(24*3600*1000))-(!expire?expireTomato:expire);
      weeklyTomato.sort(function(a, b){return b-a;});
      for (var i in weeklyTomato)
        if (weeklyTomato[i]<date){
          weeklyTomato=weeklyTomato.slice(0, i);
          break;
        }
      canTomato();
      setTimeout("rottenTomato()", expireTomato*24*3600*1000/3);
      showTomato("Rotten");
    }
    function secondsUntilNow(future){
      return Math.round((future-new Date().getTime())/1000);
    }
    function updateMsg(tom, sliceIndex){
      if (tom){
        if (sliceIndex) tom+=tomatoMsg[0].innerHTML.slice(sliceIndex);
        if (tom.slice(-2)!=": ") tom+=": "
        tomatoMsg[0].innerHTML=tom;
      }
      timerCount=secondsUntilNow(timerEnd);
      timeString=""+frontZero(Math.floor(timerCount/60))+":"+frontZero(timerCount%60);
      tomatoMsg[1].innerHTML=timeString;
      tomatoMsg[2].innerHTML=timeString+(toStatus=='work'?" <TOM":" <ATO");
    }
    function fridgeTomato(){
      prepareTomato();
      tomatoMsg[0].innerHTML="MATO";
      tomatoMsg[1].innerHTML="TOMA";
      tomatoMsg[2].innerHTML=initialTitle;
      killShadow();
    }
    function prepareTomato(){
      //quit from tomato
      preventDecreaseShadow=false;
      lessDisturbUpdateWhenTomato=false;
      toStatus='stop';//work,rest,stop
      ispaused=false;
      weeklyTomato=Array();
      eatTomato();
      clearTimeout(timerEntity);
      updateButton();
    }
    function switchTomato(){
      switch (toStatus){
        case 'stop':
          toStatus='work';
          setTimer();
          preventDecreaseShadow=true;
          lessDisturbUpdateWhenTomato=true;
          timerEnd=new Date().getTime()+toWorkTimer*1000;
          rottenTomato();
          updateMsg("番茄开始");
          updateButton();
          break;
        case 'work':
          toStatus='rest';
          restWhenPaused=toRestTimer*1000;
          timerEnd=new Date().getTime()+restWhenPaused;
          clearTimeout(timerEntity);
          updateMsg("番茄中场");
          pauseTomato();
          break;
        case 'rest':
          toStatus='work';
          restWhenPaused=toWorkTimer*1000;
          timerEnd=new Date().getTime()+restWhenPaused;
          clearTimeout(timerEntity);
          updateMsg("番茄工作");
          pauseTomato();
          break;
      }
    }
    function setTimer(){
      clearTimeout(timerEntity);
      timerEntity=setTimeout('tomatoTimer()',1000);
    }
    function tomatoTimer(){
      if (timerEnd<new Date().getTime()){
        if (toStatus=='work')
          gatherTomato();
        switchTomato();
      } else {
        updateMsg();
        setTimer();
      }
    }
    function updateButton(){
      buttonStyle[1].color=(ispaused)?'#303030':'#a9a9a9';
      if (toStatus=='stop') buttonStyle[1].color='#000000';
      buttonStyle[0].color=['#000000', '#303030', '#a9a9a9'][['stop', 'work', 'rest'].indexOf(toStatus)];
    }
    function updateSignal(){
      if (ispaused && toStatus!='stop'){
        if (signalTired>toWorkTimer){
          tomatoMsg[2].innerHTML=initialTitle;
          for (var i in shinningSignal)
            shinningSignal[i].color='#000000';
        } else {
          if (signalTired%2==0){
            tomatoMsg[2].innerHTML='✔ * * * ✔';
            for (var i in shinningSignal)
              shinningSignal[i].color='#ffffff';
          } else {
            tomatoMsg[2].innerHTML='* RELAX *';
            for (var i in shinningSignal)
              shinningSignal[i].color='#000000';
          }
          if (signalTired==0 || signalTired==toWorkTimer)
            killShadow(true);
          signalTired++;
          setTimeout('updateSignal()', 800);
        }
      } else {
        signalTired=0;
        tomatoMsg[2].innerHTML=initialTitle;
        for (var i in shinningSignal)
          shinningSignal[i].color='#000000';
      }
    }
    function pauseTomato(){
      if (toStatus=="stop") return;
      ispaused=!ispaused
      if (ispaused){
        clearTimeout(timerEntity);
        restWhenPaused=timerEnd-new Date().getTime();
        updateMsg("暂停", -4);
      } else {
        setTimer();
        timerEnd=new Date().getTime()+restWhenPaused;
        updateMsg("番茄", -4);
      }
      updateButton();
      updateSignal();
    }
  </script>
  <script type="text/javascript">
    var refreshRate=8*3600*1000;
    var hardwareLagRate=6.66;//+1s/6.66h
    var lastSyncTime;
    var timeOffset=0;
    var preventDecreaseShadow=false;//Stop when tomato
    var lessDisturbUpdateWhenTomato=false;//less time update flash when tomato
    var cleaner=[document.getElementById('cleaner').style, document.getElementById('time').style];
    var clock=[document.getElementById("hour"), document.getElementById("minute"), document.getElementById("date"), document.getElementById("week")];
    var initTime=new Date().getTime();
    var initTimeOffset=0;
    var averageTimeOffset=[];
    var hasClockInit=false;
    var networkFaliure=false;
    var nextCmdList=0;
    var cmdListCount=0;
    var cmdList={};
    var weatherTaskIndex=0;
    var tickListAlarm='';
    initDateFromServer();
    adjustAgainstHardwareTimeLag();//extra offset cycle
    initBrowserPage();
    setTimeout("initClockWeather()", 1000);//if server not responsed in 1s, use local time instead

    function adjustAgainstHardwareTimeLag(lag){
      if (lag==undefined||lag<hardwareLagRate*3600*1000) lag=hardwareLagRate*3600*1000;//add 1s offset every xxx hour
      if (hasClockInit) timeOffset+=1000;
      setTimeout("adjustAgainstHardwareTimeLag("+lag+")", lag);
    }
    function initDateFromServer(calculate){
      if (calculate){
        if (!averageTimeOffset) return false;
        var oldHardwareLagRate=hardwareLagRate;
        var dOffsetPerSecond="";
        var dTimeOffset=0;
        var sum=0;
        for (var i in averageTimeOffset)
          sum+=averageTimeOffset[i];
        timeOffset=Math.floor(sum/averageTimeOffset.length);
        if (!initTimeOffset && timeOffset) initTimeOffset=timeOffset;
        if (initTimeOffset){
          var uptime=new Date().getTime()-initTime;
          if (Math.abs(timeOffset-initTimeOffset)>200){
            dTimeOffset=timeOffset-initTimeOffset;
            if (uptime>3600*1000){
              var newHardwareLagRate=Math.floor((uptime/1000/3600)/(dTimeOffset/1000)*100)/100;
              dOffsetPerSecond="1s/"+newHardwareLagRate+"h"+"("+oldHardwareLagRate+")";
              if (uptime>3*24*3600*1000) hardwareLagRate=newHardwareLagRate;
            }
          }
        }
        dTimeOffset=dTimeOffset?"("+timeFormat(dTimeOffset)+")":"";
        console.log(comment(timeOffsetFormat(2)+dTimeOffset+"#"+dOffsetPerSecond+"#"+timeFormat(uptime, 3, true)+""));
        document.getElementById('timeoffset').innerHTML=timeOffsetFormat();
        return true;
      } else {
        averageTimeOffset=[];
        singleDateFromServer(20);
      }
    }
    function singleDateFromServer(n){
      xmlhttp = new XMLHttpRequest();
      xmlhttp.open("HEAD", noCache(), true);
      xmlhttp.onreadystatechange=function(){
        if (xmlhttp.readyState==4){
          if (networkFaliure){
            networkFaliure=false;
            return;
          }
          if (n>0)
            setTimeout('singleDateFromServer('+(--n)+')', 100);
          else {
            initDateFromServer(true);
            return;
          }
          if (xmlhttp.status!=0){
            var serverTime=new Date(xmlhttp.getResponseHeader("Date")).getTime();
            var clientTime=new Date().getTime();
            timeOffset=serverTime-clientTime+2300;//preset lag==>+1s(screen refresh time)
            averageTimeOffset.push(timeOffset);
            console.log(frontZero(n+1)+"#"+Math.floor(serverTime/1e5)+":S"+serverTime%1e5/1000+".:C"+clientTime%1e5/1000+":"+timeOffsetFormat());
            comment("Calculating..."+timeOffsetFormat(3), true);
            //initClockWeather();//immediately after date time got from server
          } else {
            networkFaliure=true;
            comment("Failed(ServerTime)#1s/"+hardwareLagRate+"h("+timeOffsetFormat(3)+")");
          }
        }
      }
      xmlhttp.send(null);
    }
    function addTaskOnPageChange(cmd, interval, isTimeout){
      var t=getOffsetTime(interval);
      var tag=cmd;
      if (isTimeout) interval=true;
      if (cmdList[cmd]!=undefined)
        cmdList[cmd]=[cmdList[cmd][0], interval, t];
      else {
        tag=cmd.slice(0,3)+frontZero(++cmdListCount)+cmd.slice(-2);
        cmdList[tag]=[cmd, interval, t];
      }
      refreshTaskOnPageChange();
      return tag;
    }
    function runTaskOnPageChange(){
      //nextCmdList=1500, cmdList={tag0:['f()', interval, end], tag1:['f()', 86400*1000, 15000000], tag2:['',true,1500]};
      var t=getOffsetTime();
      if (nextCmdList-59*1000<t){
        nextCmdList=0;
        for (var i in cmdList){
          if (cmdList[i][2]-59*1000<t){
            eval(cmdList[i][0]);
            if (cmdList[i][1]===true)
              cmdList[i][1]=false
            else 
              cmdList[i][2]=getOffsetTime(cmdList[i][1]);
          }
        }
        refreshTaskOnPageChange();
      }
    }
    function refreshTaskOnPageChange(){
      for (var i in cmdList)
        if (cmdList[i][1]===false)
          delete cmdList[i];
        else 
          if (nextCmdList==0||cmdList[i][2]<nextCmdList)
            nextCmdList=cmdList[i][2];
    }
    function initBrowserPage(){
      setIcon();
      killShadow();
      addTaskOnPageChange("killShadow()", 86300*1000);//24*3600=86400 & 1700 --> 17*24*3600
      addTaskOnPageChange("reduceShadow()", 3100*1000);//prime number 60*60=3600
    }
    function initClockWeather(){
      if(hasClockInit) return;//avoid duplicated init clock;
      hasClockInit=true;
      var date=getOffsetDate();
      //update() included in updateInterval()
      updateInterval();
      //No need to update weather manually at the first time.
      document.getElementById('sync').innerHTML=date.getFullYear()+'-'+frontZero(date.getMonth()+1)+'-'+frontZero(date.getDate())+' '+frontZero(date.getHours())+':'+frontZero(date.getMinutes())+':'+frontZero(date.getSeconds());
      document.getElementById('timeoffset').innerHTML=timeOffsetFormat();
      document.getElementById('net').innerHTML='初始化同步';
      weatherInterval();
    }
    function setIcon(){
      for (var i in document.styleSheets)
        for (var j in document.styleSheets[i].cssRules)
          if (document.styleSheets[i].cssRules[j].selectorText=='.tImg'){
            document.getElementById('ico').href=document.styleSheets[i].cssRules[j].style.content.slice(5,-2);
            return true;
          }
      return false;
    }
    function killShadow(force){
      if (force||!preventDecreaseShadow)
        for (var i=0;i<3;i++)
          setTimeout('cleaner[0].display="'+["block", "block", "none"][i]+'";'+
                    'cleaner[0].background="'+["black", "white", "black"][i]+'"', 600*i);
    }
    function reduceShadow(){
      if (!preventDecreaseShadow)
        for (var i=0;i<2;i++)
          setTimeout('cleaner[1].opacity='+[0, 1][i], 600*i);
    }
    function runTime(n){return timeFormat(new Date().getTime()-initTime, n?n:3, true);}
    function noCache(){return "?noCache="+document.body.clientWidth+"."+document.body.clientHeight+"."+(""+Math.random()).slice(2,9);}
    function frontZero(a, n){
      if (!n) n=2;
      if (typeof a!='object')
        a=[a];
      for (var i in a)
        if (typeof a[i]=='number'){
          a[i]=a[i].toString();
          for (var j=n-a[i].length;j>0;j--)
            a[i]='0'+a[i];
        }
      return a.join('');
    }
    function timeFormat(s,n,noPlus){
      s=Math.floor(s);
      if (s==0) return "";
      if (!n) n=3;
      var str="";
      var a="";
      if (s>0)
        a="+";
      else {
        a='-';
        s=-s;
      }
      if (s<1000)
        str="."+frontZero(s,3)+"s";
      else{
        var f=[[10,100,60,60,24,365,100,10], ["","s","m","h","d","Y","C","T"]];
        var fsum=1;
        for (var i in f[0])
          fsum*=f[0][i];
        for (var i=f[0].length-1;i>0&&n>0;i--){
          if (s>=fsum){
            str+=Math.floor(s/fsum)+f[1][i];
            s%=fsum;
            n--;
          }
          fsum/=f[0][i];
        }
        if (s!=0&&n>0)
          str+=frontZero(Math.floor(s/fsum), 2)+f[1][0];
      }
      return (!noPlus||a=='-'?a:"")+str;
    }
    function timeOffsetFormat(n){return timeFormat(timeOffset, !n?2:n);}
    function how(){
      var inspect=['runTime(2)', 'weeklyTomato.length', 'countIcs()', 'hardwareLagRate'];
      var o='';
      var res;
      for (var i in inspect){
        res=eval(inspect[i]);
        if (typeof res=='number'&&res>5*60*1000)
          res=timeFormat(res,2,true);
        o+=inspect[i].slice(0,6)+':'+res+',';
      }
      o+='['+(Object.keys(cmdList).length-1)+','+dateString(nextCmdList)+']:';
      for (var i in cmdList)
        o+=i+(cmdList[i][1]!==true?','+timeFormat(cmdList[i][1], 2, true)+',':'T')+dateString(cmdList[i][2])+'|';
      return o.slice(0,-1);
    }
    function wipe(){document.getElementById('basket').innerHTML='';}
    function test(s){
      if (testStatus=!testStatus){
        comment(how());
        testInterval=setInterval('comment(how(), true)', (s==undefined?58:s)*1000);
      } else
        clearInterval(testInterval);
      update();
    }
    function loop(){
      test(true, 3);
      setInterval('timeOffset+=57*1000;update()', 50);
    }
    function correctPrompt(){
      var help={vari: ['who', 'credit', 'help'],
                func: ['how', 'wipe', 'test', 'loop', 'testIcs'],
                who: navigator.userAgent,
                credit: JSON.stringify(info).replace(/"/g,'')};
      [].push.apply(help.help=help.func, help.vari); 
      var userIuput=prompt(timeOffsetFormat(3)+'\nTo Manually change kindle system time:\n;st 2020-07-22 17:59\n\nPlease ENTER number:\nformat: 235959 (hhmmss->23:59:59)\n* 123456 means reset *\n'+help.help);
      if (!timeCorrect(userIuput))
        try{
          if (help.vari.indexOf(userIuput)!=-1)
            userIuput='help.'+userIuput;
          else if (help.func.indexOf(userIuput)!=-1)
            userInput+='()';
          var s=eval(userIuput);
          comment(s==undefined?'u':s);
        } catch (e){
          comment(e);
        }
    }
    function timeCorrect(correct){//000000~235959
      if (!correct||correct.length!=5&&correct.length!=6) return false;
      if (correct=="123456")
        timeOffset=0;
      else {
        var hms=[correct.slice(-6,-4), correct.slice(-4,-2), correct.slice(-2)];
        var allow=[[0,23],[0,59],[0,59]];
        for (var i in hms){
          hms[i]=Math.floor(parseInt(hms[i]));
          if (!(hms[i]>=allow[i][0]&&hms[i]<=allow[i][1])) return false;
        }
        var date=new Date();
        date.setMinutes(date.getMinutes() + date.getTimezoneOffset() + 480);
        timeOffset=(((hms[0]-date.getHours())*60+(hms[1]-date.getMinutes()))*60+(hms[2]-date.getSeconds()))*1000;
      }
      update();
      return true;
    }
    function getOffsetDate(offset, noShift){
      var date=new Date();
      if (typeof offset!='number') offset=0;
      if (!noShift) date.setMinutes(date.getMinutes() + date.getTimezoneOffset() + 480);
      date.setMilliseconds(date.getMilliseconds()+timeOffset+offset);
      return date;
    }
    function getOffsetTime(offset, noShift){return getOffsetDate(offset, noShift).getTime();}
    function updateInterval(){
      var mscs=getOffsetTime();
      setTimeout("updateInterval()", lessDisturbUpdateWhenTomato?((599999-mscs%600000)+50):(59999-mscs%60000)+50);//(60*10)*1000+50
      update();
    }
    function update(){
      var date=getOffsetDate();
      runTaskOnPageChange();
      if (timeOffset==0)//fix the bug on kindle
        date.setMinutes(date.getMinutes()+1);
      clock[0].innerHTML = frontZero(date.getHours())+':';
      clock[1].innerHTML = frontZero(date.getMinutes());
      clock[2].innerHTML = (date.getMonth() + 1) + '月' + date.getDate() + '日';
      clock[3].innerHTML = '星期'+['日', '一', '二', '三', '四', '五', '六'][date.getDay()]
      clock[3].innerHTML+= '<span style="font-size:1.5rem;position:absolute;"> '+(testStatus?'#envTest':'')+' '+tickListAlarm+"</span>";
      return date;
    }
    function weatherInterval(){
      var date = getOffsetDate();
      var nextRefresh=0;
      if (!lastSyncTime) lastSyncTime=date.getTime();
      if (date.getTime()-lastSyncTime>refreshRate+100000)
        nextRefresh=10*60*1000;
      else if (date.getHours()+refreshRate/1000/3600<24)
        nextRefresh=refreshRate;
      else//calculate time till 00:00
        nextRefresh=24*3600*1000-date.getTime()%(24*3600*1000)+50;
      if (weatherTaskIndex==0)
        weatherTaskIndex=addTaskOnPageChange('weatherInterval()', nextRefresh);
      else
        addTaskOnPageChange(weatherTaskIndex, nextRefresh);
      if (date.getTime()-lastSyncTime>10000)
        setTimeout('onlineWeather()', 100);
    }
    function onlineWeather(){
      var _doc=document.getElementsByTagName('body')[0];
      var script=document.createElement('img');
      script.setAttribute('id','testConnection');
      script.setAttribute('src','//www.163.com/favicon.ico'+noCache());
      _doc.appendChild(script);
      script.onload=script.onreadystatechange=function(){
        if(!this.readyState||this.readyState=='loaded'||this.readyState=='complete')
          weather(true);
        else
          weather(false);
        script.onload=script.onreadystatechange=null;
      }
      _doc.removeChild(script);
    }
    function weather(connected)
    {
      var date=getOffsetDate();
      if (connected){
        lastSyncTime=date.getTime();
        document.getElementById('ifrmid').src=document.getElementById('ifrmid').src;//change iframe
        document.getElementById('sync').innerHTML=date.getFullYear()+'-'+frontZero([date.getMonth()+1,'-',date.getDate(),' ',date.getHours(),':',date.getMinutes(),':',date.getSeconds()]);
        document.getElementById('timeoffset').innerHTML=timeOffsetFormat();
        document.getElementById('net').innerHTML='完成上一次同步';
      } else
        document.getElementById('net').innerHTML='无网络连接';
    }
  </script>
  <script type="text/javascript">
  /*
    Note: you need set a Nginx server to proxy the GET method to the
          calendar server to download the .ics file. Add those lines
          to your Nginx config file to avoid CROS problem as the
          request is directly from your browser which has banned the
          act for some security reason.
          
    location /ics/ {
      proxy_redirect off;
      proxy_buffering off;
      proxy_http_version 1.1;
      proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
      proxy_set_header Upgrade $http_upgrade;
      proxy_set_header Connection $http_connection;
      add_header Access-Control-Allow-Methods *;
      add_header Access-Control-Allow-Credentials true;
      add_header Access-Control-Allow-Origin $http_origin;
      if ($request_method = OPTIONS){
        return 200;
      }
      access_log off;
      proxy_pass https://XXX.com/pub/calendar/feeds/XXXXX/basic.ics;
    }
  */
    var tickList={};
    var tickListStatus=0;
    var tickListTaskIndex=!testStatus?addTaskOnPageChange('getIcs()', 6*3600*1000):0;
    var tickListMaxLine=22;
    function dDay(t){return dHour(t, 24);}
    function dHour(t, h){return parseInt(dMs(t, (!h?1:h)*3600*1000));}
    function dMs(t, ms){return (t-getOffsetTime())/(!ms?1:ms);}
    function dateString(timeStamp, format){
      var s='';
      var all='YMdhms';
      var date=timeStamp?new Date(timeStamp):getOffsetDate();
      if (!format) format='hm';
      var res=[date.getFullYear(), date.getMonth()+1, date.getDate(), date.getHours(), date.getMinutes(), date.getSeconds()];
      for (var i=0;i<all.length;i++)
        if (format.indexOf(all[i])!=-1)
          s+=frontZero([res[i], ['-', '-', ' ', ':', ':', ' '][i]]);
      return s.slice(0,-1);
    }
    function randInt(n, from){if (from==undefined) from=0;return Math.ceil(Math.random()*(n-from))+from;}
    function countIcs(){
      var b=[];
      for (var i in tickList)
        b.push(tickList[i].length);
      return b;
    }
    function testIcs(){
      var s='';
      for (var i=0;i<30;i++)
        s+="BEGIN:VEVENT\nDTSTART:"+(2018+randInt(3))+frontZero(randInt(12, 1))+'01T020304Z\nSUMMARY:Default\nDESCRIPTION:EMPTY\n';
      var d=new Date();
      d.setMinutes(d.getMinutes()+d.getTimezoneOffset()+15+1);
      var now=d.getFullYear()+frontZero([d.getMonth()+1,d.getDate(),'T',d.getHours(),d.getMinutes()])+'08Z';
      s+="BEGIN:VEVENT\nDTSTART:"+now+'\nSUMMARY:Default\nDESCRIPTION:EMPTY\nRRULE:FREQ=WEEKLY;INTERVAL=3';
      readIcs(s);
      tickListStatus++;showIcs(true);
      console.log(now);
    }
    function getIcs(){
      var url = "/ics/";
      var xmlhttp = new XMLHttpRequest();
      xmlhttp.onreadystatechange = function(){
        if (xmlhttp.readyState == 4){
          if(xmlhttp.status == 200){
            readIcs(xmlhttp.responseText);
            showIcs(true);
            xmlhttp = null;
          }
        }
      }
      xmlhttp.open('GET', url);
      xmlhttp.send();
    }
    function readIcs(s){
      s=s.split('\n');
      var r=[];
      var tag=['DTSTART', 'DTSTART;VALUE=DATE', 'SUMMARY', 'DESCRIPTION', 'TRIGGER', 'RRULE'];
      for (var i in s){
        var line=s[i].split(':');
        line=[line[0]?line[0].trim():'', line[1]?line[1].trim():''];
        if (line[0]=='BEGIN'){
          if (line[1]=='VEVENT')
            r.push({});
        } else if (tag.indexOf(line[0])!=-1&&r.length!=0&&r[r.length-1][line[0]]==undefined){
          if (line[0]==tag[0])
            line[1]=Date.parse(line[1].slice(0,4)+'-'+line[1].slice(4,6)+'-'+line[1].slice(6,11)+':'+line[1].slice(11,13)+':'+line[1].slice(13))+(new Date().getTimezoneOffset()+480)*60*1000;
          else if (line[0]==tag[1]){
            line[0]=tag[0]
            line[1]=Date.parse(line[1].slice(0,4)+'-'+line[1].slice(4,6)+'-'+line[1].slice(6,8)+'T08:00:00Z');
          } else if (line[0]==tag[5]){
            r[r.length-1]['FREQ']='';
            line[1]=line[1].split(';');
            for (var j in line[1]){
              line[1][j]=line[1][j].split('=');
              if (line[1][j][0]=='FREQ')
                r[r.length-1]['FREQ']+='年月周日'[['ANNUALLY','MONTHLY','WEEKLY','DAILY'].indexOf(line[1][j][1])];
              else if (line[1][j][0]=='INTERVAL')
                r[r.length-1]['FREQ']='零一二三四五六七八九'[parseInt(line[1][j][1])]+r[r.length-1]['FREQ'];
            }
            continue;
          }
          r[r.length-1][line[0]]=line[1];
        }
      }
      sortIcs(r, 1);
      return tickList;
    }
    function sortIcs(r, sortNum){
      tickList={important:[],normal:[],noDate:[]};
      var func=[[function (d){return d>-14},
                 function (a,b){return b.DTSTART-a.DTSTART}],
                [function (d, freq){return d>=(freq?-7:-14)&&d<=(freq?14:90)},
                 function (a,b){var c=[a.DTSTART,b.DTSTART];for (var i in c) {c[i]-=getOffsetTime();if (c[i]<0) c[i]=-c[i]*2;}
                                return c[0]-c[1];}]][sortNum];
      for (var i in r)
        if (r[i].DTSTART){
          var dD=dDay(r[i].DTSTART);
          if (!dD)
            alarmIcs(r[i]);
          if (func[0](dD, r[i].FREQ))
            tickList.important.push(r[i]);
          else
            tickList.normal.push(r[i]);
        } else
          tickList.noDate.push(r[i]);
      tickList.important.sort(function (a,b){return a.DTSTART-b.DTSTART;});
      tickList.normal.sort(func[1]);
    }
    function showIcs(keep){
      var t=document.getElementById('tickList');
      t.innerHTML='';
      if (!keep) tickListStatus++;
      if (!keep&&tickListStatus%6==1){
        t.innerHTML=tickListStatus;
        getIcs();
      } else if (tickListStatus%3==0){
        t.innerHTML='<img class="tImg" style="padding:1rem">';
      } else {
        var limit=(tickListStatus%3==1)?tickListMaxLine:5;
        var s='<table><tr><td style="opacity:.3">'+dateString(0)+'<span style="opacity:0">100.00</span></td><td style="font-size:1.5rem;opacity:0;line-height:0">1000</td></tr>';
        var cross30;
        for (var j=0;j<Object.keys(tickList).length;j++){
          var l=tickList[Object.keys(tickList)[j]];
          for (var i in l){
            if (--limit<0) break;
            var dD=dDay(l[i].DTSTART);
            if (cross30==undefined)
              cross30=Math.abs(dD);
            else if (Math.abs(dD)>=30&&cross30<30){
              cross30=31;
              s+='<tr style="padding:0"><td>---</td></tr>';
            }
            var adD=Math.abs(dD);
            var sude=(l[i].SUMMARY.length+l[i].DESCRIPTION.length>25)?[l[i].SUMMARY.slice(0,10), (l[i].SUMMARY.slice(10)+' '+l[i].DESCRIPTION).trim()]:[(l[i].SUMMARY+' '+l[i].DESCRIPTION).trim(), ''];
            var freq=(l[i].FREQ)?'<sup style="font-size:x-small;border-radius:20%;border:solid">'+l[i].FREQ+'</sup>':'';
            s+=(!dD?'<b>':'')+'<tr><td>'+dateString(l[i].DTSTART,'Mdhm')+'</td><td class="tl_co" style="color:hsl(0,0%,'+(Math.floor(adD/(!j?90:360)*100))+'%)">'+(adD<7?'<img class="tImg" style="height:1.5rem;margin-left:-2rem"><div class="tl_to" style="height:'+Math.ceil(dD/10*3)/3*1.5+'rem"></div>':'')+(dD?dD:'')+'</td><td class="tl_su"><span class="tl_de"> '+freq+sude[0]+'</span>'+'<span style="background:white;">'+sude[1]+'</span></td></tr>'+(!dD?'</b>':'');
          }
        }
        t.innerHTML=s+'</table>';
      }
    }
    function alarmIcs(tick){
      var dH=dHour(tick.DTSTART);
      var d=dMs(tick.DTSTART);
      tickListAlarm='';
      remindIcs("tickListAlarm='['+'"+dateString(tick.DTSTART)+' '+tick.SUMMARY.slice(0,20)+"'+']'", (dH-12)*3600*1000);
      remindIcs("tickListAlarm=''", (dH+12)*3600*1000);
      if (d>=-3600*1000){
        var freq=(tick.FREQ)?'<sup style="font-size:small;border-radius:20%;border:solid">'+tick.FREQ+'</sup>':'';
        remindIcs("document.getElementById('reminder').innerHTML+=(document.getElementById('reminder').innerHTML!=''?'<br>':'')+'"+('['+freq+dateString(tick.DTSTART, 'Mdhm')+']<br>'+tick.SUMMARY+'<br>'+tick.DESCRIPTION)+"';"
                 +'killShadow(true);'
                 +'displayReminder(true)', d-15*60*1000);
        remindIcs('killShadow(true)', d-1*60*1000);
      }
    }
    function displayReminder(on){
      if (!on) document.getElementById('reminder').innerHTML='';
      document.getElementById("reminder").style.display=on?'block':'none';
    }
    function remindIcs(cmd, timeout){addTaskOnPageChange(cmd, timeout, true);}//-12h,-15m,-1m,+12h
  </script>
  <script type="text/javascript">
  /*
  sudo apt-get install python3-distutils
  sudo apt-get install python3-pip
  sudo pip3 install aiohttp [-i https://source]
  python3 sample.py 92613
  sudo nano /etc/nginx/nginx.conf
  sudo systemctl restart nginx

    location /blive/ {
      proxy_http_version 1.1;
      proxy_set_header Upgrade $http_upgrade;
      proxy_set_header Connection $http_connection;
      access_log off;
      proxy_pass http://localhost:8099;
    }
  */
  var danmuStyle=document.getElementById('danmu_frame').style;
  var dInfoStyle=document.getElementById('danmu_info').style;
  var danmu=document.getElementById('danmu');
  var danmuRefreshRate=0;
  var buffer='';
  var danmuReadCount=0;
  var isDanmuLive=false;
  var danmuStart=0;
  var streamer=[['pi', 'nc', 'dd', 'kf'],
                [92613,1220,16548,22259479]];
  var danmuControl=['history','bye', 'kick', 'info', 'call'];
  var danmuRoomId='';
  var danmuQueSize=0;
  var danmuSuperChat='';
  var danmuPop=0;
  var danmuPopTrends=0;
  var danmuInfoUpdateIndex=0;
  var danmuMax=1600;
  var danmuRetry=0;
  function space(n, olds){
    var s='';
    if (typeof olds=="string"){
      s=olds;
      n-=olds.length;
    }
    while (n-->0)
      s+=' ';
    return s;
  }
  function danmuSwitch(){
    if (danmuRefreshRate>=200)
      danmuOff('+'+danmuReadCount);
    else {
      var up=prompt('Current: '+danmuRoomId+'\nStreamer: '+streamer[0]+'\nControl: '+danmuControl);
      if (up!=null)
        danmuOn(streamer[0].indexOf(up)!=-1?streamer[1][streamer[0].indexOf(up)]:up);
    }
  }
  function danmuOn(roomId){
    isDanmuLive=true;
    danmuStart=new Date().getTime();
    dInfoStyle.background='white';
    danmu.style.background='white';
    danmu.style.padding='.15rem 0';
    danmuStyle.marginTop='7rem';
    danmuStyle.marginLeft='-4rem';
    danmuStyle.height='25rem';
    danmuRefreshRate=1000;
    danmuInfo('  ON');
    danmuRead(roomId);
    setTimeout('danmuRead("info", danmuInfoUpdate)', 3*1000);
    danmuInfoUpdateIndex=setInterval('danmuRead("info", danmuInfoUpdate)', 29*1000);
  }
  function danmuOff(s){
    if (!isDanmuLive)
      return;
    isDanmuLive=false;
    danmuRefreshRate=0;
    clearInterval(danmuInfoUpdateIndex);
    danmuInfoUpdateIndex=0;
    setTimeout('danmuClear()', 10*60*1000);
    dInfoStyle.background='';
    danmu.style.background='';
    danmuStyle.marginTop='14rem';
    danmuStyle.marginLeft='-4rem';
    danmuStyle.height='15rem';
    buffer=buffer.slice(0,danmuMax/5);
    danmu.innerHTML='--BLIVE-OFF--'+(s!=undefined?s+'-':'')+timeFormat(new Date().getTime()-danmuStart,2)+'-<br>'+buffer+'...';
    danmuInfo('◯ OFF');
    danmuPop=0;
  }
  function danmuShow(s){
    if (s){
      s=s.split('<br>').filter(function (s){return s&&s.trim();}).join("<br>");
      if (s.indexOf('[RECV]')==-1&&s.indexOf('[SLEEP]')!=-1)
        danmuOff(s.trim().slice(0,danmuMax/5))
      else if (s){
        buffer=s+(buffer?'<br>':'')+buffer;
        if (buffer.length>danmuMax*1.5)
          buffer=buffer.slice(0, danmuMax);
        danmu.innerHTML=buffer;
        danmuInfo('▁▂▃▄▅▆▇█'[++danmuReadCount%8]+' ON');
      }
    }
  }
  function danmuSC(l){
    danmuSuperChat='';
    var d=getOffsetTime(0, true);
    for (var i in l){
        l[i][0]=Math.floor((l[i][0]-d)/(60*1000));
        if (l[i][0]>=0)
          danmuSuperChat+='<b>￥'+l[i][1]+'</b><small>[+'+l[i][0]+'分]</small> '+l[i][2]+'<br>';
      }
  }
  function danmuInfoUpdate(s, manually){
    if (!manually&&danmuInfoUpdateIndex==0)
      return;
    var info=JSON.parse(s);
    danmuRoomId=info['room_id'];
    danmuQueSize=parseInt(info['que_size']);
    danmuSC(info['super_chat']);
    var p=parseInt(info['pop']);
    if (danmuPop==0&&p>1)
      reduceShadow();
    if (!(danmuPop==0&&p==1)){
      danmuPopTrends=p<danmuPop?-1:(p==danmuPop?0:1);
      danmuPop=p;
    }
    danmuInfo('▁▂▃▄▅▆▇█'[danmuReadCount%8]+' ON');
    if (danmuPop==1)
      setTimeout('if (danmuPop==1) danmuOff("TIMEOUT")', 10*60*1000);
  }
  function danmuInfo(status){
    document.getElementById('danmu_info').innerHTML=space(19, '人气'+(danmuPop<1e4?danmuPop:Math.floor(danmuPop/1e3)/10+'万')+'↓→↑'[danmuPopTrends+1])+space(26, '房间'+(streamer[1].indexOf(danmuRoomId)!=-1?streamer[0][streamer[1].indexOf(danmuRoomId)]+' ':'')+danmuRoomId)+status+'<br>'+danmuSuperChat;
  }
  function danmuRead(roomId, f){
    if (danmuRefreshRate<200)
      return
    var url = "/blive/"
    if (roomId)
      url+='?'+roomId;
    var xmlhttp = new XMLHttpRequest();
    xmlhttp.onreadystatechange = function(){
      if (xmlhttp.readyState == 4){
        if(xmlhttp.status == 200){
          if (f==undefined)
            danmuShow(xmlhttp.responseText);
          else
            f(xmlhttp.responseText);
          xmlhttp = null;
        } else if (xmlhttp.status>=400&&xmlhttp.status<600)
          if (danmuPop<=1||++danmuRetry>=3){
            danmuOff('(〃>_<;〃)'+xmlhttp.status);
            danmuRetry=0;
          }
      }
    }
    xmlhttp.open('GET', url);
    xmlhttp.send();
    if (f==undefined)
      setTimeout('danmuRead()', (danmuPop>1||danmuQueSize>5)?danmuRefreshRate:danmuPop==0?10*1000:60*1000);
  }
  function danmuClear(){
    if (isDanmuLive) return;
    danmu.innerHTML='';
    document.getElementById('danmu_info').innerHTML='';
  }
  </script>
</body>
</html>