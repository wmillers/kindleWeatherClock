<!DOCTYPE html>
<html lang="zh-CN">
<head>
  <meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
  <meta name="viewport" content="width=device-width,initial-scale=1.0,maximum-scale=1.0, user-scalable=0">
  <meta name="referrer" content="no-referrer">
  <script>
"use strict";
/***************Basic settings***************
Note: Most you need to configure are in the Basic
    settings. If you want to use extra modules, please
    follow the instructions in README.md, and add
    the `location xxx {}` things in this file to
    your nginx config.
*/
var forTestUse=false;//If you are not sure, please change it to false
var info={
    version: '1.6',
    description: '(changes are in commit logs)',
    author: 'wmillers@github',
    support: ['time', 'weather',//those two are default modules
        //'TO-DISABLE-EXTRA-MODULES//COMMENT-THE-LINE',
        'tomato',
        'ticklist',
        'danmu',
        'home',
        'lunaryear',
    ],
    license: 'LGPL2.1'
}
var isOnKindle=!/windows|chrome/i.test(navigator.userAgent);//most affect autostart
var autostart=isOnKindle?[//COMMENT unwanted auto-start modules
    'ticklist',
    //'danmu',
    'home',
    ]:[];
var isDanmuFullWindow=true;   // danmu start in fullwindow mode (not fullscreen)
var liveOption={
    enable: true,     // play live on roomId changed, only in fullscreen (not fullwindow) mode #danmuonly
    quality: 3,       // final quality depends on the server (fallback to the better one): 2 80, 3 150, 4 10000 (best), 5 extends for huya
    occupy: true,     // kick other clients, in danmuOnly
    blockList: true,  // apply block list to danmu live tuber
    lowPower: true,   // if 4 (10000) is the only option, make audio only
};
var hueBaseUrl = '/hue/';     // '//philips-hue/api/' if no need CORS Access-Control-Allow-Origin *
var hueToken = "UDp1xs0RpZiOho4oX7PY-L7fpAOe8pYnOMTK1tfo";// replace with your token, to get: push bridge button and run hReg()
//*******************END**********************

if (!isOnKindle) console.warn('[autostart:disabled] notKindle');
window.onerror=function handler(msg, source, line, col, e){comment((line?'['+line+']':'')+(e?e.stack:msg))};
setTimeout(function isLoaded(){
    if (typeof loaded=="undefined"){
        document.getElementsByClassName('cleaner')[0].innerHTML='<center><a href="">js FAILED</a></center>';
        confirm('JS failed, need reload?')?f5():console.error(comment('[js:failed] reloadRejected'));
    }
}, 4000);
if (forTestUse)
    setInterval('comment(how(), true)', 7*1000);
if (typeof eval!='function')
    comment('eval not support');
function hasModule(name){
    return info.support.indexOf(name)!=-1;
}
  </script>
  <title>&nbsp;</title><!--tomatoClock-->
  <link id="ico" href="" rel="icon" type="image/x-icon" />
  <style>
    html {
        height: 100%;
        overflow: hidden;
        overflow-x: hidden;
        overflow-y: hidden;
    }
    table {
      border-spacing: 0;
    }
    .cleaner {
      background: black;
      color: white;
      position: fixed;
      width: 100%;
      height: 100%;
      display: block;
      z-index: 20;
      top: 0;
      left: 0;
    }
    .app {
      margin-top: 3rem;
      padding-top: 2rem;
      margin-left: -1.5rem;
      height: 46rem;
      width: 44rem;
      font-family: Arial,sans-serif;
      text-align: center;
      overflow: hidden;
    }
    .rotate {
      transform:rotate(270deg);
      -webkit-transform:rotate(270deg);
    }
    .home {
      position: absolute;
      left: 24rem;
      width: 20rem;
      z-index: 3;
      font-size: 3rem;
      font-weight: bold;
    }
    .home.more {
        font-size: 2.5rem;
        left: 20rem;
        width: 24rem;
    }
    .h_switch {
      height: 20rem;
      width: 4rem;
      border: black 5px solid;
      display: table-cell;
      vertical-align: middle;
      background: rgba(0, 0, 0, 0.2);
      color: white;
    }
    .tickList {
      position: absolute;
      font-size: .5rem;
      left: -3rem;
      text-align: left;
      z-index: 2;
      white-space: pre-wrap;
      overflow: hidden;
      text-shadow: 2px 2px 0 white, -2px -2px 0 white, -2px 2px 0 white, 2px -2px 0 white;
    }
    .tickList .tomato {
      display:inline;
      margin-left:-1.6rem;
      position:absolute;
      background: white;
      width: 1.5rem;
    }
    .tickList .countdown {
      text-align:right;
      font-size:1.5rem;
    }
    .tickList .content {
      display: block;
      padding: 0;
      word-break: break-all;
    }
    .tickList .summary {
      font-size: 1.5rem;
      padding: .16rem 0;
      float: left;
    }
    .danmu_fr {
      position: absolute;
      font-size: 1rem;
      margin-top: 14rem;
      margin-left: -3.4rem;
      text-align: left;
      height: 15rem;
      width: 18rem;
      overflow: hidden;
      z-index: 4;
      word-break: break-all;
      white-space: pre-wrap;
    }
    .danmu_fr.fullscreen {
        margin-top: 0;
        position: fixed;
        top: 0;
        margin-left: 0;
        width: 100%;
        height: 100%;
        font-size: 4.7vh;
        background: black;
        color: rgba(255, 255, 255, .4);
        left: 0;
        -webkit-transform: translateZ(0);
        transform: translateZ(0);
    }
    .danmu_fr.less {
        margin-top: 14rem;
        height: 15rem;
    }
    .danmu_fr.more {   
        background: white;
        margin-top: 9rem;
        height: 23rem;
    }
    .danmu_fr.fullwindow {
        background: rgba(255, 255, 255, .8);
        margin-top: -6rem;
        height: 41.6rem;
        font-size: 5.5rem;
        width: 47.5rem;
    }
    .danmu_fr a {
        text-decoration: none;
        display: inline-block;
        color: inherit;
    }
    .danmu_fr.fullscreen a {
        background: rgba(0, 0, 0, .3);
        color: rgba(255, 255, 255, .25);
    }
    .danmu_fr a:hover {
        color: rgba(255, 255, 255, .6);
        cursor: pointer;
    }
    .danmu_info {
      display: block;
      font-size: .6rem;
    }
    .fullscreen .danmu_info>.base {
        color: rgba(255, 255, 255, .25);
        display: flex;/* not support in Kindle */
    }
    .fullscreen .danmu_info>.base>* {
        flex-shrink: 0;
        padding-right: .2em;
        white-space: nowrap;
        -webkit-align-self: center;
        align-self: center;
        overflow: hidden;
    }
    .fullscreen .danmu_info>.base>.title {
        flex-grow: 1;
        flex-shrink: 1;
        text-align: right;
        max-width: none;/* to override */
    }
    .fullscreen .danmu_info>.base>.shrink {
        flex-shrink: 1;
    }
    .fullscreen .danmu_info {
        font-size: .75em;
        overflow: hidden;
        height: 10vh;/* constant height avoid render delay */
    }
    .danmu_info .right {
        max-width: 6em;
        white-space: nowrap;
        overflow: hidden;
        vertical-align: text-top;
        float: right;
    }
    .fullwindow .danmu_info {
        font-size: 1.6rem;
        font-weight: bold;
    }
    .fullwindow .danmu_info .title {
        max-width: 16em;
    }
    .fullscreen .danmu_info .room {
        max-width:  10em;
        white-space: nowrap;
        overflow: hidden;
        vertical-align: text-top;
    }
    .fullscreen .danmu_info>.extra {
        position: absolute;
        max-height: 30vh;
        line-height: 1em;
        background: rgba(0, 0, 0, .3);
    }
    .fullscreen .danmu {
        /* z-index: 1.danmu 2.dark.danmu_live.info 3.danmu_live 4.danmu_live.info 5.danmu_live.cover */
        position: absolute;/* better performance */
        bottom: 0;
        z-index: -1;
        cursor: none;
        height: 90vh;
        overflow: hidden;
    }
    .better_view {
        scroll-behavior: smooth;
        -webkit-mask-image: linear-gradient(90deg, #fff, #fff 35%, rgba(0, 0, 0, .5) 70%);
        mask-image: linear-gradient(90deg, #fff, #fff 35%, rgba(0, 0, 0, .5) 70%);
    }
    .fullscreen .danmu>* {
        background: rgba(0, 0, 0, .15);
        background-size: 120%;
    }
    .rotate>.danmu {
        width: 70vw;
        writing-mode: vertical-rl;
        text-orientation: sideways;
    }
    .dark>.danmu {
        color: rgba(255, 255, 255, .25);
    }
    .danmu_live {
        height: 90vh;
        width: 70vw;
        object-fit: contain;
        object-position: right bottom;
        font-family: sans-serif;
        color: #666;
        position: absolute;
        top: 5vh;
        right: 0;
        opacity: 0;
        z-index: -3;
    }
    .rotate>.danmu_live {
        transform: rotate(90deg);
        width: 110vh;
        height: 50vw;
        top: 5vh;
        right: -21vw;
    }
    .danmu_live.info {
        top: 0px;
        z-index: -4;
        opacity: .4;
        font-size: .5em;
        max-height: 50vh;
        overflow: hidden;
        text-overflow: ellipsis;
    }
    .dark>.danmu_live.info {
        height: 100vh;
        width: 100vw;
        opacity: 1;
        background: rgba(0, 0, 0, .6);
        padding-bottom: 50vh;
        z-index: -2;
        font-size: 0;
        cursor: none;
    }
    .danmu_live.cover {
        top: 6vh;
        z-index: -5;
        opacity: .3;
        max-height: 50vh;
        display: block;
    }
    .danmu_live.cover[src=""] {
        display: none;
    }
    .time {
      font-size: 16rem;
      font-variant-numeric: tabular-nums;
      font-weight: bold;
    }
    .tomato {
      font-size: 2rem;
      font-weight: bold;
    }
    .date {
      font-size: 2rem;
      font-weight: bold;
    }
    .weath {
      margin-top: 1rem;
      margin-left: -2rem;
      width: 22.5rem;
      height: 2.8rem;
      display: block;
      -webkit-transform: scale(2.6);
      transform: scale(2.6);
      -webkit-transform-origin: 0 0;
      transform-origin: 0 0;
    }
    .basket{
      margin-top: 6rem;
      font-size: 1rem;
      overflow: hidden;
      word-break: break-all;
      height: 2rem;
    }
    .tImg{
      content: url('data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAOUAAADUAgMAAAAegQyNAAAACVBMVEUAAAD///8AAABzxoNxAAAAAXRSTlMAQObYZgAABZ9JREFUaN7VmsuRnDAQQJnDhEA++OA7rlJzIATywRngKojS1jCtZ02PrEbrT1mH3UWrR//0o6WuXG4iMnRNpf+BhjZUYmki7yKtGvcPdGzUt9HYm5ylzVSMvWzqdKwYe83U5dgx9hp6HAfGXvLS/ANdG4y9R32PY2swtn/oG40dW0yNpcFPMTTHaWyTl6KxLeii6HCt636Opp5+0uLuuooe+lgX3mvLKUcdQZJXdNWK4Byl6uDoJy1uUxeDDnVTQb9lLh6voKsbpf+tZ2wivz/NrqLqnnWKAh8PWlNF1T2x/fagvqq7fKi21uD60IOyfgSVVlQ+hC5t6P7P0BmfNaLbvIkL3aY03GaGuwtdHwToJn40rTcyMexk8KFTQpmdOh+qvybmxOBF54RuTBIVdEnMKl9EmIgHD3rOTbtElNK5UC2fxMUyN+0FNFTn0hQMisNR9wLj8JRUSvAL9YvN1uSfidQvQlEo6ypdN/S6cPxCrEDCsl7+QuxN0BYWdC+L7bVVzlK5FWPLLoCSUN5UchIQMxvoXtC4fxGKklixvtcYoVlRFLHWv5lQuwQgdjCmGqG0nnnRO43pDW/EZi8Kb/TFG7ZT/ey2sr57CiatebQa98mivbDTW0oa8z8lzwpQ4cmYetDQdntCl8KDqVNqR3lnwYqxualrhk6K8mS+t3IJaD2rCYjVj0tMnbIYonJEQ4fY14/Lu+qbNsKIjajuk/nyAY0AW4CIDr2KXSN6srMxNtYnfY8nejZmwcBtmbFUypJQ2DHNIsursTdUmQ7QDpRpJH1JgzI0QW8sF8+n6dVPdzQ5QFmE8Igs+iVN3fNtMygLQnidg6jiC4VRGdGnWESINjQoc8OerMFU5oMoI/fSzminvZ2FMj/dtIIBalAGWKbUPamhhtq5i76Oi3EwOQG8WsgbgKqXFoSOlqMpLk67XoSWFv67osIOjQ84OlARja/HwezaazsV7cWKYupaIlWMdhl9EyjkL9CDMYyXNgx1oRNeWisb0GTWSKw29mSdBw0nOquDWbUr6Hai8kQX1jEHKqCPunq2ss9RwsoKWEbnZ2BTj9j1p3ROdHigOs5ZE2roYVAm52vo7Eka3hM6amdaH6hIcKJrhgqmXkH5XPyjKFmK6DPQzo2GB8oGJ7SjYzs6XEQXtlWdF91f0dGPRjECGrq/jU4xtC1onJk2D9qzo06pk/iiNnT6EHr8cXT5v1ABNcH5m2is2RpR+rAzMQrqHDk3i64fRcd2dGhEnSN9eouGdnRsR7vr6EKO3DHSfyO6OQ8t5WMo83B/DV0a0ZtBGea+fgg6u9G7gIYG1G4IBldYJ4MeDShbrtEd1nbUbi9Hb1gtGq6ibKWDNzYWFfe9AruBH/yxAV2cfcLkPBQdffcKcnSuBZYEEShxdkSnB41e5SO07uIs1xvwWzU6JBvR8a7oUDV1NqjU74+QBzYZgupHGXlgUFIaUr8DlIeVRAoo1g32XACU9A3taC0IxVTCQerKqBjreM2RoQTW+olPH5KtxEbfXsiPJ7G9YCpSSMuZJLeKJbFMbF7vIwUrVCScf6EvbiEFicYINScIBAMXc3yBdWueyAc16Vaq7s/WRuizoUnyktDU1psVioPxUzQ2kAHXkPF35iVQ1fgz5GyOZEBNGh0MQZC5g23y/kUoaWPjJXtkgFBb8BIoKTMTDAqmgjJjGXVNIZ9lDmWqJPksexS0HHvZTiYxsyasyHOZirEI9JjKJOsqNtVINOr6SuFg0aFvsMeZXn3HwiGqQ9/Be3RLYSYxxnrECqZmxs4OJ2FqPnl6hIr3SN4KDa6LAFao1ZfFrOpecV56sDGV4LtqYdWlP1ixpRtk5YMeHAUr7x7HX11m4cySRyat9is0Y9vFncpJT9u9HZxsiytn3aYuLFJ6LwlLUz+Jr0YeCx76DsxC7gxsfZb3AAAAAElFTkSuQmCC');
      height: 2rem;
      width: auto;
    }
    .inform {
      margin-top: 0.5rem;
      font-size: 1.5rem;
      font-weight: normal;
    }
    .reminder {
      display: none;
      margin: -25rem 10rem;
      padding: 1rem;
      max-height: 21rem;
      width: 22rem;
      position: absolute;
      border: dotted;
      background-color: rgba(255, 255, 255, .8);
      font-size: 1.5rem;
      font-weight: bold;
      overflow: scroll;
      z-index: 3;
    }
    .loader {
        display: inline-block;
        vertical-align: text-top;
        margin: 0 .5rem;
    }
    .bar {
        background-color: black;
        height: 10%;
        width: .4rem;
        float: left;
        margin-left: .1rem;
    }
    .gua {
        background-color: black;
        height: .2rem;
        width: .6rem;
        margin-top: .15rem;
        float: left;
    }
  </style>
</head>
<body onselectstart="stopBubble()">
  <div class="cleaner"><noscript><center>Javascript NOT support.</center></noscript></div>
  <div class="app"><div class="rotate">
    <div class="tickList" onclick="showIcs()"><div></div><img class="tImg" style="padding:1rem"><table></table></div>
    <div class="home" onclick="hUpdate()"><div style="padding-top: 3rem">HOME</div></div>
    <div style="height:6rem"></div>
    <div class="danmu_fr" onclick="danmuSwitch()"><div class="danmu_info" onclick="stopBubble()"></div><div class="danmu"></div><video class="danmu_live">video live Only in #danmuOnly mode</video><img class="danmu_live cover" src=""></img><div class="danmu_live info"></div></div>
    <div class="time"><span id="hour" onclick="switchTomato()">00:</span><span id="minute" onclick="pauseTomato()">00</span></div>
    <div class="tomato"><span class="old_date"></span><span class="loader"></span><span id="tom" onclick="runTime()">TOMA</span><span id="ato" onclick="initDateFromServer(true)">MATO</span></div>
    <div class="date" onclick="correctPrompt()">0月0日(零) 正月初一</div>
    <iframe class="weath" scrolling="no" frameborder="0" allowtransparency="true" src="" sandbox="allow-scripts" style="pointer-events: none;"></iframe>
    <div class="basket"></div>
    <div class="inform" onclick="fridgeTomato();weatherInterval();">同步时间：<span id="sync">0000-00-00 00:00:00</span> <span id="timeoffset">+0s</span> <span id="net">未同步</span></div>
    <div class="reminder" onclick="clearReminder()"></div>
  </div></div>
  <script src="mpegts.js"></script>
  <script>
"use strict";
if (!String.prototype.startsWith) {
    Object.defineProperty(String.prototype, 'startsWith', {
        value: function(search, rawPos) {
            var pos = rawPos > 0 ? rawPos|0 : 0;
            return this.substring(pos, pos + search.length) === search;
        }
    });
}
var initialTitle = document.title;
var clearCommentTime = 0;
var basket = document.getElementsByClassName('basket')[0];
function comment(s, isJam){
    var lag = 30 * 60 * 1000;
    s = s == undefined ? 'und' : String(s);
    setTimeout(clearComment, lag + 1000);
    if (basket.innerHTML.length == 0 || isJam)
        basket.innerHTML = s;
    else
        basket.innerHTML = (basket.innerHTML + '|' + s).slice(-150);
    clearCommentTime = new Date().getTime() + lag;
    return s;
}
function clearComment(){
    if (new Date().getTime() < clearCommentTime) return;
    basket.innerHTML = '';
}
function stopBubble(){
    try {
        event.stopPropagation();
        event.preventDefault();
    } catch (e){}
    return false;
}
function httpReq(path, f, fOnfailed, post, method, fOnBoth){
    var xmlhttp = new XMLHttpRequest();
    xmlhttp.onreadystatechange = function handle(){
        if (xmlhttp.readyState == 4){
            var s=parseInt(xmlhttp.status);
            if (s>=100&&s<400){
                try {
                    (typeof f=="function"?f:console.log)(xmlhttp.responseText, path);
                } catch (e) {
                    comment(e.stack);
                }
            } else {
                var e=s>=500?'GatewayError':s>=400?'ServerForbidden':'CertConfirm';
                (typeof fOnfailed=="function"?fOnfailed:comment)(s+':'+e+"(F12)", path);
            }
            if (fOnBoth)
                fOnBoth();
        }
    }
    xmlhttp.open(method ? method : post ? 'POST' : 'GET', path);
    if (post)
        xmlhttp.setRequestHeader("Content-Type", "application/json");
    xmlhttp.send(post);
    return xmlhttp;
}
function JsonParse(s, quiet){
    var res=s;
    try {
        res=JSON.parse(s);
    } catch (e){
        if (!quiet)
            console.log('[JSON@'+dateString()+':Invalid] <'+s+'>');
    }
    return res;
}

setTimeout(function modulesControl(){
    var funcList = [['tomato', 'ticklist', 'danmu', 'home', 'lunaryear'],
    ['switchTomato', 'showIcs', 'danmuSwitch', 'hSwitch', 'getLunarDay']];
    for (var i in funcList[0])
        if (!hasModule(funcList[0][i]))
            eval(funcList[1][i] + '=' + 'function disabled(){comment("' + funcList[0][i] + ' is DISABLED");return "";}');
    if (!hasModule('home'))
        home.innerHTML = '';
});
var hash=location.hash;
var isDanmuOnly = hash != (hash = hash.replace(/#danmuonly/i, ''));
var isFastLoad = hash != (hash = hash.replace(/#fastload/i, ''))||isDanmuOnly;
if (isDanmuOnly){
    reduceShadow=function und(){};
    killShadow=reduceShadow;
    setTimeout(danmuOnly, 200);
} else {
    setTimeout(function autoStart(){
        if (!forTestUse)
            for (var i = 0; i < autostart.length; i++)
                [showIcs, danmuSwitch, hUpdate][['ticklist', 'danmu', 'home'].indexOf(autostart[i])]();
    });
}
setTimeout(function loadFromHash(){
    //resume task from #a()#b()
    var run = hash.split('#');
    for (var i = 0; i < run.length; i++)
        setTimeout(decodeURI(run[i]));
});
setTimeout(function isVisible(){
    function notVisible(){
        document.title="页面被遮挡";
        comment('页面被遮挡');
    }
    if (document.hidden || document.mozHidden || document.msHidden || document.webkitHidden)
        notVisible();
}, 10000);
/*        Danmu FullScreen (#danmuonly)
Note: this part needs css3 support.

# To skip password and get short link in Nginx reverse proxy 
location /kindle/ {
    access_log off;
    proxy_redirect      off;
    proxy_buffering     off;
    proxy_http_version  1.1;
    proxy_set_header Authorization "Basic c2hhcmU6c2hhcmUwMjRwYXNz";
    proxy_pass "http://NEEDTOCHANGE/PATH/TO/FOLDER/kindle/";
}
*/
var danmu_fr=document.getElementsByClassName('danmu_fr')[0];
var danmu_info=document.getElementsByClassName('danmu_info')[0];
var danmu=document.getElementsByClassName('danmu')[0];
var danmu_live = document.getElementsByClassName('danmu_live')[0];
var danmu_live_info=document.getElementsByClassName('danmu_live info')[0];
var danmu_live_cover=document.getElementsByClassName('danmu_live cover')[0];
var danmuScrollCurrentNum;
var danmuScrollNum;
var danmuScrollTime;
function danmuOnly(){
    danmuLimit.max=80;
    isDanmuOnly=true;
    comment=liveInfo;
    document.body.appendChild(danmu_fr);
    document.getElementsByClassName('app')[0].style.display='none';
    isDanmuFullWindow=true;
    danmu_fr.classList.add('fullscreen');
    document.getElementsByClassName('cleaner')[0].style.display='none';
    danmu.innerHTML='<div style="margin:10vw">Due to browser\'s requirement,<br>fullSceen & video need a user-gesture to activate.<br><u><b>CLICK</b></u> to start.</div>';
    danmuAlter=function danmuAlterScreenOnly(beLess){
        if (!beLess){
            if (dInfo.flag.on == 1){
                danmuContent();
                danmuFirstStatus();
            }
            danmuDark();
        }
    };
    if (!mpegts.isSupported())
        liveFromRoom=function (){
            console.log('mpegtsJsNotSupported:'+dInfo.roomId);
        };
    danmu_live.onended=function end(){
        setTimeout(function act(){
            if (danmu_live.ended)
                liveOff();
        }, 20e3);
    };
    danmu_fr.oncontextmenu=function notOccupied(){
        if (liveOption.occupy){
            liveOption.occupy=false;
            danmuSwitch();
            return stopBubble();
        }
    };
    danmu_fr.onwheel=function changeVolume(e){
        var d=-e.deltaY/100;//~100
        d=(d>=0?Math.ceil:Math.floor)(d);
        if (typeof danmuScrollNum=='string')
            danmuScrollCurrentNum=((danmuScrollCurrentNum==undefined?0:danmuScrollCurrentNum)+d+10)%10;
        else
            liveChangeVolume(d/10);
        setTimeout(danmuStatus);
        return stopBubble();
    }
    document.onkeydown=function fs(event){
        var e = event || window.event || arguments.callee.caller.arguments[0];
        if(e && e.keyCode==13){ // enter
            danmuFullScreen(true);
        } else if(e && e.keyCode==38 && e.keyCode==87){ // up, w
            liveChangeVolume(.2);
        } else if(e && e.keyCode==40 && e.keyCode==83){ // down, s
            liveChangeVolume(-.2);
        }
    };
}


//Lunar Year
var tgString = "甲乙丙丁戊己庚辛壬癸";
var dzString = "子丑寅卯辰巳午未申酉戌亥";
var numString = "一二三四五六七八九十";
var monString = "正二三四五六七八九十冬腊";
var sx = "鼠牛虎兔龙蛇马羊猴鸡狗猪";
var cYear, cMonth, cDay, cLastRecord;
var CalendarData = [0xA4B, 0x5164B, 0x6A5, 0x6D4, 0x415B5, 0x2B6, 0x957, 0x2092F, 0x497, 0x60C96, 0xD4A, 0xEA5, 0x50DA9, 0x5AD, 0x2B6, 0x3126E, 0x92E, 0x7192D, 0xC95, 0xD4A, 0x61B4A, 0xB55, 0x56A, 0x4155B, 0x25D, 0x92D, 0x2192B, 0xA95, 0x71695, 0x6CA, 0xB55, 0x50AB5, 0x4DA, 0xA5B, 0x30A57, 0x52B, 0x8152A, 0xE95, 0x6AA, 0x615AA, 0xAB5, 0x4B6, 0x414AE, 0xA57, 0x526, 0x31D26, 0xD95, 0x70B55, 0x56A, 0x96D, 0x5095D, 0x4AD, 0xA4D, 0x41A4D, 0xD25, 0x81AA5, 0xB54, 0xB6A, 0x612DA, 0x95B, 0x49B, 0x41497, 0xA4B, 0xA164B, 0x6A5, 0x6D4, 0x615B4, 0xAB6, 0x957, 0x5092F, 0x497, 0x64B, 0x30D4A, 0xEA5, 0x80D65, 0x5AC, 0xAB6, 0x5126D, 0x92E, 0xC96, 0x41A95, 0xD4A, 0xDA5, 0x20B55, 0x56A, 0x7155B, 0x25D, 0x92D, 0x5192B, 0xA95, 0xB4A, 0x416AA, 0xAD5, 0x90AB5, 0x4BA, 0xA5B, 0x60A57, 0x52B, 0xA93, 0x40E95];
var madd = [0, 31, 59, 90, 120, 151, 181, 212, 243, 273, 304, 334];
function GetBit(m, n){
    return (m >> n) & 1;
}
function setLunarDay(TheDate){
    if (!TheDate) TheDate = getOffsetDate();
    var total, m, n, k;
    var isEnd = false;
    var tmp = TheDate.getYear();
    cLastRecord = TheDate.getDate();
    if (tmp < 1900){
        tmp += 1900;
    }
    total = (tmp - 1921) * 365 + Math.floor((tmp - 1921) / 4) + madd[TheDate.getMonth()] + TheDate.getDate() - 38;

    if (TheDate.getYear() % 4 == 0 && TheDate.getMonth() > 1){
        total++;
    }
    for (m = 0; ; m++){
        k = (CalendarData[m] < 0xfff) ? 11 : 12;
        for (n = k; n >= 0; n--){
            if (total <= 29 + GetBit(CalendarData[m], n)){
                isEnd = true; break;
            }
            total = total - 29 - GetBit(CalendarData[m], n);
        }
        if (isEnd) break;
    }
    cYear = 1921 + m;
    cMonth = k - n + 1;
    cDay = total;
    if (k == 12){
        if (cMonth == Math.floor(CalendarData[m] / 0x10000) + 1){
            cMonth = 1 - cMonth;
        }
        if (cMonth > Math.floor(CalendarData[m] / 0x10000) + 1){
            cMonth--;
        }
    }
}
function getLunarDay(year, spirit, month, day, TheDate){
    if (getOffsetDate().getDate() != cLastRecord)
        setLunarDay(TheDate);
    var tmp = "";
    var all = !(year || spirit || month || day);
    if (all || year)
        tmp += tgString.charAt((cYear - 4) % 10) + dzString.charAt((cYear - 4) % 12);
    if (all || spirit)
        tmp += sx.charAt((cYear - 4) % 12) + "年";
    if (all || month){
        if (cMonth < 1){
            tmp += "闰";
            tmp += monString.charAt(-cMonth - 1);
        } else {
            tmp += monString.charAt(cMonth - 1);
        }
        tmp += "月";
    }
    if (all || day){
        tmp += (cDay < 11) ? "初" : ((cDay < 20) ? "十" : ((cDay < 30) ? "廿" : "三十"));
        if (cDay % 10 != 0 || cDay == 10){
            tmp += numString.charAt((cDay - 1) % 10);
        }
    }
    return tmp;
}


/*                Time Display & Weather                */
var refreshRate = 8 * 3600 * 1000;
var hardwareLagRate = 6.66;//+1s/6.66h
var lastSyncTime = 0;
var timeOffset = 0;
var preventDecreaseShadow = false;//Stop when tomato
var lessDisturbUpdateWhenTomato = false;//less time update flash when tomato
var initTime = new Date().getTime();
var initTimeOffset = 0;
var averageTimeOffset = [0, 0];
var hasClockInit = false;
var networkFaliure = false;
var nextCmdList = 0;
var cmdListCount = 0;
var cmdList = {};
var tickListAlarm = '';
var timeAnimationInterval;
if (!isFastLoad){
    initDateFromServer();
    adjustAgainstHardwareTimeLag();//extra offset cycle
    initClockWeather();
}
initBrowserPage();

function adjustAgainstHardwareTimeLag(){
    if (hasClockInit) timeOffset += 1000;
    addTaskOnPageChange("adjustAgainstHardwareTimeLag()", hardwareLagRate * 3600 * 1000, true);//add 1s offset every xxx hour
}
function initDateFromServer(force){
    //timeDateByBlive ?time returns timestamp
    httpReq('/blive/?time', function s(a){averageTimeOffset=[parseInt(a) - new Date().getTime(),1]; sumDateFromServer(true)});
    //Alternative: compare time from HEAD 20 times due to its 1s precision
    setTimeout('if (!timeOffset||'+force+') sumDateFromServer()', 500);
}
function sumDateFromServer(calculate){
    if (calculate){
        if (!averageTimeOffset[0])
            return false;
        var oldHardwareLagRate = hardwareLagRate;
        var dOffsetPerSecond = "";
        var dTimeOffset = 0;
        var uptime = new Date().getTime() - initTime;
        timeOffset = Math.floor(averageTimeOffset[0] / averageTimeOffset[1]);
        if (!initTimeOffset && timeOffset) initTimeOffset = timeOffset;
        if (Math.abs(timeOffset - initTimeOffset) > 200){
            dTimeOffset = timeOffset - initTimeOffset;
            if (uptime > 3600 * 1000){
                var newHardwareLagRate = ((uptime / 1000 / 3600) / (dTimeOffset / 1000)).toFixed(2);
                dOffsetPerSecond = "1s/" + newHardwareLagRate + "h" + "(" + oldHardwareLagRate + ")";
                if (uptime > 3 * 24 * 3600 * 1000) hardwareLagRate = newHardwareLagRate;
            }
        }
        dTimeOffset = dTimeOffset ? "(" + timeFormat(dTimeOffset) + ")" : "";
        console.log(comment(timeOffsetFormat(2) + dTimeOffset + "#" + dOffsetPerSecond + "#" + timeFormat(uptime, 3, true) + ""));
        document.getElementById('timeoffset').innerHTML = timeOffsetFormat();
        initClockWeather();//immediately after date time got from server
        return true;
    } else {
        averageTimeOffset = [0, 0];
        for (var i=0;i<=20;i++)
            setTimeout('singleDateFromServer(' + i + ')', 50*i);
    }
}
function singleDateFromServer(n){
    var xmlhttp = new XMLHttpRequest();
    xmlhttp.open("HEAD", noCache(), true);
    xmlhttp.onreadystatechange = function (){
        if (xmlhttp.readyState == 4){
            if (networkFaliure){
                networkFaliure = false;
                return;
            }
            if (n >= 20){
                sumDateFromServer(true);
                return;
            }
            if (xmlhttp.status != 0){
                var serverTime = new Date(xmlhttp.getResponseHeader("Date")).getTime();
                var clientTime = new Date().getTime();
                averageTimeOffset[0]+=serverTime - clientTime + 2300;
                averageTimeOffset[1]++;
                timeOffset = Math.floor(averageTimeOffset[0] / averageTimeOffset[1]);//preset lag==>+1s(screen refresh time)
                console.log(frontZero(n + 1) + "#" + Math.floor(serverTime / 1e5) + ":S" + serverTime % 1e5 / 1000 + ".:C" + clientTime % 1e5 / 1000 + ":" + timeOffsetFormat());
                //comment("Calculating..." + timeOffsetFormat(3), true);
            } else {
                networkFaliure = true;
                comment("Failed(ServerTime)#1s/" + hardwareLagRate + "h(" + timeOffsetFormat(3) + ")");
            }
        }
    }
    xmlhttp.send(null);
}
function addTaskOnPageChange(cmd, interval, isTimeout){
    var t = getOffsetTime(interval);
    var tag = String(cmd);
    if (isTimeout) interval = true;
    if (cmdList[tag] != undefined)
        cmdList[tag] = [cmdList[tag][0], interval, t];
    else {
        tag = tag.slice(0, 4) + frontZero(++cmdListCount, 3);
        cmdList[tag] = [cmd, interval, t];
    }
    refreshTaskOnPageChange();
    return tag;
}
function runTaskOnPageChange(){
    //nextCmdList=1500, cmdList={tag0:['f()', interval, end], tag1:['f()', 86400*1000, 15000000], tag2:['',true,1500]};
    try {
        var t = getOffsetTime();
        if (nextCmdList - 59 * 1000 < t){
            nextCmdList = 0;
            for (var i in cmdList){
                if (cmdList[i][2] - 59 * 1000 < t){
                    if (typeof cmdList[i][0] == 'function')
                        cmdList[i][0]();
                    else
                        eval(cmdList[i][0]);
                    if (cmdList[i][1] === true)
                        cmdList[i][1] = false
                    else
                        cmdList[i][2] = getOffsetTime(cmdList[i][1]);
                }
            }
            refreshTaskOnPageChange();
        }
    } catch (e){
        //document.title = e.stack.replace(/ /g, '');
        comment(e);
    }
}
function deleteTaskOnPageChange(tId){
    if (tId) delete cmdList[tId];
}
function refreshTaskOnPageChange(){
    for (var i in cmdList)
        if (cmdList[i][1] === false)
            deleteTaskOnPageChange(i);
        else
            if (nextCmdList == 0 || cmdList[i][2] < nextCmdList)
                nextCmdList = cmdList[i][2];
}
function initBrowserPage(){
    setIcon();
    killShadow();
    addTaskOnPageChange("killShadow()", 86300 * 1000);//24*3600=86400 & 1700 --> 17*24*3600
    addTaskOnPageChange("reduceShadow()", 3100 * 1000);//prime number 60*60=3600
}
function initClockWeather(){
    if (hasClockInit) return;//avoid duplicated init clock;
    hasClockInit = true;
    updateInterval();
    weatherInterval();
    timeAnimation(forTestUse?15:undefined);
}
function setIcon(){
    for (var i in document.styleSheets)
        for (var j in document.styleSheets[i].cssRules)
            if (document.styleSheets[i].cssRules[j].selectorText == '.tImg'){
                document.getElementById('ico').href = document.styleSheets[i].cssRules[j].style.content.slice(5, -2);
                return true;
            }
    return false;
}
function tasks(f, l, t, isLag, i){
    if (i == undefined) i = 0;
    if (i < (Array.isArray(l)?l.length:l)){
        if (!isLag)
            f(Array.isArray(l)?l[i++]:i++);
        setTimeout(function a(){tasks(f, l, t, false, i)}, t);
    }
}
function killShadow(force){
    var t = 400;
    var cleaner = document.getElementsByClassName('cleaner')[0].style;
    if (force || !preventDecreaseShadow){
        tasks(function a(e){cleaner.display = e}, ["", "", "none"], t);
        tasks(function b(e){cleaner.background = e}, ["", "white", ""], t);
        tasks(function c(e){document.body.style.color = e}, ["", "", "", "white", ""], t);
    }
}
function reduceShadow(){
    if (!preventDecreaseShadow)
        tasks(function a(e){document.getElementsByClassName('time')[0].style.opacity = e}, [0, 1], 600);
}
function runTime(n){return comment(timeFormat(new Date().getTime() - initTime, n ? n : 3, true));}
function noCache(){return "?noCache=" + document.body.clientWidth + "." + document.body.clientHeight + "." + ("" + Math.random()).slice(2, 9);}
function frontZero(a, n){
    if (!n) n = 2;
    if (typeof a != 'object')
        a = [a];
    for (var i = 0; i < a.length; i++)
        if (typeof a[i] == 'number' || !isNaN(parseInt(a[i]))){
            a[i] = a[i].toString();
            for (var j = n - a[i].length; j > 0; j--)
                a[i] = '0' + a[i];
        }
    return a.join('');
}
function timeFormat(s, n, noPlus){
    s = Math.floor(s);
    if (s == 0) return "";
    if (!n) n = 3;
    var str = "";
    var a = "";
    if (s > 0)
        a = "+";
    else {
        a = '-';
        s = -s;
    }
    if (s < 1000)
        str = "." + frontZero(s, 3) + "s";
    else {
        var f = [[10, 100, 60, 60, 24, 365, 100, 10], ["", "s", "m", "h", "d", "Y", "C", "T"]];
        var fsum = 1;
        for (var i in f[0])
            fsum *= f[0][i];
        for (var i = f[0].length - 1; i > 0 && n > 0; i--){
            if (s >= fsum){
                str += Math.floor(s / fsum) + f[1][i];
                s %= fsum;
                n--;
            }
            fsum /= f[0][i];
        }
        if (s != 0 && n > 0)
            str += frontZero(Math.floor(s / fsum), 2) + f[1][0];
    }
    return (!noPlus || a == '-' ? a : "") + str;
}
function timeOffsetFormat(n){return timeFormat(timeOffset, !n ? 2 : n);}
function how(){
    var inspect = ['runTime(2)', 'weeklyTomato.length', 'countIcs()', 'hardwareLagRate'];
    var o = '';
    var res;
    for (var i = 0; i < inspect.length; i++){
        res = eval(inspect[i]);
        if (typeof res == 'number' && res > 5 * 60 * 1000)
            res = timeFormat(res, 2, true);
        o += inspect[i].slice(0, 6) + ':' + res + ',';
    }
    o += '[' + (Object.keys(cmdList).length - 1) + ',' + dateString(nextCmdList) + ']:';
    for (var i in cmdList)
        o += i + (cmdList[i][1] !== true ? ',' + timeFormat(cmdList[i][1], 2, true) + ',' : 'T') + dateString(cmdList[i][2]) + '|';
    return o.slice(0, -1);
}
function wipe(){basket.innerHTML = '';}
function test(){
    forTestUse=true;
    document.getElementsByClassName('weath')[0].src = "about:blank";
    comment(how());
    testIcs();
    timeAnimation(15);
    setInterval('timeOffset+=57*1000;update()', 100);
}
function f5(append){
    location.replace(location.hostname + location.pathname + (append ? append : ''));
    location.reload();
}
var help = {
    vari: ['who', 'credit', 'help'],
    func: ['how', 'wipe', 'test', 'testIcs', 'f5'],
    who: navigator.userAgent,
    credit: JSON.stringify(info).replace(/"/g, '')
};
[].push.apply(help.help = help.func, help.vari);
function correctPrompt(){
    var userInput = prompt('Change kindle time: [;st ' + dateString('YMdhm') + ']\nDisable sleep: [~ds]\nPlease INPUT Time (hhmmss) or Cmd:\n' + 'Format: [' + dateString('hms').replace(/:/g, '') + '] ([123456] means reset)\nCMDs: [' + help.help+']');
    if (!timeCorrect(userInput))
        try {
            if (help.vari.indexOf(userInput) != -1)
                userInput = 'help.' + userInput;
            else if (help.func.indexOf(userInput) != -1)
                userInput += '()';
            comment(eval(userInput));
        } catch (e){
            comment('<span style="color:maroon">' + e + '</span>');
        }
}
function timeCorrect(correct){//000000~235959
    if (!correct || correct.length != 5 && correct.length != 6)
        return false;
    if (correct == "123456")
        timeOffset = 0;
    else {
        var hms = [correct.slice(-6, -4), correct.slice(-4, -2), correct.slice(-2)];
        var allow = [[0, 23], [0, 59], [0, 59]];
        for (var i = 0; i < hms.length; i++){
            hms[i] = Math.floor(parseInt(hms[i]));
            if (!(hms[i] >= allow[i][0] && hms[i] <= allow[i][1]))
                return false;
        }
        var date = new Date();
        date.setMinutes(date.getMinutes() + date.getTimezoneOffset() + 480);
        timeOffset = (((hms[0] - date.getHours()) * 60 + (hms[1] - date.getMinutes())) * 60 + (hms[2] - date.getSeconds())) * 1000;
    }
    update();
    return true;
}
function getOffsetDate(offset, noShift){
    var date = new Date();
    if (typeof offset != 'number') offset = 0;
    if (!noShift) date.setMinutes(date.getMinutes() + date.getTimezoneOffset() + 480);
    date.setMilliseconds(date.getMilliseconds() + timeOffset + offset);
    return date;
}
function getOffsetTime(offset, noShift){
    return getOffsetDate(offset, noShift).getTime();
}
function updateInterval(){
    var mscs = getOffsetTime();
    setTimeout("updateInterval()", lessDisturbUpdateWhenTomato ? ((599999 - mscs % 600000) + 50) : (59999 - mscs % 60000) + 50);//(60*10)*1000+50

    runTaskOnPageChange();
    update();
}
function update(){
    var date = getOffsetDate();
    if (timeOffset == 0)//fix the bug on kindle
        date.setMinutes(date.getMinutes() + 1);
    var hour = document.getElementById("hour");
    var minute = document.getElementById("minute");
    var calendar = document.getElementsByClassName("date")[0];
    var old_date = document.getElementsByClassName("old_date")[0];
    hour.innerHTML = frontZero(date.getHours()) + ':';
    minute.innerHTML = frontZero(date.getMinutes());
    var weekday = '日一二三四五六'[date.getDay()];
    calendar.innerHTML = (date.getMonth() + 1) + '月' + date.getDate() + '日'
        + (hasModule('lunaryear') ? '(' + weekday + ') ' + getLunarDay(false, false, true, true) : ' 星期' + weekday)
        + '<span style="font-size:1.5rem;position:absolute;"> ' + (forTestUse ? '#envTest' : '') + ' ' + tickListAlarm + "</span>";
    old_date.innerHTML = "子丑寅卯辰巳午未申酉戌亥"[Math.floor((date.getHours()>=23?0:date.getHours()+1)/2)];// + "初正"[1-date.getHours()%2];
    return date;
}
function weatherInterval(){
    var date = getOffsetDate();
    var nextRefresh = 0;
    document.getElementById('net').innerHTML = '初始化同步';
    if (date.getTime() - lastSyncTime > refreshRate + 100000)
        nextRefresh = 10 * 60 * 1000;
    else if (date.getHours() + refreshRate / 1000 / 3600 < 24)
        nextRefresh = refreshRate;
    else//calculate time till 00:00
        nextRefresh = 24 * 3600 * 1000 - date.getTime() % (24 * 3600 * 1000) + 50;
    addTaskOnPageChange("weatherInterval()", nextRefresh, true);

    if (date.getTime() - lastSyncTime > 10000)
        setTimeout(function onlineWeather(){
            var _doc = document.body;
            var script = document.createElement('img');
            script.setAttribute('src', '//www.163.com/favicon.ico' + noCache());
            _doc.appendChild(script);
            script.onload = script.onreadystatechange = function (){
                weather(!this.readyState || this.readyState == 'loaded' || this.readyState == 'complete');
                script.onload = script.onreadystatechange = null;
            }
            _doc.removeChild(script);
        }, 10);
}
function weather(connected){
    if (!connected)
        document.getElementById('net').innerHTML = '无网络连接';
    var date = getOffsetDate();
    lastSyncTime = date.getTime();
    if (!forTestUse && isOnKindle){
        var ifrm = document.getElementsByClassName('weath')[0];
        ifrm.src = "//i.tianqi.com/index.php?c=code&id=2&bdc=%23&icon=5&num=3&site=15";//change iframe
        document.getElementById('net').innerHTML = '完成上一次同步';
    } else {
        console.warn('[iframeRefresh:disabled] notTestNorWindows');
        document.getElementById('net').innerHTML = '测试模式';
    }
    document.getElementById('sync').innerHTML = date.getFullYear() + '-' + frontZero([date.getMonth() + 1, '-', date.getDate(), ' ', date.getHours(), ':', date.getMinutes(), ':', date.getSeconds()]);
    document.getElementById('timeoffset').innerHTML = timeOffsetFormat();
}
function timeAnimation(sixty, isAlter){
    clearTimeout(timeAnimationInterval);
    var loader=document.getElementsByClassName('loader')[0];
    if (!sixty)
        sixty=60;
    if (isAlter){
        // 00 -> 10 -> 11 -> 01 -> 00
        var base=6;
        var frames=15;// 1/(60/2/base/frames)=3fps
        var growth=range(10, 50, frames+1, function act(i){return i+"%"});// 2 3 2 1

        if (!timeAnimationInterval){
            loader.innerHTML='<div style="height: 2rem; transform: scaleY(-1)">'+repeat('<div class="bar"></div>', base)+"</div>";
        }
        var seconds=getOffsetTime()/1e3%sixty;
        var circle=sixty/2/base;
        var next=(circle-seconds%circle)*1e3;
        //console.log(Math.floor(seconds/circle)%base, circle-seconds%circle, circle, seconds);
        tasks(function act(e){
            loader.children[0].children[Math.floor(seconds/circle)%base].style.height=e;
            }, (seconds<(sixty/2)?growth:growth.reverse()).slice(1), circle/frames*1e3, true);
    } else {
        // bagua
        var loader=document.getElementsByClassName('loader')[0];
        if (!timeAnimationInterval){
            loader.innerHTML='<div style="width: 1.5rem">'+repeat('<div class="gua"></div><div class="gua" style="width: .3rem"></div><div class="gua"></div>', 6)+'</div>';
        }

        var state=decBin(getOffsetTime()/1e3%sixty/sixty*64, 6);
        var next=sixty/64;
        for (var i=0;i<state.length;i++)
            loader.children[0].children[i*3+1].style.opacity=state[i]?"1":"0";
    }
    timeAnimationInterval=setTimeout("timeAnimation("+sixty+", "+isAlter+")", next+10);//bug on timer activate 0.000999927520751s earlier

    function decBin(d, n){
        var r=[];
        var s=Math.floor(d).toString(2);
        var l=s.length;
        for (var i=0;i<l;i++)
            r.push(s[i]=="1"?1:0);
        for (var j=r.length;j<n;j++)
            r.unshift(0);
        return r;
    }

    function range(start, end, n, f){
        var res=[];
        for (var i=start;i<=end;i+=(end-start)/(n-1))
            res.push(f(i));
        return res;
    }

    function repeat(s, n){
        var r='';
        for (;n>0;n--)
            r+=s;
        return r;
    }
}


/*                TOMATO: Tomato Timer                */
var toStatus, ispaused, weeklyTomato = [];
var timerEntity;
var signalTired = 0;
var toWorkTimer = 25 * 60;//Second
var timerEnd, restWhenPaused;
var toRestTimer = 5 * 60
var expireTomato = 30;//Day
var tomatoMsg = [document.getElementById('tom'), document.getElementById('ato')];
var buttonStyle = [document.getElementById('hour').style, document.getElementById('minute').style]
var shinningSignal = [document.getElementById('ato').style, document.getElementsByClassName('inform')[0].style, document.getElementsByClassName('date')[0].style];
var isHomeShrink = false;
//dumpTomato();gatherTomato(719);
function dumpTomato(){rottenTomato(-1);}
function gatherTomato(fakeTomatos){
    if (!weeklyTomato.length) eatTomato();
    if (fakeTomatos)
        for (var i = 0; i < fakeTomatos; i++)
            weeklyTomato.push(-1);
    else
        weeklyTomato.push(Math.floor(new Date().getTime() / (24 * 3600 * 1000)));
    canTomato();
    showTomato("Gather");
}
function canTomato(){document.cookie = "tomato=" + compressTomato() + ";expires=" + new Date(0x7fffffff * 1e3).toUTCString();}
function compressTomato(){
    var compressed = "";
    for (var i = 0; i < weeklyTomato.length; i++){
        if (i != 0) compressed += '.';
        compressed += Math.floor(weeklyTomato[i]).toString(36);
    }
    return compressed;
}
function showTomato(source){
    basket.textContent = "";
    var f = [1, 2, 20, 60, 180];
    var res = 0;
    var tomatos = weeklyTomato.length;
    for (var i = f.length - 1; i >= 0 && tomatos != 0; i--){
        res = Math.floor(tomatos / f[i]);
        tomatos %= f[i];
        for (var j = 0; j < res; j++)
            enchantTomato(basket, ['opacity: 0.5;', "", 'border:0.1rem dashed black;', 'border:0.1rem solid black;', 'border:0.1rem solid black; background-color: #c0c0c0'][i]);
    }
    if (weeklyTomato.length != 0) basket.insertAdjacentHTML("beforeend", weeklyTomato.length);
    logTomato(source);
}
function enchantTomato(e, magicType){
    var script = document.createElement('img');
    script.setAttribute('class', 'tImg');
    if (magicType) script.setAttribute('style', magicType);
    e.appendChild(script);
}
function eatTomato(){
    var offset = document.cookie.indexOf("tomato=");
    var end = document.cookie.indexOf(";", offset);
    if (offset != -1){
        offset += "tomato=".length
        if (end == -1) end = document.cookie.length;
        var content = document.cookie.substring(offset, end);
        if (content){
            weeklyTomato = Array();
            content = content.split(".");
            for (var i in content)
                if (parseInt(content[i], 36))
                    weeklyTomato.push(parseInt(content[i], 36));
        }
        logTomato("Read");
    }
}
function logTomato(source){
    if (weeklyTomato.length == 0)
        console.log("Empty >ToMaMaTo< Store from " + source);
    else
        console.log("Len:" + weeklyTomato.length + " " + source + ":" + weeklyTomato.slice(0, 5));
}
function rottenTomato(expire){
    var date = Math.floor(new Date().getTime() / (24 * 3600 * 1000)) - (!expire ? expireTomato : expire);
    weeklyTomato.sort(function (a, b){return b - a;});
    for (var i = 0; i < weeklyTomato.length; i++)
        if (weeklyTomato[i] < date){
            weeklyTomato = weeklyTomato.slice(0, i);
            break;
        }
    canTomato();
    setTimeout("rottenTomato()", expireTomato * 24 * 3600 * 1000 / 3);
    showTomato("Rotten");
}
function updateMsg(tom, sliceIndex){
    if (tom){
        if (sliceIndex) tom += tomatoMsg[0].innerHTML.slice(sliceIndex);
        if (tom.slice(-2) != ": ") tom += ": "
        tomatoMsg[0].innerHTML = tom;
    }
    var s = Math.round((timerEnd - new Date().getTime()) / 1000);
    var timeString = "" + frontZero(Math.floor(s / 60)) + ":" + frontZero(s % 60);
    if (!document.hidden){
        tomatoMsg[0].style.background = toStatus == 'work' ? 'gray' : '';
        tomatoMsg[1].innerHTML = timeString;
    } else
        document.title = timeString + (toStatus == 'work' ? " <TOM" : " <ATO");
}
function fridgeTomato(){
    killShadow();
    tomatoMsg[0].style.background = '';
    tomatoMsg[0].innerHTML = toStatus && toStatus != 'stop' ? 'MATO' : 'TOMA';
    tomatoMsg[1].innerHTML = toStatus && toStatus != 'stop' ? 'TOMA' : 'MATO';
    prepareTomato();
    document.title = initialTitle;
    if (isHomeShrink){
        isHomeShrink = false;
        var butts = document.getElementsByClassName('h_switch');
        for (var i = 0; i < butts.length; i++)
            butts[i].style.height = '';
    }
}
function prepareTomato(){
    //quit from tomato
    preventDecreaseShadow = false;
    lessDisturbUpdateWhenTomato = false;
    killShadow();
    toStatus = 'stop';//work,rest,stop
    ispaused = false;
    eatTomato();
    clearTimeout(timerEntity);
    updateButton();
}
function switchTomato(){
    if (!toStatus){
        prepareTomato();
        showTomato('INIT');
    }
    switch (toStatus){
        case 'stop':
            toStatus = 'work';
            setTimer();
            preventDecreaseShadow = true;
            lessDisturbUpdateWhenTomato = true;
            timerEnd = new Date().getTime() + toWorkTimer * 1000;
            updateMsg("番茄开始");
            updateButton();
            if (!isHomeShrink){
                isHomeShrink = true;
                var butts = document.getElementsByClassName('h_switch');
                for (var i = 0; i < butts.length; i++)
                    butts[i].style.height = '8rem';
            }
            break;
        case 'work':
            toStatus = 'rest';
            restWhenPaused = toRestTimer * 1000;
            timerEnd = new Date().getTime() + restWhenPaused;
            clearTimeout(timerEntity);
            updateMsg("番茄中场");
            pauseTomato();
            break;
        case 'rest':
            toStatus = 'work';
            restWhenPaused = toWorkTimer * 1000;
            timerEnd = new Date().getTime() + restWhenPaused;
            clearTimeout(timerEntity);
            updateMsg("番茄工作");
            pauseTomato();
            break;
    }
}
function setTimer(){
    clearTimeout(timerEntity);
    timerEntity = setTimeout(function tomatoTimer(){
        if (timerEnd < new Date().getTime()){
            if (toStatus == 'work')
                gatherTomato();
            switchTomato();
        } else {
            updateMsg();
            setTimer();
        }
    }, 1000);
}
function updateButton(){
    buttonStyle[1].color = (ispaused) ? '#303030' : '#a9a9a9';
    if (toStatus == 'stop') buttonStyle[1].color = '#000000';
    buttonStyle[0].color = ['#000000', '#303030', '#a9a9a9'][['stop', 'work', 'rest'].indexOf(toStatus)];
}
function updateSignal(){
    if (ispaused && toStatus != 'stop'){
        if (signalTired > toWorkTimer){
            document.title = initialTitle;
            for (var i = 0; i < shinningSignal.length; i++)
                shinningSignal[i].color = '#000000';
        } else {
            if (signalTired % 2 == 0){
                document.title = '✔ * * * ✔';
                for (var i = 0; i < shinningSignal.length; i++)
                    shinningSignal[i].color = '#ffffff';
            } else {
                document.title = '* RELAX *';
                for (var i = 0; i < shinningSignal.length; i++)
                    shinningSignal[i].color = '#000000';
            }
            if (signalTired == 0 || signalTired == toWorkTimer)
                killShadow(true);
            signalTired++;
            setTimeout('updateSignal()', 800);
        }
    } else {
        signalTired = 0;
        document.title = initialTitle;
        for (var i = 0; i < shinningSignal.length; i++)
            shinningSignal[i].color = '#000000';
    }
}
function pauseTomato(){
    if (!toStatus || toStatus == "stop") return;
    ispaused = !ispaused
    if (ispaused){
        clearTimeout(timerEntity);
        restWhenPaused = timerEnd - new Date().getTime();
        updateMsg("暂停", -4);
    } else {
        setTimer();
        timerEnd = new Date().getTime() + restWhenPaused;
        updateMsg("番茄", -4);
    }
    updateButton();
    updateSignal();
}


/*                TICKLIST: Ticktick Reminder
Note: you need set a Nginx server to proxy the GET method to the
        calendar server to download the .ics file. Add those lines
        to your Nginx config file to avoid CORS problem as the
        request directly from your browser is banned for some
        security reason.
        
location /ics/ {
    proxy_redirect off;
    proxy_buffering off;
    proxy_http_version 1.1;
    proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
    proxy_set_header Upgrade $http_upgrade;
    proxy_set_header Connection $http_connection;
    add_header Access-Control-Allow-Methods *;
    add_header Access-Control-Allow-Credentials true;
    add_header Access-Control-Allow-Origin $http_origin;
    if ($request_method = OPTIONS){
    return 200;
    }
    access_log off;
    proxy_pass https://XXX/pub/calendar/feeds/XXXXX/basic.ics;
}
*/
var tickList = {};
var tickListStatus = 0;
var tickListTaskIndex = 0;
var tickListMaxLine = 21;
var tickListReminderList = {};
var reminder = document.getElementsByClassName('reminder')[0];
function dDay(t){return dHour(t, 24);}
function dHour(t, h){return parseInt(dMs(t, (!h ? 1 : h) * 3600 * 1000));}
function dMs(t, ms){return (t - getOffsetTime()) / (!ms ? 1 : ms);}
function dateString(timeStamp, format){
    var s = '';
    var all = 'YMdhms';
    var date = getOffsetDate();
    if (timeStamp)
        if (String(timeStamp).match(/\d/))
            date = new Date(timeStamp);
        else if (!format)
            format = timeStamp;
    if (!format) format = 'hm';
    var res = [date.getFullYear(), date.getMonth() + 1, date.getDate(), date.getHours(), date.getMinutes(), date.getSeconds()];
    for (var i = 0; i < all.length; i++)
        if (format.indexOf(all[i]) != -1)
            s += frontZero([res[i], '-- :: '[i]]);
    return s.slice(0, -1);
}
function randInt(n, from){if (from == undefined) from = 0; return Math.ceil(Math.random() * (n - from)) + from;}
function countIcs(){
    var b = [];
    for (var i = 0; i < tickList.length; i++)
        b.push(tickList[i].length);
    return b;
}
function testIcs(n){
    var s = '';
    if (!n) n = 16;
    var d = new Date();
    d.setMinutes(d.getMinutes() + d.getTimezoneOffset() + 15 + 1);
    for (var i = 0; i < n; i++)
        s += "BEGIN:VEVENT\nDTSTART:" + (2018 + randInt(3)) + frontZero(randInt(12, 1)) + '01T020304Z\nSUMMARY:Default\nDESCRIPTION:e\n'
            + "BEGIN:VEVENT\nDTSTART:" + d.getFullYear() + frontZero([d.getMonth() + 1, d.getDate(), 'T', d.getHours(), randInt(59, 0)]) + '08Z' + '\nSUMMARY:Default\nDESCRIPTION: e' + space(5) + '测试测试测试测试测试测试测试测试测试测试' + '\nRRULE:FREQ=WEEKLY;INTERVAL=3\n';
    readIcs(s);
    tickListStatus++; showIcs(true);
}
function getIcs(){httpReq("/ics/", function a(s){readIcs(s); showIcs(true);}, comment);}
function readIcs(s){
    s = s.replace(/\r/g, '').split('\n');
    var r = [];
    var tag = ['DTSTART', 'DTSTART;VALUE=DATE', 'SUMMARY', 'DESCRIPTION', 'TRIGGER', 'RRULE', 'DTSTART;TZID=Asia/Shanghai'];//TIMEZONE-NOTE
    for (var i = 0; i < s.length; i++){
        var splitter = s[i].indexOf(':');
        var line = [s[i].slice(0, splitter).trim(), s[i].slice(splitter + 1).trim()];
        if (line[0] == 'BEGIN'){
            if (line[1] == 'VEVENT')
                r.push({});
        } else if (tag.indexOf(line[0]) != -1 && r.length != 0 && r[r.length - 1][line[0]] == undefined){
            switch (line[0]){
            case tag[6]:
                line[0]=tag[0];
            case tag[0]:
                line[1] = Date.parse(line[1].slice(0, 4) + '-' + line[1].slice(4, 6) + '-' + line[1].slice(6, 11) + ':' + line[1].slice(11, 13) + ':' + line[1].slice(13) + (line[1].slice(-1).toUpperCase()!='Z'?'Z':'')) + (new Date().getTimezoneOffset() + 480) * 60 * 1000;//TIMEZONE-NOTE
                break;
            case tag[1]:
                line[0] = tag[0]
                line[1] = Date.parse(line[1].slice(0, 4) + '-' + line[1].slice(4, 6) + '-' + line[1].slice(6, 8) + 'T08:00:00Z');
                r[r.length - 1]['isDateOnly'] = true;
                break;
            case tag[3]:
                for (var j = i + 1; j < s.length && s[j][0] == ' '; j++)
                    line[1] += s[j].slice(1);
                line[1] = line[1].replace(/\\n|\\|\n/g, '').trim();
                if (line[1].startsWith('- ') && line[1].indexOf(' - ') != -1)
                    line[1] = line[1].slice(2).replace(/ - /g, ' / ');
                break;
            case tag[5]:
                r[r.length - 1]['FREQ'] = '';
                line[1] = line[1].split(';');
                for (var j in line[1]){
                    line[1][j] = line[1][j].split('=');
                    if (line[1][j][0] == 'FREQ')
                        r[r.length - 1]['FREQ'] += '年月周日'[['ANNUALLY', 'MONTHLY', 'WEEKLY', 'DAILY'].indexOf(line[1][j][1])];
                    else if (line[1][j][0] == 'INTERVAL')
                        r[r.length - 1]['FREQ'] = (line[1][j][1] <= 9 ? '零 两三四五六七八九'[parseInt(line[1][j][1])] : line[1][j][1]) + r[r.length - 1]['FREQ'];
                }
                continue;
            }
            r[r.length - 1][line[0]] = line[1];
        }
    }
    sortIcs(r, 1);
    return tickList;
}
function sortIcs(r, sortNum){
    clearReminder(true);
    tickList = {important: [], normal: [], noDate: []};
    var func = [[function (d){return d > -14},
    function (a, b){return b.DTSTART - a.DTSTART}],
    [function (d, freq){return d >= (freq ? -7 : -14) && d <= (freq ? 3 : 90)},
    function (a, b){
        var c = [a.DTSTART, b.DTSTART];
        var d = [a, b];
        for (var i = 0; i < c.length; i++){
            c[i] -= getOffsetTime();
            var isNeg = c[i] != (c[i] = Math.abs(c[i]));
            c[i] *= (isNeg ? c[i] > 180 ? 3 : 2 : 1) * (d[i].isDateOnly ? c[i] > 180 ? 6 : 3 : 1) * (d[i].FREQ ? c[i] > 4 ? 8 : 3 : 1);
        }
        return c[0] - c[1];
    }]][sortNum];
    for (var i = 0; i < r.length; i++)
        if (r[i].DTSTART){
            var dD = dDay(r[i].DTSTART);
            if (dD<=0&&dD>-3)
                alarmIcs(r[i]);
            if (func[0](dD, r[i].FREQ))
                tickList.important.push(r[i]);
            else
                tickList.normal.push(r[i]);
        } else
            tickList.noDate.push(r[i]);
    tickList.important.sort(function (a, b){return a.DTSTART - b.DTSTART;});
    tickList.normal.sort(func[1]);
}
function showIcs(keep){
    if (!tickListTaskIndex && !forTestUse)
        tickListTaskIndex = addTaskOnPageChange('getIcs()', 6 * 3600 * 1000);
    var t = document.getElementsByClassName('tickList')[0];
    var tickTable = t.getElementsByTagName('table')[0];
    tickTable.innerHTML = '';
    var tickImg = t.getElementsByClassName('tImg')[0];
    if (!keep) tickListStatus++;
    if (!keep && tickListStatus % 6 == 1){
        tickTable.innerHTML = tickListStatus;
        getIcs();
    } else if (tickListStatus % 3 == 0){
        t.innerHTML = '<div></div><img class="tImg" style="padding:1rem"><table></table>';
    } else {
        if (tickImg) t.removeChild(tickImg);
        var limit = (tickListStatus % 3 == 1) ? 5 : tickListMaxLine;
        var s = '<tr><td style="opacity:.3">' + dateString() + '<span style="opacity:0">100.00</span></td><td style="font-size:1.5rem;opacity:0;line-height:0">1000</td></tr>';
        var cross30;
        for (var j in tickList){
            var l = tickList[j];
            for (var i = 0; i < l.length; i++){
                if (--limit < 0) break;
                var dD = dDay(l[i].DTSTART);
                var adD = Math.abs(dD);
                var td_divider = '';
                if (cross30 == undefined)
                    cross30 = adD;
                if (adD >= 30 && cross30 < 30){
                    cross30 = 31;
                    td_divider = 'background: lightgray; ';
                }
                if (l[i].SUMMARY.length + l[i].DESCRIPTION.length > 25){
                    var sum='<b>'+l[i].SUMMARY.slice(0, 10)+'</b>';
                    var des=(l[i].SUMMARY.slice(10) + (l[i].SUMMARY.length > 10 && l[i].DESCRIPTION ? ': ' : '') + l[i].DESCRIPTION.slice(0, 200 - Math.min(10, l[i].SUMMARY.length) * 6)).trim();
                } else {
                    var sum=('<b>'+l[i].SUMMARY + '</b> ' + l[i].DESCRIPTION).trim();
                    var des='';
                }
                var freq = (l[i].FREQ) ? '<sup style="font-size:xx-small;border-radius:20%;border:solid">' + l[i].FREQ + '</sup>' : '';
                s += '<tr style="' + (!dD ? 'font-weight:bold; ' : '') + '"><td style="' + td_divider + (l[i].isDateOnly?'text-align: center;':"") + '">' + dateString(l[i].DTSTART, l[i].isDateOnly?'Md':'Mdhm') + '</td><td class="countdown" style="color:hsl(0,0%,' + Math.floor(adD / (!j ? 120 : 480) * 100) + '%);'+(dD<0?'font-size: 1.2rem':'')+'">' + (adD < 7 ? '<img class="tImg" style="height:1.5rem;margin-left:-2rem"><div class="tomato" style="height:' + Math.ceil(adD / 10 * 2) / 2 * 1.5 + 'rem"></div>' : '') + (dD ? dD : '') + '</td><td class="content"><span class="summary"> ' + (!dD ? '<i>' + dHour(l[i].DTSTART) + 'h</i> ' : '') + freq + sum + '</span>' + '<span style="background:white;">' + des + '</span></td></tr>';
            }
        }
        tickTable.innerHTML = s;
        addTaskOnPageChange('displayReminder()', 2.5 * 3600 * 1000, true);//2.5*2=5<6<2.5*3=7.5
    }
}
function alarmIcs(tick){
    var dH = dHour(tick.DTSTART);
    var d = dMs(tick.DTSTART);
    tickListAlarm = '';
    remindIcs("tickListAlarm='['+'" + dateString(tick.DTSTART) + ' ' + tick.SUMMARY.slice(0, 20) + "'+']'", (dH - 12) * 3600 * 1000);
    remindIcs("tickListAlarm=''", (dH + 12) * 3600 * 1000);
    if (dH >= -1){
        remindIcs(function remind(){
            tickListReminderList[hashString(tick)] = tick;
            killShadow(true);
            displayReminder()
        }, d - 15 * 60 * 1000);
        remindIcs('killShadow(true)', d - 1 * 60 * 1000);
    }
}
function deleteReminder(tickId){
    if (confirm('Job\'s done?')){
        delete tickListReminderList[String(tickId)];
        var i = document.getElementById('tick' + tickId);
        var p = i.parentNode;
        p.removeChild(i);
        if (!p.hasChildNodes())
            p.style.display = 'none';
    }
    stopBubble();
}
function hashString(tick){
    var s = tick.SUMMARY + tick.DESCRIPTION;
    var hash = 0, i;
    for (i = 0; i < s.length; i++){
        hash = ((hash << 5) - hash) + s.charCodeAt(i);
        hash |= 0; // Convert to 32bit integer
    }
    return (hash + Math.floor(tick.DTSTART / 1000)).toString(36);
}
function displayReminder(){
    var l = Object.keys(tickListReminderList).length;
    var s = '';
    if (!l)
        return;
    for (var i in tickListReminderList){
        var tick = tickListReminderList[i];
        s += '<span style="display:block" id="tick' + i + '" onclick="deleteReminder(\'' + i + '\')">' + (tick.FREQ ? '<sup style="font-size:small;border-radius:20%;border:solid">' + tick.FREQ + '</sup>' : '') + '[' + dateString(tick.DTSTART, 'Mdhm') + timeFormat(dMs(tick.DTSTART), 1) + ']<br>' + tick.SUMMARY + '<br>' + tick.DESCRIPTION + '</span>';
    }
    s = s ? s.slice(0, -11) + '</span>' : '';
    if (l > 3)
        reminder.style.cssText = "margin: -28rem 10rem;max-height: 25.5rem;";
    else
        reminder.style.cssText = "";
    reminder.innerHTML = s;
    reminder.style.display = 'block';
    (function shinning(){
        if (Object.keys(tickListReminderList).length){
            tasks(function f(e){reminder.firstChild.style.opacity=e;}, [0, 1, 0, 1, 0, 1], 1e3);
            setTimeout(shinning, 60e3);
        }
    })();
}
function clearReminder(force){
    var r = force?force:confirm('*CLEAN ALL?*');
    if (r){
        tickListReminderList = {};
        reminder.style.display = 'none';
    }
    return r;
}
function remindIcs(cmd, timeout){addTaskOnPageChange(cmd, timeout, true);}//-12h,-15m,-1m,+12h


/*                DANMU: Bilibili Live Danmu
sudo apt-get install python3-distutils
sudo apt-get install python3-pip
sudo pip3 install aiohttp [-i https://source]
python3 sample.py 92613
sudo nano /etc/nginx/nginx.conf
sudo systemctl restart nginx

location /blive/ {
    proxy_http_version 1.1;
    proxy_set_header Upgrade $http_upgrade;
    proxy_set_header Connection $http_connection;
    add_header Access-Control-Allow-Origin *;
    add_header Access-Control-Allow-Headers X-Requested-With;
    add_header Access-Control-Allow-Methods GET,POST,PUT,OPTIONS;
    access_log off;
    proxy_pass http://localhost:8099;
}

# USED IN TAMPERMONKEY for auto-change room-id
// ==UserScript==
// @name         DANMU_ROOM
// @match        *://live.bilibili.com/*
// ==/UserScript==
(function(){
'use strict';
var i=location.pathname.split('/')[1];
if (!isNaN(parseInt(i))){
    var xmlhttp = new XMLHttpRequest();
    xmlhttp.onreadystatechange = function(){
        if (xmlhttp.readyState == 4){
            document.title=(xmlhttp.status==200?'√ ':'['+xmlhttp.status)+document.title;
            console.log("["+i+"] "+xmlhttp.status+" "+xmlhttp.responseText)
        }
    }
    xmlhttp.open('GET', "https://debian10/blive/?"+i);
    xmlhttp.send();
}
})();
*/
var danmuStartTime = 0;
var streamer = [['nc','dd','wt','dr',   'fu',      'hs',      'iv',      'qk',],
    [0x4c4, 0x40a4, 0x2dd, 0x75e82, 0x1dd4ae, 0x162cabc, 0x154c852, 0x14b386e,// hex roomid, this line has streamer name
     0x163a23b, 0x160f887, 0x152ef9f, 0x46f479, 0x1596acd, 0x149f74b, 0x4f417e]];// this line doesn't have streamer name
var liveVol = [,,      .8,     .06,      .15,        .8,          ,          ,
            .3,         ,          ,        1,];// belongs to streamer[1]'s second line
var liveDefaultVol=.6;
var streamerTime = Array(streamer[1].length);
var streamerTitle = Array(streamer[1].length);
var streamerUid = [];
var liveOther = {};
var danmuLimit={
    max: 50,
    line: 15,
};
var dInfo={// danmuInfo
    _roomId: '',
    roomIndex: -1,
    set roomId(n){
        this._roomId=String(n);
        this.roomIndex=streamer[1].indexOf(parseInt(n));
    },
    get roomId(){return this._roomId},
    last: '',
    flow: 0,
    xmlReq: undefined,
    player: undefined,
    flag: {
        on: 0,// 0 off, 1 live, other
        reconfirm: false,
        watch: true,
        bird: false,
    },
    count: {
        req: 0,
        retry: 0,
        live: 0,
    },
    _pop: 0,
    popTrend: 0,
    set pop(p){
        p=parseInt(p);
        this.popTrend=p < this._pop ? -1 : (p > this._pop ? 1 : 0);
        this._pop=p;
    },
    get pop(){return this._pop},
    _purse: 0,
    purseTrend: 0,
    set purse(p){
        p=parseInt(p);
        if (p&&p>this._purse){
            this.purseTrend=p-this._purse;
            this._purse=p;
        }
    },
    get purse(){return this._purse},
    sc: '',
    lyrc: {n: 0, last: ''},
    _other_room: '',
    set other_room(s){
        if (s!=this._other_room&&isDanmuOnly&&liveOption.enable&&s&&this._pop==123456)
            liveFromOther(s);
        this._other_room=s;
    },
    get other_room(){return this._other_room},
};
var danmuArea='';
var danmuTask={
    content: 0,
    info: 0,
    tuber: 0,
    guard: 0,
    liveRetry: 0,
};
var livePlayer;
var liveBlock=[0xb911, 0xe53cd, 0x1610b66, 0x14b11b6, 0x1455367, 0x14e7659, 0x1467c9c, 0x491146, 0x15ac9d1, 0x1593147, 0x1586bb6];

function space(n, s){
    s = s != undefined ? String(s) : '';
    for (n -= s.length * 1.8; n-- > 0;)
        s += ' ';
    return s;
}
function danmuSwitch(){
    switch (dInfo.flag.on){
        case 0:
            danmuOn(liveOption.occupy?'kick':'');
            break;
        default:
            if (dInfo.pop <= 1 || isDanmuOnly){
                var up = prompt('Current: ' + dInfo.roomId + '\nStreamer:\n' + streamer[0] + '\nControl:\n'
                    +['[bliveRoomId or otherUrl] 打开直播', 'w 切换 watch', 'f 窗口模式', 'url 添加 #danmuonly', 'kick 独享', 'history 历史弹幕', 'restart 重启', 'status 统计', 'call: 通话', 'js: 远程脚本', 'clients 客户端', 'cors: 跨域请求', 'time 时间戳', 'upgrade 更新']);
                if (up != null)
                    if (up == '' && (dInfo.pop <= 1||isDanmuOnly))
                        danmuOff('<b>quit</b>');
                    else
                        danmuOn(up, true);// due to user-gesture policy, fs disabled here
            } else
                danmuOff('<b>connect</b>' + dInfo.count.req);
    }
}
function danmuOn(roomId, withoutFullScreen){
    if (isDanmuOnly&&!withoutFullScreen)
        danmuFullScreen(true);
    liveOption.enable=isDanmuOnly&&liveOption.enable;
    roomId=roomId?String(roomId):'';
    roomId=roomId.replace(/.*live\.bilibili\.com\/(?:h5\/)(\d+).*/,'$1');
    if (streamer[0].indexOf(roomId) != -1)
        roomId = streamer[1][streamer[0].indexOf(roomId)];
    if (!roomId)
        danmuWrite('[ON@'+dateString()+']'+(liveOption.occupy?'kicking':''), true, true);
    if (!danmuStartTime)
        danmuStartTime = getOffsetTime();
    dInfo.count.retry = 0;
    dInfo.pop = 0;
    dInfo.purse = 0;
    danmu_fr.style.opacity = 1;
    danmuArea='';
    switch (roomId){
        case 'url':
            f5('#danmuonly');
            break;
        case 'w':
            dInfo.flag.watch=!dInfo.flag.watch;
            break;
        case 'f':
            isDanmuFullWindow=!isDanmuFullWindow;
            break;
        case 'kick':
            liveOption.occupy=true;
            danmuWrite('[kick] ing...')
        default:
            if (dInfo.xmlReq){
                dInfo.xmlReq.isAbort=true;
                dInfo.xmlReq.abort();
            }
            dInfo.flag.on = 1;
            danmuContent(roomId?roomId:'');
    }
    setRoomId(roomId, true);
    danmuStatus();
    danmuAlter(false);
    danmuDark();
}
function danmuOff(s){
    if (!dInfo.flag.on) return;
    dInfo.flag.on = 0;
    dInfo.flag.bird=false;
    liveOff(false, 'maually');
    clearTimeout(danmuTask.content);
    clearTimeout(danmuTask.info);
    setTimeout(function danmuClear(){
        if (!dInfo.flag.on&&!isDanmuOnly){
            danmu_fr.style.opacity = 0;
            danmu_info.innerHTML = '';
        }
    }, 10 * 60e3);
    danmuAlter(true);
    danmuWrite('<b>[OFF@'+ dateString() +']</b> ' + (s ? s + ' ' : '') + '<b>U</b>' + timeFormat(getOffsetTime() - danmuStartTime, 2, true));
    danmuStartTime=0;
    dInfo.pop = 0;
    dInfo.purse = 0;
    danmuStatus();
}
function danmuTitle(s, i){
    if (i==undefined)
        i=dInfo.roomIndex;
    if (typeof s=="string")
        streamerTitle[i]=s;
    return streamerTitle[i]?streamerTitle[i]:'... ';
}
function danmuAlter(beLess){
    if (beLess){
        danmu.style.background = 'white';
        danmu_fr.classList.remove('more');
        danmu_fr.classList.remove('fullwindow');
        danmu_fr.classList.add('less');
    } else {
        if (dInfo.flag.on == 1){
            danmuContent();
            danmuFirstStatus();
        }
        danmu.style.background = '';
        danmu_fr.classList.remove('less');
        danmu_fr.classList.add('more');
        if (isDanmuFullWindow)
            danmu_fr.classList.add('fullwindow');
        else
            danmu_fr.classList.remove('fullwindow');
    }
}
function danmuFirstStatus(){
    setTimeout(function a(){danmuReq("status", danmuParseStatus)}, 1e3);
}
function setDanmuPop(p){
    if (p>1&&dInfo.pop>1&&!(Math.abs(p-dInfo.pop)>.005*p+500))// lazyload (10e4, 1e3), (50e4, 2e3), (100e4, 5e3)
        return false;
    if (dInfo.flag.on && p != dInfo.pop && !(dInfo.pop == 0 && p == 1 && getOffsetTime() - danmuStartTime < 2 * 60 * 1000) || (dInfo.pop == 9999 && p != 1)){
        var old = dInfo.pop;
        dInfo.pop = p;
        if (old == 0 && p > 1)
            reduceShadow();
        if (p == 9999)
            danmuAlter(true);
        else if (old>1 && p == 1){
            danmuAlter(true);
            danmuWrite('TRANSMIT' + dateString(), true);
            danmuTuber();
        } else if (old == 9999 || (old == 1 && p > 1))
            danmuAlter(false);
        if (isDanmuOnly&&liveOption.enable&&old<=1&&p>1&&p!=9999&&dInfo.roomId&&isLiveOff()){
            if (!isLiveOff()&&danmu_fr.clientHeight<danmu_fr.clientWidth&&mpegts.isSupported()&&p<9e4)
                danmu.classList.add('better_view');
            else if (p>10e4)
                danmu.classList.remove('better_view');
            liveFromRoom();
        }
        if (forTestUse)
            console.log('Pop', p);
        danmuStatus();
    }
}
function scrollAnimation(){
    if (isDanmuOnly)// css changes not immediately thus needs twice calls
        requestAnimationFrame(function outer(){
            requestAnimationFrame(function slow(){
                danmu.scrollTop=danmu.scrollHeight;
                danmu.scrollLeft=-danmu.scrollWidth;
            });
        });
}
function danmuWrite(s, isBold, isReverse, isInSameLine, stillShowDuplicate){
    if (!s||!s.length||!stillShowDuplicate&&dInfo.last == (dInfo.last = s)) return;
    if (isBold) s = '<b>' + s + '</b>';
    if (isReverse) s = '<small> ' + s + '</small>';
    if (isDanmuOnly)
        danmu.insertAdjacentHTML('beforeend', (isInSameLine ? ' |' : '<br>')+s);
    else
        danmu.insertAdjacentHTML('afterbegin', s+(isInSameLine ? ' |' : '<br>'));
    danmuGC(danmu, danmuLimit.max);
    scrollAnimation();
    return s;
}
function danmuGC(e, limit){
    var len=e.childNodes.length;
    if (len>limit*15)
        for (var i=isDanmuOnly?0:len-1;isDanmuOnly?i<limit:i>limit;isDanmuOnly?i++:i--)
            e.removeChild(e.childNodes[i]);
}
function htmlEscape(s){
    return String(s).replace(/[\u00A0-\u9999<>\&]/g, function(i) {return '&#'+i.charCodeAt(0)+';'});
}
function danmuShow(s){
    if (!s) return;
    var sn = s.split('<br>');
    var s = [];
    var dup=[];
    dInfo.flow=dInfo.flow>4?sn.length:sn.length>dInfo.flow?dInfo.flow*.9+sn.length*.1:dInfo.flow*.99+sn.length*.01;
    if (dInfo.pop == 1 && sn.length > 5)
        setDanmuPop(2);
    for (var i = 0; i < sn.length; i++)
        if (sn[i] = sn[i].trim()){
            if (!sn[i].indexOf('<!--')&&sn[i].slice(-3)=='-->'){
                danmuParseStatus(sn[i].slice(4, -3));
                continue;
            } else if (dedup(sn[i], s))
                continue;
            if (sn[i].startsWith('[JS]'))
                parseJS(sn[i].slice(4));
            else if (sn[i].startsWith('[LYRC] '))
                parseLyrc(sn[i].slice(7));
            if (sn[i][0] == '[' && sn[i].indexOf(']') != -1)
                sn[i] = ' >> '+sn[i];
            else if (dInfo.pop == 1)
                sn[i] = '<small>' + dateString() + ' </small>' + sn[i];
            if (sn[i] && sn[i].indexOf('[LYRC]') == -1)
                s.push(sn[i]);
        }
    applyDup();
    danmuWrite(s.slice(-danmuLimit.line).join("<br>"));
    if (isDanmuOnly&&danmu_fr.classList.contains('rotate'))
        dTool.clean;// to fix text-orientation: sideways

    function parseJS(s){
        setTimeout(function run(){
            try {
                var res=eval(s);
                if (res!=undefined){
                    (isDanmuOnly?danmuWrite:comment)(' > '+(typeof res=='object'?htmlEscape(JSON.stringify(res)).replace(/"|\\u\d{4}/g, ''):res));
                }
            } catch (e){
                (isDanmuOnly?danmuWrite:comment)(' < '+e);
            }
        }, 0);
    }
    function parseLyrc(s){
        var extra=document.getElementsByClassName('danmu_info')[0].getElementsByClassName('extra')[0];
        if (extra){
            var lyrc=extra.getElementsByClassName('lyrc')[0];
            var bold=';font-weight: bold;';
            if (dInfo.lyrc.n!=0)
                var inner='<span style="font-weight: bold"> - '+s+'</span><span style="float: right">'+dInfo.lyrc.last+'</span>';
            else
                var inner='<span>'+dInfo.lyrc.last+'</span><span style="float: right;font-weight: bold"> - '+s+'</span>';
            dInfo.lyrc={n: (dInfo.lyrc.n+1)%2, last: s};
            if (lyrc)
                lyrc.innerHTML=inner;
            else
                extra.insertAdjacentHTML('afterbegin', '<div class="lyrc">'+inner+'</div>');
        }
    }
    function dedup(s, l){
        s=extract(s);
        if (s)
            for (var j=0;j<l.length;j++){
                var sim=similarity(s, extract(l[j]));
                if (sim>=(dInfo.flow<danmuLimit.line?.3:.2)){
                    if (dup[j]){//[{count: 11, sim: 0.1, content: 'TEST'}, ]
                        dup[j].count++;
                        if (sim<dup[j].sim){
                            dup[j].sim=sim;
                            dup[j].content=s;
                        }
                    } else
			            dup[j]={count: 1, sim: sim, content: s};
                    return true;
                }
            }
        return false;

        function extract(s){
            var start=s.indexOf('<!---->');
            return start>0?s.slice(start+7, s.indexOf('</span>', start)):'';
        }
    }
    function applyDup(){
        var k=Object.keys(dup);
        var tmp=[];
	    for (var i=k.length-1;i>=0;i--){//ordered array
            tmp.splice(dInfo.flow>50&&dup[k[i]].count>9?tmp.length:0, 0, (dup[k[i]]?'<span style="font-size: .64em;">('+dup[k[i]].count+')':'')+'</span>'+s[k[i]]+(dup[k[i]].count>=5?boldSize(' '+dup[k[i]].content, 1.2):''));
            s.splice(k[i], 1);
        }
        if (tmp.length)
            s=isDanmuOnly?s.concat(tmp):tmp.concat(s);
    }
}
function similarity(s1, s2) {
      var longer = s1;
      var shorter = s2;
      if (s1.length < s2.length) {
        longer = s2;
        shorter = s1;
      }
      var longerLength = longer.length;
      if (longerLength == 0) {
        return 1.0;
      }
      return (longerLength - editDistance(longer, shorter)) / parseFloat(longerLength);
    }

    function editDistance(s1, s2) {
      s1 = s1.toLowerCase();
      s2 = s2.toLowerCase();
      var costs = new Array();
      for (var i = 0; i <= s1.length; i++) {
        var lastValue = i;
        for (var j = 0; j <= s2.length; j++) {
          if (i == 0)
            costs[j] = j;
          else {
            if (j > 0) {
              var newValue = costs[j - 1];
              if (s1.charAt(i - 1) != s2.charAt(j - 1))
                newValue = Math.min(Math.min(newValue, lastValue),
                  costs[j]) + 1;
              costs[j - 1] = lastValue;
              lastValue = newValue;
            }
          }
        }
        if (i > 0)
          costs[s2.length] = lastValue;
      }
      return costs[s2.length];
}
function danmuSC(l){
    if (!l)
        return false;
    var old=dInfo.sc;
    dInfo.sc = '';
    var d = getOffsetTime(0, true);
    for (var i = 0; i < l.length; i++){
        l[i][0] = Math.floor((l[i][0] - d) / (60 * 1000));
        if (l[i][0] >= 0)
            dInfo.sc += '<b>￥' + l[i][1] + '</b><small>[+' + l[i][0] + '分]</small> ' + l[i][2] + '<br>';
    }
    if (old!=dInfo.sc)
        danmuStatus();
}
function setDanmuCover(src){
    if (isDanmuOnly&&(!danmu_live_cover.getAttribute("data-roomid")||danmu_live_cover.getAttribute("data-roomid")!=dInfo.roomId.toString())){
        danmu_live_cover.src=src.replace('http:', 'https:');
        danmu_live_cover.setAttribute("data-roomid", dInfo.roomId.toString());
        setTimeout(function wipe(){
            if (!isLiveOff()&&livePlayer._mediaDataSource&&livePlayer._mediaDataSource.hasVideo)
                danmu_live_cover.src='';
        }, 20e3);
    }
}
function danmuTuber(area){
    clearTimeout(danmuTask.tuber);
    if (area==true){
        dInfo.flag.bird=!dInfo.flag.bird;
        danmuWrite(dInfo.flag.bird?'⋛⋋( ‘Θ’)⋌⋚ Bird Launch':' (＋Θ＋)  Bird Back', true);
    } else if (area==false){
        dInfo.flag.bird=true;
        danmuStartTime+=5-danmuStartTime%5;
    }
    if (dInfo.flag.bird||typeof area=='number'){
        danmuTask.tuber=setTimeout(danmuTuber, 15*60e3);
        danmuReq('cors:https://api.live.bilibili.com/room/v3/area/getRoomList?parent_area_id='+(area&&["number", "string"].indexOf(typeof  area)!=-1?area:9)+'&page_size=20', parseRank);
    }

    function parseRank(s){
        s=JsonParse(s);
        if (!dInfo.flag.on||s.code!=0)
            return danmuWrite('HUNT FAILED', true, true);
        var block=[];
        s=s.data.list.filter(function f(n){
            if (liveOption.blockList&&liveBlock.indexOf(parseInt(n.roomid))!=-1){
                block.push(n.uname);
                return false;
            }
            return true;
        });
        for (var i=1;i<s.length&&s<4;i++)
            if (streamer[1].indexOf(parseInt(s[i].roomid))!=-1){
                s.unshift(s.splice(i, 1)[0]);
                break;
            }
        if (area==true)
            danmuStartTime++;
        var i=danmuStartTime%Math.min(5, s.length);
        if (i<s.length&&String(s[i].roomid)!=dInfo.roomId){
            setDanmuCover(s[i].system_cover?s[i].system_cover:s[i].cover);
            danmuWrite(!block.length&&i+1<s.length?'aside with '+s[i+1].uname+'#'+(s[i+1].online/1e4).toFixed(1):'skip '+block.join(', '));
            danmuWrite('ヾ(・Θ・)ノ〃 '+(i?'No.'+(i+1):'Bird')+' Target Locked '+s[i].uname+'#'+s[i].title, true);
            danmuOn(s[i].roomid, true);
            danmuArea='【'+s[i].area_name+(i?'#'+(i+1):block.length?-block.length:'')+'】';
        }
    }
}
function getNanoSecond(){
    return (window.performance.now()/1e3%10).toFixed(6);
}
function danmuReq(roomId, f, fOnBoth, post){
    if (++dInfo.count.retry >= 15){
        danmuOff('<b>(〃>_<;〃) R</b>' + dInfo.count.retry + '>=15 <b>#</b>' + (roomId?roomId:dInfo.roomId));
        return;
    } else if (dInfo.count.retry > 6)
        danmuStatus();
    return httpReq("/blive/" + (roomId ? '?' + roomId : ''), function succ(s){
        dInfo.flag.reconfirm=false;
        if (s.indexOf('[EXCEP]') == -1)
            dInfo.count.retry=0;
        (typeof f=='function'?f:function log(s){console.log(JsonParse(s, true))})(s);
        dInfo.count.req++;
    }, function fail(s, p){
        if (dInfo.xmlReq&&dInfo.xmlReq.isAbort)
            dInfo.xmlReq.isAbort=false;
        else if (dInfo.flag.on){
            if (dInfo.flag.reconfirm=(s.split(':')[0]=='0'))
                danmuStatus();
            s='[local:' + s + '] ' + p;
            console.warn(dateString(), dInfo.count.retry, s);
            danmuWrite(s, false, true);
        }
    }, post, '', fOnBoth);
}
function danmuContent(roomId){
    clearTimeout(danmuTask.content);
    if (dInfo.flag.on){
        // T(total, >1s)=[server wait, .1~15s]+[client js, ~.2s]+[css render, .6~5s]+[sleep till next, y=2x+2, .1~30s]
        var t=(dInfo.pop==1?30e3:dInfo.count.retry>6?15e3:200)*(!isDanmuOnly?2:1)+(!isDanmuOnly?2:0);
        dInfo.xmlReq=danmuReq(roomId, danmuShow, function next(){danmuTask.content = setTimeout(danmuContent, t)});
    }
}
function danmuFullScreen(forceFullScreen){
    if (!isDanmuOnly)
        return;
    try {
        if (!forceFullScreen && (document.fullscreenElement || document.mozFullScreenElement || document.webkitFullScreenElement || document.msFullscreenElement)){
            if (document.exitFullscreen){
                document.exitFullscreen();
            } else if (document.mozCancelFullScreen){
                document.mozCancelFullScreen();
            } else if (document.webkitCancelFullScreen){
                document.webkitCancelFullScreen();
            } else if (document.msCancelFullscreen){
                document.msCancelFullscreen();
            }
        } else {
            if (danmu_fr.requestFullscreen){
                danmu_fr.requestFullscreen();
            } else if (danmu_fr.mozRequestFullScreen){
                danmu_fr.mozRequestFullScreen();
            } else if (danmu_fr.webkitRequestFullScreen){
                danmu_fr.webkitRequestFullScreen();
            } else if (danmu_fr.msRequestFullscreen){
                danmu_fr.msRequestFullscreen();
            }
        }
    } catch (e){
        console.warn('[danmuFullScreen] '+e.message);
    }
}
function setRoomId(s, force){
    if (parseInt(s)){
        if (dInfo.roomId != (dInfo.roomId = s)||force){
            if (dInfo.roomIndex==-1){
                if (!dInfo.flag.bird)
                    dTool.add;
                else
                    streamer[1][-1]=parseInt(dInfo.roomId);
            }
            if (isDanmuOnly&&liveOption.enable)
                liveFromRoom();
            danmuRoomInfo(-1);
        }
    }
}
function fMoney(n){
    if (n<10||n>=1e9)
        return n.toString();
    var f=['拾', '佰', '仟', '万', '拾万', '佰万', '仟万', '亿'];
    for (var i=0;i<8;i++)
        if ((n/=10)<1)
            return "零壹贰叁肆伍陆柒捌玖拾"[Math.floor(n*10)]+f[i-1];
}
function danmuParseStatus(s){
    var status = JsonParse(s);
    if (status){
        var p = parseInt(status.pop);
        if (dInfo.flag.on&&dInfo.roomId&&status.room_id==0&&p<=1)
            dTool.replay;
        else {
            dInfo.purse=status.purse;
            setRoomId(status.room_id);
            danmuSC(status.super_chat);
            setDanmuPop(parseInt(status.que_size) > 5 && p == 1 ? 2 : p);
            dInfo.other_room=status.other_room;
        }
    }
}
function danmuDark(toggle){
    var d=getOffsetDate();
    var on=d.getHours()>=22||d.getHours()<=10;
    if (toggle==true)
        danmu_fr.classList.toggle('dark');
    else if (toggle==undefined){
        if (on)
            danmu_fr.classList.add('dark');
        else
            danmu_fr.classList.remove('dark');
    }
    danmu_info.style.background=dInfo.flow>=10?'linear-gradient(90deg, transparent 10%, rgba(255, 255, 255, '+Math.min(.6, Math.max(.1, dInfo.flow/300))+'), transparent 55%)':'';// .1 ~ .6
}
var dTool={
    get fullscreen(){danmuFullScreen()},
    get audio(){liveFromRoom('', !liveOption.lowPower)},
    get rotate(){danmu_fr.classList.toggle('rotate');setTimeout(scrollAnimation, 3e3)},
    get fade(){danmu.classList.toggle('better_view')},
    get light(){hSwitch(1)},
    get dark(){danmuDark(true)},
    get scrollinput(){danmuScrollInput()},
    get cancelscroll(){danmuScrollInput(true)},
    get replay(){danmuOn(dInfo.roomId, true)},
    get migratory(){danmuTuber(true)},
    get firstbird(){danmuTuber(false)},
    get refresh(){f5('#danmuOnly')},
    get clean(){danmuWrite('<div style="height: 75vh; width: 0;"></div>')},
    get update(){danmuRoomInfo()},
    get loud(){return danmu_live.volume=1},
    get add(){
        if (dInfo.roomIndex==-1){
            if (streamer[0].indexOf('firstroom')==-1)
                streamer[0][streamer[1].length]='firstroom';
            streamer[1].push(parseInt(dInfo.roomId));
            dInfo.roomIndex=streamer[1].indexOf(parseInt(dInfo.roomId));
            return dInfo.roomId;
        }
    },
    get firstroom(){danmuOn('firstroom')},
    toString: function (){return Object.keys(this).join(', ')},
    toJSON: function (){return this.toString()},
};
function danmuStatus(){
    var status = dInfo.count.retry > 6 ? ' ⁉' + dInfo.count.retry : ['OFF', streamerTime[dInfo.roomIndex] ? streamerTime[dInfo.roomIndex] : 'oи' + (dInfo.pop == 9999 ? '☕' : ''), 'ᗯατcᏥ'][dInfo.flag.on];//watch is not used now
    var roomStatus='';
    var extraButton=atag((dInfo.flow>=4?'<sup>'+Math.round(dInfo.flow)+'</sup>':'<b>☾</b>')+(!isLiveOff()&&livePlayer.volume!=undefined?Math.round(livePlayer.volume*10):'')+' ', false, 'Light\nDark')+atag('<b>∞</b>'+(typeof danmuScrollNum=='string'?danmuScrollNum+(danmuScrollCurrentNum!=undefined?danmuScrollCurrentNum:'N'):' '), false, 'ScrollInput\nCancelScroll')+(dInfo.purse>10?'<small>'+fMoney(dInfo.purse)+' +'+dInfo.purseTrend+'</small>':'');
    if (isDanmuOnly){
        for (var i=0;i<streamer[1].length;i++)
            if (dInfo.flag.watch&&streamerTime[i]&&dInfo.roomId!=i)
                roomStatus+=atag(streamerTime[i]+' '+(streamerTitle[i]?streamerTitle[i].slice(0, 15):''), false, streamer[0][i]?streamer[0][i]:streamerTitle[i], 'room', "danmuOn("+streamer[1][i]+")", "danmuOn("+streamer[1][i]+");setTimeout('dTool.audio', 2e3)")+' | ';
        var k=Object.keys(liveOther);
        for (var j=0;j<k.length;j++)
            roomStatus+=atag(liveOther[k[j]], false, k[j], 'room', "danmuOn('"+k[j]+"')", "delete liveOther['"+k[j]+"']")+' | ';
    }
    var dTrends = dInfo.pop < 1e4 ? (dInfo.pop < 1e3 ? String(dInfo.pop):(dInfo.pop / 1e3).toFixed(1) + 'K'):(dInfo.pop / 1e4).toFixed(1) + '万';
    if (dTrends.indexOf('.') != -1){
        dTrends = dTrends.split('.');
        var a = ['sub', 'small', 'sup'][dInfo.popTrend + 1];
        dTrends[1] = '<' + a + '>' + dTrends[1][0] + '</' + a + '>' + dTrends[1].slice(1);
        dTrends = dTrends.join('');
    }
    var signal=Math.round(Math.min(1, streamerTime.filter(function f(s){return s&&s!=''}).length/12)*6);
    signal=new Array(signal+1).join('•')+new Array(6-signal+1).join('◦');
    danmu_info.innerHTML = '<div class="base">'+atag(!dInfo.flag.on ? '热度' : dInfo.flag.on == 2 || !streamerTime.join('') ? '人气' : '<big>' + signal + '</big> ', false, 'FullScreen\nAudio', 'shrink') + atag(dTrends, false, 'Rotate\nFade') + ' ' + (isDanmuOnly?extraButton:'') +(dInfo.flag.reconfirm?atag('点击此处重新确认 Click here to re-confirm', '/blive/?status', '', 'title'):atag((isLiveOff()&&liveOption.enable?'⊖ ':'')+danmuTitle()+danmuArea, 'https://live.bilibili.com/blanc/'+dInfo.roomId, '#'+dInfo.roomId+'\nReplay', 'right title'))+atag(isDanmuOnly?(dInfo.flag.bird?'├⊏⊐■=─ ':'├■■■=─ '):'', false, 'Migratory\nFirstBird', 'right shrink')+ '<b>' + atag(status, false, 'Refresh\nClean', 'right') + '</b></div><div class="extra">' + boldSize(roomStatus + atag('['+dateString('Mdhm')+']', false, 'Update\nFirstRoom'), .8)+ '<br>' + dInfo.sc + '</div>';

    if (isDanmuOnly&&dInfo.flow>=10)
        danmuDark(false);

    function atag(inner, href, title, className, onclick, oncontext){
        if (href)
            onclick=(onclick?onclick:'')+";window.open('"+href+"', '_target');";//+(href?' href="'+href+'" target="_blank"':'')
        if (title){
            if (title.indexOf('\n')!=-1){
                if (!oncontext&&title.split('\n')[1].indexOf('#')==-1)//ignore # start
                    oncontext="dTool."+title.split('\n')[1].toLowerCase();
                if (!href&&!onclick&&title.split('\n')[0].indexOf('#')==-1)
                    onclick="dTool."+title.split('\n')[0].toLowerCase();
            } else if (!href&&!onclick)
                onclick="dTool."+title.toLowerCase();
        }
        return (isOnKindle?'<a':'<a'+(onclick?' onclick="'+onclick+'"':'')+(title?' title="'+title+'"':'')+(oncontext?' oncontextmenu="'+oncontext+';danmuStatus();stopBubble();"':'')) +(className?' class="'+className+'"':'')+' >' + inner + '</a>';
    }
}
function danmuScrollInput(isAlter){
    if (isAlter){
        if (typeof danmuScrollNum=='string')
            danmuScrollNum=(danmuScrollNum.length>1)?danmuScrollNum.slice(0, -1):undefined;
        danmuScrollCurrentNum=undefined;
        return true;
    }
    if (typeof danmuScrollNum!='string'){
        danmuScrollNum='';
    } else {
        if (danmuScrollCurrentNum!=undefined){
            danmuScrollNum+=String(danmuScrollCurrentNum);
            danmuScrollCurrentNum=undefined;
        } else {
            danmuOn(danmuScrollNum);
            danmuScrollNum=undefined;
        }
    }
    danmuStatus();
}
function danmuRoomInfo(n){//parseH5 to get all uids (lots of requests) -> use parseUids in new api (1 request)
    var guardCount=0;
    var isRoomChange=(n==-1);
    clearTimeout(danmuTask.info);
    if (dInfo.flag.on&&streamer[1].length){
        if (!isUidValid()){
            //danmuWrite('warm up');
            danmuReq("cors:https://api.live.bilibili.com/xlive/web-room/v1/index/getH5InfoByRoom?room_id=" + (isRoomChange?dInfo.roomId:streamer[1][n==undefined?n=0:n]), parseH5);
            danmuTask.info = setTimeout('danmuRoomInfo(' + ((n+1)%streamer[1].length) + ')', dInfo.pop == 1 || n==streamer[1].length-1 || dInfo.count.retry > 6 ? 3*60e3 : 1e3);
        } else {
            if (dInfo.roomIndex==-1)
                danmuReq("cors:https://api.live.bilibili.com/xlive/web-room/v1/index/getH5InfoByRoom?room_id=" + dInfo.roomId, parseH5);
            else
                sendUids();
            danmuTask.info = setTimeout(danmuRoomInfo, 2*60e3);
        }
    }

    function sendUids(){
        danmuReq("cors:https://api.live.bilibili.com/room/v1/Room/get_status_info_by_uids", parseUids, '', JSON.stringify({uids: streamerUid.concat(streamerUid[-1]?streamerUid[-1]:undefined)}));
    }
    function isUidValid(){
        if (streamerUid.length==streamer[1].length){
            for (var i=0;i<streamer[1].length;i++)
                if (!streamerUid[i])
                    return false;
        } else
            return false;
        return true;
    }
    function parseUids(s){//like h5, but all in one
        var stat = JsonParse(s);
        if (stat.code == 0){
            var data=stat.data;
            var keys=Object.keys(data);
            var i=-1;
            var isUpdated=false;
            for (var j=0; j<keys.length; j++){
                i=streamerUid.indexOf(parseInt(keys[j]));
                var old=streamerTime[i];
                streamerTime[i] = data[keys[j]].live_status?timeHuman(data[keys[j]].live_time):'';
                isUpdated=(!!old!=!!streamerTime[i])||isUpdated;
                danmuTitle(data[keys[j]].uname.slice(0, 6) + data[keys[j]].title, i);
                if (isRoomChange&&dInfo.roomIndex==i){
                    setDanmuCover(data[keys[j]].keyframe?data[keys[j]].keyframe:data[keys[j]].cover_from_user?data[keys[j]].cover_from_user:data[keys[j]].face);
                    parseLastDanmu(data[keys[j]].room_id);
                    if (isDanmuOnly&&data[keys[j]].live_status)
                        parseOnlineGuard(data[keys[j]].uid, data[keys[j]].room_id);
                }
            }
            if (isUpdated)
                danmuStatus();
        } else
            streamerUid=[];
    }
    function parseH5(s){//-> time, title, area, cover (-> lastDanmu -> 5*onlineGuard)
        var stat = JsonParse(s);
        if (stat.code == 0){
            var data = stat.data;
            streamerUid[n]=data.room_info.uid;
            streamerTime[n] = data.room_info.live_status?timeHuman(data.room_info.live_start_time):'';
            danmuTitle(data.anchor_info.base_info.uname.slice(0, 6) + data.room_info.title, n);
            if (isRoomChange){
                setDanmuCover(data.room_info.cover?data.room_info.cover:data.anchor_info.base_info.face);
                if (!dInfo.flag.bird)
                    danmuArea='【'+data.room_info.area_name+'】';
                parseLastDanmu(data.room_info.room_id);
                if (isDanmuOnly&&data.room_info.live_status)
                    parseOnlineGuard(data.room_info.uid, data.room_info.room_id);
            }
            danmuStatus();
        } else if (stat.code == -502)
            comment(stat.excep);
        else
            danmuReq("cors:https://api.live.bilibili.com/room/v1/Room/room_init?id=" + (isRoomChange?dInfo.roomId:streamer[1][n]), parseTime);
    }
    function parseTime(s){//-> time:'101m' -> title (-> lastDanmu -> 5*onlineGuard)
        var stat = JsonParse(s);
        if (stat.code == 0){
            var data = stat.data;
            if (streamerTime[n] != (streamerTime[n] = timeHuman(data.live_time))&&streamerTime[n])
                parseTitle(data.uid);
            if (isRoomChange){
                parseLastDanmu(data.room_id);
                if (isDanmuOnly)
                    parseOnlineGuard(data.room_info.uid, data.room_info.room_id);
            }
        }
    }
    function parseTitle(u){
        danmuReq("cors:https://api.bilibili.com/x/space/acc/info?mid=" + u, function a(s){
            var stat = JsonParse(s);
            if (stat.code == 0&&stat.data.live_room){
                if (isRoomChange)
                    setDanmuCover(stat.data.live_room.cover?stat.data.live_room.cover:stat.data.face);
                danmuTitle(stat.data.name.slice(0, 6) + stat.data.live_room.title, n);
                danmuStatus();
            }
        });
    }
    function parseLastDanmu(u){
        danmuReq("cors:https://api.live.bilibili.com/xlive/web-room/v1/dM/gethistory?roomid=" + u, function history(s){
            var stat = JsonParse(s);
            if (stat.code == 0&&stat.data.room){
                s=stat.data.room;
                var l=[];
                if (isOnKindle)
                    s=s.slice(-5);
                for (var i=0;i<s.length;i++)
                    l.push('<span style="font-size: .64em"> '+(!i||i==s.length-1&&s[i].check_info.ts?'<small>'+dateString(s[i].check_info.ts*1e3)+' </small>':'*')+s[i].nickname+'</span> '+boldSize(s[i].text, 1.2));
                if (isDanmuOnly){
                    danmuWrite(l.join('<br>'));
                    setTimeout(scrollAnimation, 3e3);
                } else
                    tasks(function act(e){danmuWrite(e)}, l, !isOnKindle?100:1e3);//render speed limit
            }
        });
    }
    function parseOnlineGuard(u, r, n){
        if (n==undefined)
            n=1;
        if (n==1)
            clearTimeout(danmuTask.guard);
        danmuReq("cors:https://api.live.bilibili.com/xlive/app-room/v2/guardTab/topList?ruid="+u+"&roomid="+r+"&page="+n+"&pageSize=29", function a(s){
            var stat = JsonParse(s);
            if (stat.code==0){
                var l=stat.data.list;
                if (stat.data.info.now==1){
                    l=stat.data.top3.concat(l);
                    if (stat.data.info.num>=10)
                        danmuArea='<small>×'+stat.data.info.num+'</small>';
                }
                for (var i=0;i<l.length;i++)
                    if (l[i].is_alive){
                        guardCount++;
                        danmuArea+=' <img style="vertical-align: text-top; height: 1.1em; border-radius: 1em" src="'+l[i].face.replace('http:', 'https:')+'" title="'+l[i].username+'">';
                    }
                if (guardCount<20&&++n<=10&&n>=1&&stat.data.info.now<stat.data.info.page&&dInfo.flag.on)
                    danmuTask.guard=setTimeout(function (){parseOnlineGuard(u, r, n)});
                else
                    danmuStatus();
            }
        });
    }
}
function timeHuman(t){
    if (t>0){
        t=getOffsetTime(0, true) / 1000 - t;
        if (t<5*3600)
            return Math.floor(t / 60) + 'm';
        else
            return Math.floor(t / 60 / 60) + 'h';
    } else
        return '';
}
function boldSize(s, size){
    return '<span style="font-weight: bold; font-size: '+(size?size:.8)+'em">'+s+'</span>';
}
function liveInfo(title, detail, forceLog, bgColor){
    if (detail==undefined)
        detail='';
    danmuGC(danmu_live_info, danmuLimit.max);
    danmu_live_info.insertAdjacentHTML('afterbegin', boldSize('['+dateString()+'@'+title+'] '+detail, forceLog?1:.64)+(forceLog?'<br>':''));
    var res=' > ['+title+'] '+detail;
    var s=dateString('dhm')+res;
    if (forTestUse||forceLog){
        if (bgColor)
            console.log('%c'+s, 'color: white; background: '+bgColor);
        else
            console.log(s);
    }
    return res;
}
function isLiveOff(){
    return livePlayer==undefined;
}
function liveFromOther(url){
    // credit: real-url@github
    var methods={
        huya: function(room){
            danmuReq('cors:https://www.huya.com/'+room, function parseStreamInfo(s){
                var m=s.match(/"stream"\s*:\s*"(\S+)"/);
                if (m){
                    try {
                        var res=JsonParse(atob(m[1])).data[0].gameStreamInfoList;
                        var url='';
                        for (var i=0;i<res.length;i++)
                            if (res[i].sCdnType=='BD'||(!url&&i==res.length-1))// 0占位, 1占位, 2占位, 3流畅, 4 超清 or 4M, 5 10M
                                url=res[i].sFlvUrl.replace('http:', 'https:')+"/"+res[i].sStreamName+['_500', '_500', '_500', '_500', '_4000', '_10000'][liveOption.quality]+"."+res[i].sFlvUrlSuffix+"?"+ res[i].sFlvAntiCode.replace(/&amp;/g, '&');
                    } catch (e){
                        return comment(e);
                    }
                    liveFromRoom(url);
                    if (m=s.match(/"host-name".*?>(.*)</i)) danmuArea=m[1];
                    if (m=s.match(/"host-title".*?>(.*)</i)) danmuArea+=m[1];
                    liveOther['huya.com/'+room]=danmuArea;
                    if (m=s.match(/"startTime"\s*:\s*(\d+),/i)) danmuArea+=' <small>'+timeHuman(parseInt(m[1]))+'</small>';
                    if (m=s.match(/"live-count".*?>(.*)</i)) dInfo.pop=m[1].replace(',', '');
                    danmuArea=' | '+danmuArea;
                } else
                    comment('huyaLoadFailed');
            });
        },
        cc: function(room){
            danmuReq('cors:https://api.cc.163.com/v1/activitylives/anchor/lives?anchor_ccid='+room, function parseStreamInfo(s){
                s=JsonParse(s);
                if (s.code=='OK'){
                    var k=Object.keys(s.data);
                    if (k.length){
                        var channel_id=s.data[k[0]]['channel_id'];
                        danmuReq('cors:https://cc.163.com/live/channel/?channelids='+channel_id, function parseStreamInfo(s){
                            s=JsonParse(s).data[0];
                            var url=s.sharefile;
                            liveFromRoom(url);
                            danmuArea=s.nickname+s.title;
                            liveOther['cc.163.com/'+room]=danmuArea;
                            danmuArea=' | '+danmuArea+' <small>+'+s.hot_score+'</small>';
                        });
                    }
                }
            });
        },
    };
    var m=String(url).toLowerCase().match(/(huya|cc).*?\.com\/(\d+)/);
    if (m){
        var platform=m[1];
        var room=m[2];
        if (methods[platform]){
            danmuWrite(liveInfo('Live'+':q'+liveOption.quality+':'+platform+room, 'Start'), true, true, true);
            methods[platform](room);
            return setTimeout(danmuStatus, 1e3);
        }
    }
    danmuWrite(liveInfo('Live:Failed:'+s, 'Start'), true, true, true);
}
function liveFromRoom(url, audioOnly){
    if (!dInfo.flag.on)
        return comment('liveIsOff');
    var rnd=Math.floor(Math.random()*4);
    var durl=url&&typeof url=='string'?[{url: url}]:[];
    dInfo.count.live=0;
    clearTimeout(danmuTask.liveRetry);
    if (durl.length)
        return liveFromUrl();
    liveInfo('Load'+(audioOnly?'A:':':')+dInfo.roomId, 'get url', true, 'SeaGreen');// 2 80, 3 150, (250), (400), 4 10000
    danmuReq('cors:https://api.live.bilibili.com/room/v1/Room/playUrl?cid='+dInfo.roomId+'&platform=web&otype=json&quality='+liveOption.quality, function parse(s){
        s=JsonParse(s);
        if (typeof s.data!="undefined"&&s.data.durl){
            durl=s.data.durl;// true XOR n == not n, not not n != true
            audioOnly=!!(audioOnly||(liveOption.quality<4&&s.data.current_qn==10000&&liveOption.lowPower))!=!!(audioOnly==false);
            danmuWrite(liveInfo('Live'+(audioOnly?'A':'')+':qn'+s.data.current_qn+'/'+durl.length, 'Start'), true, true, true);
            liveFromUrl();
        }
    });

    function liveFromUrl(){
        if (!dInfo.flag.on)
            return liveInfo('Quit:On'+dInfo.flag.on+':Live'+liveOption.enable, 'danmu is off', true);
        if (!durl||!durl.length)
            return liveInfo('Quit:'+dInfo.count.live, 'Require dUrl', true);
        liveOff(true, 'getLock', 'DimGray', true);
        livePlayer = mpegts.createPlayer({
            type: 'flv', // mse, mpegts, m2ts, flv
            isLive: true,
            url: durl[(dInfo.count.live+rnd)%durl.length].url,
            hasVideo: !audioOnly,
        }, {
            enableWorker: true,// avoid requests cause danmuContent delay
            liveBufferLatencyChasing: true,
            liveBufferLatencyMaxLatency: 10,
            liveBufferLatencyMinRemain: .5,
            lazyLoad: false,
        });
        livePlayer.on(mpegts.Events.ERROR, function c(errType, errDetail){
            clearTimeout(danmuTask.liveRetry);
            if (++dInfo.count.live<5){// errDetail=="HttpStatusCodeInvalid"
                if (dInfo.count.live>2)
                    liveInfo('Reload:'+dInfo.count.live+':'+errType, errDetail, true, 'burlywood');
                danmuTask.liveRetry=setTimeout(liveFromUrl, Math.pow(dInfo.count.live, 2)*1e3);
            } else {
                liveInfo('Quit:'+dInfo.count.live+':'+errType, errDetail);
                liveOff(false, dInfo.count.live+':'+errDetail);
            }
        });
        livePlayer.attachMediaElement(danmu_live);
        mpegts.LoggingControl.enableAll=false;
        if (forTestUse){
            mpegts.LoggingControl.enableError=true;// only on http code error, useless
            mpegts.LoggingControl.enableWarn=true;// too many audio frame correction warns
        }
        livePlayer.load();
        livePlayer.volume=!url&&liveVol[dInfo.roomIndex]!=undefined?liveVol[dInfo.roomIndex]:liveDefaultVol;
        livePlayer.muted=false;
        danmu_live.playbackRate=1;
        livePlayer.play();
        danmu_live.style.opacity='1';
    }
}
function liveChangeVolume(value){
    if (livePlayer&&typeof livePlayer.volume=='number'){
        value=Math.floor(value*10);
        var oldv=Math.floor(livePlayer.volume*10);
        var newv=Math.floor(oldv+value);
        newv=newv>10?10:newv<0?0:newv;
        livePlayer.volume=newv/10;
        return newv;
    }
}
function liveOff(getLock, s, bgColor, notLog){
    if (livePlayer&&livePlayer.destroy){
        livePlayer.destroy();
        liveInfo('Ended:'+(s?s:'onendedEvent'), '', !notLog, bgColor?bgColor:'pink');
    }
    livePlayer=getLock?{}:undefined;
    danmu_live.style.opacity='0';
    setTimeout(function clearInfo(){
        if (!livePlayer)
            danmu_live_info.opacity='0';
    }, 10*60e3);
}


/*               HOME: for Hue
http://philips-hue/debug/clip.html
https://developers.meethue.com/develop/get-started-2/

location /hue/ {
    proxy_redirect off;
    proxy_buffering off;
    proxy_http_version 1.1;
    proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
    proxy_set_header Upgrade $http_upgrade;
    proxy_set_header Connection $http_connection;
    add_header Access-Control-Allow-Methods *;
    add_header Access-Control-Allow-Credentials true;
    add_header Access-Control-Allow-Origin $http_origin;
    if ($request_method = OPTIONS){
    return 200;
    }
    access_log off;
    proxy_pass https://philips-hue/api/;
}
*/
var home = document.getElementsByClassName('home')[0];
var hueUser = {devicetype: 'A 3-switch kindle-based controller.'};
var switchs = {};//{1:{on:false, name:"Somelight", reachable:true}}
var hLast = 0;
var hPreventNetworkError=hueBaseUrl!='/hue/';
function hHelp(){
    hFail('1. Press the Hue Link button 2. Run hReg() 3. Change the hueToken in this page file');
    alert('hueToken in *Basic Settings* is invalid');
}
function hCollect(f){
    if (!hueToken){
        hHelp();
        return;
    }
    hLast = new Date().getTime();
    httpReq(hueBaseUrl + hueToken + '/lights/', function hParse(s){
        var s = JsonParse(s);
        if (Array.isArray(s)){
            comment(JSON.stringify(s[0]));
            hueToken = '';
        } else {
            switchs = {};
            for (var i in s)
                switchs[i] = {on: s[i].state.on, name: s[i].name, reachable: s[i].state.reachable};
            if (typeof f == "function")
                f();
            else
                hUpdate();
        }
    }, hFail);
}
function hFail(s){
    console.warn(s);
    comment('<a href="'+hueBaseUrl+hueToken+'">'+s+'</a>');
}
function hReg(){
    httpReq(hueBaseUrl, function hParse(s){
        var s = JsonParse(s)[0];
        if ("success" in s)
            hueToken = s.success.username;
        else
            comment(JSON.stringify(s));
    }, hFail, JSON.stringify(hueUser));
}
function hSwitch(n){
    if (!hueToken){
        hHelp();
        return;
    }
    var butt = document.getElementsByClassName('hs' + n)[0];
    if (butt)
        butt.style.background = "rgba(128,128,128,.2)";
    if (hPreventNetworkError && hLast && new Date().getTime() - hLast > 3 * 3600 * 1000 && !isHomeShrink)
        f5('#hSwitch(' + n + ')');
    else
        hCollect(function hChange(){
            httpReq(hueBaseUrl + hueToken + '/lights/' + n + '/state/', function hParse(s){
                var s = JsonParse(s)[0];
                if ("success" in s)
                    hCollect();
                else
                    comment(JSON.stringify(s));
            }, hFail, JSON.stringify({on: !switchs[n].on, bri: 254, ct: 180}), 'PUT', isFastLoad&&!isDanmuOnly?window.close:undefined);
        });
    stopBubble();
}
function hUpdate(){
    var l = Object.keys(switchs).length;
    if (!hueToken)
        hHelp();
    else if (!l)
        hCollect();
    else {
        home.innerHTML = '';
        if (l>=3)
            home.classList.add('more');
        else
            home.classList.remove('more');
        for (var i in switchs){
            var hs = document.createElement('div');
            var sdcolor=(switchs[i].on ? "black" : "white");
            hs.setAttribute('class', 'h_switch hs' + i);
            hs.setAttribute('onclick', 'hSwitch(' + i + ')');
            hs.appendChild(document.createTextNode(switchs[i].name));
            home.appendChild(hs);
            hs.style.cssText = (switchs[i].reachable ? "" : "border-color: gray;")
                + "width: " + (switchs[i].reachable ? "12rem;" : "8rem;")
                + (isHomeShrink || (toStatus && toStatus != 'stop') ? "height: 8rem;" : "")
                + (switchs[i].on ? "background: rgba(255,255,255, .2);" : "")
                + (switchs[i].on ? "" : "color: black;")
                + "text-shadow: 4px 4px 0 "+sdcolor+", -4px -4px 0 "+sdcolor+", -4px 4px 0 "+sdcolor+", 4px -4px 0 "+sdcolor;
        }
        if (!isOnKindle)
            home.innerHTML += "<div class='h_switch' " + (isHomeShrink ? "style='height:8rem'" : "") + " onclick=\"location.hash='#hSwitch(1)#fastload'\">Star</div>";
    }
}
var loaded = true;
  </script>
</body>
</html>
