<!DOCTYPE html>
<html lang="zh-CN">
<head>
  <meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
  <meta name="viewport" content="width=device-width,initial-scale=1.0,maximum-scale=1.0, user-scalable=0">
  <script type="text/javascript">
    var testStatus=false;
    var testInterval=0;
    var info={
      version: '1.5',
      description: '(bug-fix changes are in commit logs)',
      author: 'wmillers@github',
      license: 'LGPL2.1'
    }
  </script>
  <title>tomatoClock</title>
  <link id='ico' href="" rel="icon" type="image/x-icon" />

	<style>
    table {
      border-spacing: 0;
    }
    .cleaner {
      background: black;
      color: white;
      position: fixed;
      width: 100%;
      height: 100%;
      display: block;
      z-index: 20;
      top: 0;
      left: 0;
    }
    .app {
      margin-top: 3rem;
      padding-top: 2rem;
      margin-left: -1.5rem;
      height: 46rem;
      width: 44rem;
      font-family: Arial,sans-serif;
      text-align: center;
      overflow: hidden;
    }
    .rotate {
      transform:rotate(270deg);
      -webkit-transform:rotate(270deg);
    }
    .tickList {
      position: absolute;
      font-size: .5rem;
      left: -3rem;
      text-align: left;
      z-index: 2;
      white-space: pre-wrap;
      overflow: hidden;
      text-shadow: 2px 2px 0 white, -2px -2px 0 white;
    }
    .tl_to {
      display:inline;
      margin-left:-1.5rem;
      position:absolute;
    }
    .tl_co {
      text-align:right;
      font-size:1.5rem;
    }
    .tl_sude {
      display: block;
      padding: 0;
      word-break: break-all;
    }
    .tl_su {
      font-size: 1.5rem;
      padding: .16rem 0;
      float: left;
    }
    .danmu_fr {
      position: absolute;
      font-size: 1rem;
      margin-top: 14rem;
      margin-left: 1rem;
      text-align: left;
      height: 15rem;
      width: 18rem;
      overflow: hidden;
      z-index: 1;
      word-break: break-all;
      white-space: pre-wrap;
    }
    .danmu_info{
      display: block;
      font-size: .6rem;
    }
    .time {
      font-size: 16rem;
      font-variant-numeric: tabular-nums;
      font-weight: 900;
    }
    .tomato {
      font-size: 2rem;
      font-weight: bold;
    }
    .date {
      font-size: 2rem;
      font-weight: bold;
    }
    .weath {
      margin-top: 1rem;
      margin-left: -2rem;
      width: 22.5rem;
      height: 2.8rem;
      display: block;
      -webkit-transform: scale(2.6);
      transform: scale(2.6);
      -webkit-transform-origin: 0 0;
      transform-origin: 0 0;
    }
    .basket{
      margin-top: 6rem;
      font-size: 1rem;
      overflow: hidden;
      word-break: break-all;
      height: 2rem;
    }
    .tImg{
      content: url('data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAOUAAADUAgMAAAAegQyNAAAACVBMVEUAAAD///8AAABzxoNxAAAAAXRSTlMAQObYZgAABZ9JREFUaN7VmsuRnDAQQJnDhEA++OA7rlJzIATywRngKojS1jCtZ02PrEbrT1mH3UWrR//0o6WuXG4iMnRNpf+BhjZUYmki7yKtGvcPdGzUt9HYm5ylzVSMvWzqdKwYe83U5dgx9hp6HAfGXvLS/ANdG4y9R32PY2swtn/oG40dW0yNpcFPMTTHaWyTl6KxLeii6HCt636Opp5+0uLuuooe+lgX3mvLKUcdQZJXdNWK4Byl6uDoJy1uUxeDDnVTQb9lLh6voKsbpf+tZ2wivz/NrqLqnnWKAh8PWlNF1T2x/fagvqq7fKi21uD60IOyfgSVVlQ+hC5t6P7P0BmfNaLbvIkL3aY03GaGuwtdHwToJn40rTcyMexk8KFTQpmdOh+qvybmxOBF54RuTBIVdEnMKl9EmIgHD3rOTbtElNK5UC2fxMUyN+0FNFTn0hQMisNR9wLj8JRUSvAL9YvN1uSfidQvQlEo6ypdN/S6cPxCrEDCsl7+QuxN0BYWdC+L7bVVzlK5FWPLLoCSUN5UchIQMxvoXtC4fxGKklixvtcYoVlRFLHWv5lQuwQgdjCmGqG0nnnRO43pDW/EZi8Kb/TFG7ZT/ey2sr57CiatebQa98mivbDTW0oa8z8lzwpQ4cmYetDQdntCl8KDqVNqR3lnwYqxualrhk6K8mS+t3IJaD2rCYjVj0tMnbIYonJEQ4fY14/Lu+qbNsKIjajuk/nyAY0AW4CIDr2KXSN6srMxNtYnfY8nejZmwcBtmbFUypJQ2DHNIsursTdUmQ7QDpRpJH1JgzI0QW8sF8+n6dVPdzQ5QFmE8Igs+iVN3fNtMygLQnidg6jiC4VRGdGnWESINjQoc8OerMFU5oMoI/fSzminvZ2FMj/dtIIBalAGWKbUPamhhtq5i76Oi3EwOQG8WsgbgKqXFoSOlqMpLk67XoSWFv67osIOjQ84OlARja/HwezaazsV7cWKYupaIlWMdhl9EyjkL9CDMYyXNgx1oRNeWisb0GTWSKw29mSdBw0nOquDWbUr6Hai8kQX1jEHKqCPunq2ss9RwsoKWEbnZ2BTj9j1p3ROdHigOs5ZE2roYVAm52vo7Eka3hM6amdaH6hIcKJrhgqmXkH5XPyjKFmK6DPQzo2GB8oGJ7SjYzs6XEQXtlWdF91f0dGPRjECGrq/jU4xtC1onJk2D9qzo06pk/iiNnT6EHr8cXT5v1ABNcH5m2is2RpR+rAzMQrqHDk3i64fRcd2dGhEnSN9eouGdnRsR7vr6EKO3DHSfyO6OQ8t5WMo83B/DV0a0ZtBGea+fgg6u9G7gIYG1G4IBldYJ4MeDShbrtEd1nbUbi9Hb1gtGq6ibKWDNzYWFfe9AruBH/yxAV2cfcLkPBQdffcKcnSuBZYEEShxdkSnB41e5SO07uIs1xvwWzU6JBvR8a7oUDV1NqjU74+QBzYZgupHGXlgUFIaUr8DlIeVRAoo1g32XACU9A3taC0IxVTCQerKqBjreM2RoQTW+olPH5KtxEbfXsiPJ7G9YCpSSMuZJLeKJbFMbF7vIwUrVCScf6EvbiEFicYINScIBAMXc3yBdWueyAc16Vaq7s/WRuizoUnyktDU1psVioPxUzQ2kAHXkPF35iVQ1fgz5GyOZEBNGh0MQZC5g23y/kUoaWPjJXtkgFBb8BIoKTMTDAqmgjJjGXVNIZ9lDmWqJPksexS0HHvZTiYxsyasyHOZirEI9JjKJOsqNtVINOr6SuFg0aFvsMeZXn3HwiGqQ9/Be3RLYSYxxnrECqZmxs4OJ2FqPnl6hIr3SN4KDa6LAFao1ZfFrOpecV56sDGV4LtqYdWlP1ixpRtk5YMeHAUr7x7HX11m4cySRyat9is0Y9vFncpJT9u9HZxsiytn3aYuLFJ6LwlLUz+Jr0YeCx76DsxC7gxsfZb3AAAAAElFTkSuQmCC');
      height: 2rem;
      width: auto;
    }
    .inform {
      margin-top: 0.5rem;
      font-size: 1.5rem;
      font-weight: normal;
    }
    .reminder {
      display: none;
      margin: -25rem 10rem; 
      padding: 1rem;
      max-height: 21rem;
      width: 22rem;
      position: absolute;
      border: dotted;
      background-color: rgba(255, 255, 255, 0.8);
      font-size: 1.5rem;
      font-weight: bold;
      overflow: scroll;
      z-index: 3;
    }
  </style>
</head>
<body>
  <div class="cleaner" id="cleaner"><noscript>Javascript NOT support.</noscript></div>
  <div class="app"><div class="rotate">
    <div class='tickList' id='tickList' onclick="showIcs()"><div></div><img id="tickImg" class="tImg" style="padding:1rem"><table></table></div>
    <div style='height:6rem;'></div>
    <div class='danmu_fr' id='danmu_frame' onclick="danmuSwitch()"><span class='danmu_info' id='danmu_info'></span><span id='danmu'></span></div>
    <div class="time" id="time"><span id="hour" onclick="switchTomato()">00:</span><span id="minute" onclick="pauseTomato()">00</span></div>
    <div class="tomato"><span id="tom" onclick="comment(runTime())">TOMA</span><span id="ato" onclick="initDateFromServer()">MATO</span></div>
    <div class="date" id="allDate" onclick="correctPrompt()"><span id="date">0月0日</span> <span id="week">星期零</span></div>
    <iframe class='weath' id="ifrmid" scrolling="no" frameborder="0" allowtransparency="true" src="//i.tianqi.com/index.php?c=code&id=2&bdc=%23&icon=5&num=3&site=15" sandbox="allow-scripts" style="pointer-events: none;"></iframe>
    <div class='basket' id="basket"></div>
    <div class="inform" id="inform" onclick="fridgeTomato();onlineWeather();">同步时间：<span id="sync">0000-00-00 00:00:00</span> <span id="timeoffset">+0s</span> <span id="net">未同步零</span></div>
    <div class='reminder' id='reminder' onclick="displayReminder(false)"></div>
  </div></div>
  <script type="text/javascript">setTimeout('if (!isEnd) document.getElementById("cleaner").innerHTML="JS FAILED on loading"',800)</script>
  <script type="text/javascript">
    if (testStatus){testInterval=setInterval('comment(how(), true)', 7*1000);setTimeout('testIcs()', 10*1000);}
    var initialTitle=document.title;
    var clearCommentTime=0;
    function comment(s, isJam){
      var basket=document.getElementById('basket');
      var lag=30*60*1000;
      s=s==undefined?'und':String(s);
      setTimeout("clearComment()", lag+1000);
      if (basket.innerHTML.length==0||isJam)
        basket.innerHTML=s;
      else {
        basket.innerHTML+='|';
        if (s.length>100){
          basket.innerHTML+=s;
          while (basket.scrollHeight>basket.clientHeight*1.25)
            basket.innerHTML=basket.innerHTML.slice(1);
        } else
          for (var i=0;i<s.length;i++){
            basket.innerHTML+=s[i];
            if (basket.scrollHeight>basket.clientHeight*1.25)
              basket.innerHTML=basket.innerHTML.slice(-Math.floor(basket.innerHTML.length/2));
        }
      }
      clearCommentTime=new Date().getTime()+lag;
      return s;
    }
    function clearComment(){
      if (new Date().getTime()<clearCommentTime) return;
      document.getElementById('basket').innerHTML='';
    }
    function httpGet(path, f, fOnfailed){
      var xmlhttp = new XMLHttpRequest();
      xmlhttp.onreadystatechange = function(){
        if (xmlhttp.readyState == 4){
          if(xmlhttp.status == 200){
            if (f)
              f(xmlhttp.responseText);
          } else if (fOnfailed)
            fOnfailed(xmlhttp.status);
        }
      }
      xmlhttp.open('GET', path);
      xmlhttp.send();
    }
      

    /*Basic Date and Weather updater*/
    var refreshRate=8*3600*1000;
    var hardwareLagRate=6.66;//+1s/6.66h
    var lastSyncTime;
    var timeOffset=0;
    var preventDecreaseShadow=false;//Stop when tomato
    var lessDisturbUpdateWhenTomato=false;//less time update flash when tomato
    var cleaner=[document.getElementById('cleaner').style, document.getElementById('time').style];
    var clock=[document.getElementById("hour"), document.getElementById("minute"), document.getElementById("date"), document.getElementById("week")];
    var initTime=new Date().getTime();
    var initTimeOffset=0;
    var averageTimeOffset=[];
    var hasClockInit=false;
    var networkFaliure=false;
    var nextCmdList=0;
    var cmdListCount=0;
    var cmdList={};
    var weatherTaskIndex=0;
    var tickListAlarm='';
    initDateFromServer();
    adjustAgainstHardwareTimeLag();//extra offset cycle
    initBrowserPage();
    setTimeout("initClockWeather()", 1000);//if server not responsed in 1s, use local time instead

    function adjustAgainstHardwareTimeLag(lag){
      if (lag==undefined||lag<hardwareLagRate*3600*1000) lag=hardwareLagRate*3600*1000;//add 1s offset every xxx hour
      if (hasClockInit) timeOffset+=1000;
      setTimeout("adjustAgainstHardwareTimeLag("+lag+")", lag);
    }
    function initDateFromServer(){
      httpGet('/blive/?time', function s(a){averageTimeOffset.push(parseInt(a)-new Date().getTime());sumDateFromServer(true)});//oneTimeDateByBlive
      setTimeout('if (!timeOffset) sumDateFromServer()', 500);//alternative
    }
    function sumDateFromServer(calculate){
      if (calculate){
        if (!averageTimeOffset.length) return false;
        var oldHardwareLagRate=hardwareLagRate;
        var dOffsetPerSecond="";
        var dTimeOffset=0;
        var sum=0;
        for (var i in averageTimeOffset)
          sum+=averageTimeOffset[i];
        timeOffset=Math.floor(sum/averageTimeOffset.length);
        if (!initTimeOffset && timeOffset) initTimeOffset=timeOffset;
        if (initTimeOffset){
          var uptime=new Date().getTime()-initTime;
          if (Math.abs(timeOffset-initTimeOffset)>200){
            dTimeOffset=timeOffset-initTimeOffset;
            if (uptime>3600*1000){
              var newHardwareLagRate=Math.floor((uptime/1000/3600)/(dTimeOffset/1000)*100)/100;
              dOffsetPerSecond="1s/"+newHardwareLagRate+"h"+"("+oldHardwareLagRate+")";
              if (uptime>3*24*3600*1000) hardwareLagRate=newHardwareLagRate;
            }
          }
        }
        dTimeOffset=dTimeOffset?"("+timeFormat(dTimeOffset)+")":"";
        console.log(comment(timeOffsetFormat(2)+dTimeOffset+"#"+dOffsetPerSecond+"#"+timeFormat(uptime, 3, true)+""));
        document.getElementById('timeoffset').innerHTML=timeOffsetFormat();
        averageTimeOffset=[];
        return true;
      } else {
        averageTimeOffset=[];
        singleDateFromServer(20);
      }
    }
    function singleDateFromServer(n){
      xmlhttp = new XMLHttpRequest();
      xmlhttp.open("HEAD", noCache(), true);
      xmlhttp.onreadystatechange=function(){
        if (xmlhttp.readyState==4){
          if (networkFaliure){
            networkFaliure=false;
            return;
          }
          if (n>0)
            setTimeout('singleDateFromServer('+(--n)+')', 100);
          else {
            sumDateFromServer(true);
            return;
          }
          if (xmlhttp.status!=0){
            var serverTime=new Date(xmlhttp.getResponseHeader("Date")).getTime();
            var clientTime=new Date().getTime();
            timeOffset=serverTime-clientTime+2300;//preset lag==>+1s(screen refresh time)
            averageTimeOffset.push(timeOffset);
            console.log(frontZero(n+1)+"#"+Math.floor(serverTime/1e5)+":S"+serverTime%1e5/1000+".:C"+clientTime%1e5/1000+":"+timeOffsetFormat());
            comment("Calculating..."+timeOffsetFormat(3), true);
            //initClockWeather();//immediately after date time got from server
          } else {
            networkFaliure=true;
            comment("Failed(ServerTime)#1s/"+hardwareLagRate+"h("+timeOffsetFormat(3)+")");
          }
        }
      }
      xmlhttp.send(null);
    }
    function addTaskOnPageChange(cmd, interval, isTimeout){
      var t=getOffsetTime(interval);
      var tag=cmd;
      if (isTimeout) interval=true;
      if (cmdList[cmd]!=undefined)
        cmdList[cmd]=[cmdList[cmd][0], interval, t];
      else {
        tag=cmd.slice(0,4)+frontZero(++cmdListCount, 3);
        cmdList[tag]=[cmd, interval, t];
      }
      refreshTaskOnPageChange();
      return tag;
    }
    function runTaskOnPageChange(){
      //nextCmdList=1500, cmdList={tag0:['f()', interval, end], tag1:['f()', 86400*1000, 15000000], tag2:['',true,1500]};
      var t=getOffsetTime();
      if (nextCmdList-59*1000<t){
        nextCmdList=0;
        for (var i in cmdList){
          if (cmdList[i][2]-59*1000<t){
            eval(cmdList[i][0]);
            if (cmdList[i][1]===true)
              cmdList[i][1]=false
            else 
              cmdList[i][2]=getOffsetTime(cmdList[i][1]);
          }
        }
        refreshTaskOnPageChange();
      }
    }
    function deleteTaskOnPageChange(tId){
      if (tId) delete cmdList[tId];
    }
    function refreshTaskOnPageChange(){
      for (var i in cmdList)
        if (cmdList[i][1]===false)
          deleteTaskOnPageChange(i);
        else 
          if (nextCmdList==0||cmdList[i][2]<nextCmdList)
            nextCmdList=cmdList[i][2];
    }
    function initBrowserPage(){
      setIcon();
      killShadow();
      addTaskOnPageChange("killShadow()", 86300*1000);//24*3600=86400 & 1700 --> 17*24*3600
      addTaskOnPageChange("reduceShadow()", 3100*1000);//prime number 60*60=3600
    }
    function initClockWeather(){
      if(hasClockInit) return;//avoid duplicated init clock;
      hasClockInit=true;
      var date=getOffsetDate();
      //update() included in updateInterval()
      updateInterval();
      //No need to update weather manually at the first time.
      document.getElementById('sync').innerHTML=date.getFullYear()+'-'+frontZero(date.getMonth()+1)+'-'+frontZero(date.getDate())+' '+frontZero(date.getHours())+':'+frontZero(date.getMinutes())+':'+frontZero(date.getSeconds());
      document.getElementById('timeoffset').innerHTML=timeOffsetFormat();
      document.getElementById('net').innerHTML='初始化同步';
      weatherInterval();
    }
    function setIcon(){
      for (var i in document.styleSheets)
        for (var j in document.styleSheets[i].cssRules)
          if (document.styleSheets[i].cssRules[j].selectorText=='.tImg'){
            document.getElementById('ico').href=document.styleSheets[i].cssRules[j].style.content.slice(5,-2);
            return true;
          }
      return false;
    }
    function killShadow(force){
      if (force||!preventDecreaseShadow)
        for (var i=0;i<3;i++)
          setTimeout('cleaner[0].display="'+["block", "block", "none"][i]+'";'+
                    'cleaner[0].background="'+["black", "white", "black"][i]+'"', 600*i);
    }
    function reduceShadow(){
      if (!preventDecreaseShadow)
        for (var i=0;i<2;i++)
          setTimeout('cleaner[1].opacity='+[0, 1][i], 600*i);
    }
    function runTime(n){return timeFormat(new Date().getTime()-initTime, n?n:3, true);}
    function noCache(){return "?noCache="+document.body.clientWidth+"."+document.body.clientHeight+"."+(""+Math.random()).slice(2,9);}
    function frontZero(a, n){
      if (!n) n=2;
      if (typeof a!='object')
        a=[a];
      for (var i in a)
        if (typeof a[i]=='number'){
          a[i]=a[i].toString();
          for (var j=n-a[i].length;j>0;j--)
            a[i]='0'+a[i];
        }
      return a.join('');
    }
    function timeFormat(s,n,noPlus){
      s=Math.floor(s);
      if (s==0) return "";
      if (!n) n=3;
      var str="";
      var a="";
      if (s>0)
        a="+";
      else {
        a='-';
        s=-s;
      }
      if (s<1000)
        str="."+frontZero(s,3)+"s";
      else{
        var f=[[10,100,60,60,24,365,100,10], ["","s","m","h","d","Y","C","T"]];
        var fsum=1;
        for (var i in f[0])
          fsum*=f[0][i];
        for (var i=f[0].length-1;i>0&&n>0;i--){
          if (s>=fsum){
            str+=Math.floor(s/fsum)+f[1][i];
            s%=fsum;
            n--;
          }
          fsum/=f[0][i];
        }
        if (s!=0&&n>0)
          str+=frontZero(Math.floor(s/fsum), 2)+f[1][0];
      }
      return (!noPlus||a=='-'?a:"")+str;
    }
    function timeOffsetFormat(n){return timeFormat(timeOffset, !n?2:n);}
    function how(){
      var inspect=['runTime(2)', 'weeklyTomato.length', 'countIcs()', 'hardwareLagRate'];
      var o='';
      var res;
      for (var i in inspect){
        res=eval(inspect[i]);
        if (typeof res=='number'&&res>5*60*1000)
          res=timeFormat(res,2,true);
        o+=inspect[i].slice(0,6)+':'+res+',';
      }
      o+='['+(Object.keys(cmdList).length-1)+','+dateString(nextCmdList)+']:';
      for (var i in cmdList)
        o+=i+(cmdList[i][1]!==true?','+timeFormat(cmdList[i][1], 2, true)+',':'T')+dateString(cmdList[i][2])+'|';
      return o.slice(0,-1);
    }
    function wipe(){document.getElementById('basket').innerHTML='';}
    function test(s){
      if (testStatus=!testStatus){
        comment(how());
        testInterval=setInterval('comment(how(), true)', (s==undefined?58:s)*1000);
      } else
        clearInterval(testInterval);
      update();
    }
    function f5(p){if (p) location.hostname=p; else location.replace(location);}
    function loop(){
      test(true, 3);
      setInterval('timeOffset+=57*1000;update()', 50);
    }
    function correctPrompt(){
      var help={vari: ['who', 'credit', 'help'],
                func: ['how', 'wipe', 'test', 'loop', 'testIcs', 'f5'],
                who: navigator.userAgent,
                credit: JSON.stringify(info).replace(/"/g,'')};
      [].push.apply(help.help=help.func, help.vari); 
      var userInput=prompt(timeOffsetFormat(3)+'\nTo Manually change kindle system time:\n;st 2020-07-22 17:59\n\nPlease ENTER number:\nformat: 235959 (hhmmss->23:59:59)\n* 123456 means reset *\n'+help.help);
      if (!timeCorrect(userInput))
        try{
          if (help.vari.indexOf(userInput)!=-1)
            userInput='help.'+userInput;
          else if (help.func.indexOf(userInput)!=-1)
            userInput+='()';
          comment(eval(userInput));
        } catch (e){
          comment(e);
        }
    }
    function timeCorrect(correct){//000000~235959
      if (!correct||correct.length!=5&&correct.length!=6) return false;
      if (correct=="123456")
        timeOffset=0;
      else {
        var hms=[correct.slice(-6,-4), correct.slice(-4,-2), correct.slice(-2)];
        var allow=[[0,23],[0,59],[0,59]];
        for (var i in hms){
          hms[i]=Math.floor(parseInt(hms[i]));
          if (!(hms[i]>=allow[i][0]&&hms[i]<=allow[i][1])) return false;
        }
        var date=new Date();
        date.setMinutes(date.getMinutes() + date.getTimezoneOffset() + 480);
        timeOffset=(((hms[0]-date.getHours())*60+(hms[1]-date.getMinutes()))*60+(hms[2]-date.getSeconds()))*1000;
      }
      update();
      return true;
    }
    function getOffsetDate(offset, noShift){
      var date=new Date();
      if (typeof offset!='number') offset=0;
      if (!noShift) date.setMinutes(date.getMinutes() + date.getTimezoneOffset() + 480);
      date.setMilliseconds(date.getMilliseconds()+timeOffset+offset);
      return date;
    }
    function getOffsetTime(offset, noShift){return getOffsetDate(offset, noShift).getTime();}
    function updateInterval(){
      var mscs=getOffsetTime();
      setTimeout("updateInterval()", lessDisturbUpdateWhenTomato?((599999-mscs%600000)+50):(59999-mscs%60000)+50);//(60*10)*1000+50
      update();
    }
    function update(){
      var date=getOffsetDate();
      runTaskOnPageChange();
      if (timeOffset==0)//fix the bug on kindle
        date.setMinutes(date.getMinutes()+1);
      clock[0].innerHTML = frontZero(date.getHours())+':';
      clock[1].innerHTML = frontZero(date.getMinutes());
      clock[2].innerHTML = (date.getMonth() + 1) + '月' + date.getDate() + '日';
      clock[3].innerHTML = '星期'+['日', '一', '二', '三', '四', '五', '六'][date.getDay()]
      clock[3].innerHTML+= '<span style="font-size:1.5rem;position:absolute;"> '+(testStatus?'#envTest':'')+' '+tickListAlarm+"</span>";
      return date;
    }
    function weatherInterval(){
      var date = getOffsetDate();
      var nextRefresh=0;
      if (!lastSyncTime) lastSyncTime=date.getTime();
      if (date.getTime()-lastSyncTime>refreshRate+100000)
        nextRefresh=10*60*1000;
      else if (date.getHours()+refreshRate/1000/3600<24)
        nextRefresh=refreshRate;
      else//calculate time till 00:00
        nextRefresh=24*3600*1000-date.getTime()%(24*3600*1000)+50;
      if (weatherTaskIndex==0)
        weatherTaskIndex=addTaskOnPageChange('weatherInterval()', nextRefresh);
      else
        addTaskOnPageChange(weatherTaskIndex, nextRefresh);
      if (date.getTime()-lastSyncTime>10000)
        setTimeout('onlineWeather()', 100);
    }
    function onlineWeather(){
      var _doc=document.getElementsByTagName('body')[0];
      var script=document.createElement('img');
      script.setAttribute('id','testConnection');
      script.setAttribute('src','//www.163.com/favicon.ico'+noCache());
      _doc.appendChild(script);
      script.onload=script.onreadystatechange=function(){
        if(!this.readyState||this.readyState=='loaded'||this.readyState=='complete')
          weather(true);
        else
          weather(false);
        script.onload=script.onreadystatechange=null;
      }
      _doc.removeChild(script);
    }
    function weather(connected)
    {
      var date=getOffsetDate();
      if (connected){
        lastSyncTime=date.getTime();
        document.getElementById('ifrmid').src=document.getElementById('ifrmid').src;//change iframe
        document.getElementById('sync').innerHTML=date.getFullYear()+'-'+frontZero([date.getMonth()+1,'-',date.getDate(),' ',date.getHours(),':',date.getMinutes(),':',date.getSeconds()]);
        document.getElementById('timeoffset').innerHTML=timeOffsetFormat();
        document.getElementById('net').innerHTML='完成上一次同步';
      } else
        document.getElementById('net').innerHTML='无网络连接';
    }


    /*Tomato Timer*/
    var toStatus, ispaused, weeklyTomato;
    var timerEntity;
    var signalTired=0;
    var toWorkTimer=25*60;//Second
    var timerEnd, restWhenPaused;
    var toRestTimer=5*60
    var expireTomato=30;//Day
    var tomatoMsg=[document.getElementById('tom'), document.getElementById('ato'), document.getElementsByTagName('title')[0]];
    var buttonStyle=[document.getElementById('hour').style, document.getElementById('minute').style]
    var shinningSignal=[document.getElementById('ato').style, document.getElementById('inform').style, document.getElementById('allDate').style];
    prepareTomato();
    //dumpTomato();gatherTomato(719);
    function dumpTomato(){rottenTomato(-1);}
    function gatherTomato(fakeTomatos){
      if (!weeklyTomato.length) eatTomato();
      if (fakeTomatos)
        for (var i=0;i<fakeTomatos;i++)
          weeklyTomato.push(-1);
      else
          weeklyTomato.push(Math.floor(new Date().getTime()/(24*3600*1000)));
      canTomato();
      showTomato("Gather");
    }
    function canTomato(){document.cookie = "tomato="+compressTomato()+";expires="+ new Date(0x7fffffff * 1e3).toUTCString();}
    function compressTomato(){
      var compressed="";
      for (var i in weeklyTomato){
        if (i!=0) compressed+='.';
        compressed+=Math.floor(weeklyTomato[i]).toString(36);
      }
      return compressed;
    }
    function showTomato(source){
      var _doc=document.getElementById('basket');
      _doc.textContent="";
      var f=[1,2,20,60,180];
      var res=0;
      var tomatos=weeklyTomato.length;
      for (var i=f.length-1;i>=0&&tomatos!=0;i--){
        res=Math.floor(tomatos/f[i]);
        tomatos%=f[i];
        for (var j=0;j<res;j++)
          enchantTomato(_doc, ['opacity: 0.5;',"",'border:0.1rem dashed black;','border:0.1rem solid black;','border:0.1rem solid black; background-color: #c0c0c0'][i]);
      }
      if (weeklyTomato.length!=0) _doc.insertAdjacentHTML("beforeend", weeklyTomato.length);
      logTomato(source);
    }
    function enchantTomato(_doc, magicType){
        var script=document.createElement('img');
        script.setAttribute('class','tImg');
        if (magicType) script.setAttribute('style',magicType);
        _doc.appendChild(script);
    }
    function eatTomato(){
      var offset=document.cookie.indexOf("tomato=");
      var end = document.cookie.indexOf(";",offset);
      if (offset!=-1){
        offset+="tomato=".length
        if (end==-1) end=document.cookie.length;
        var content=document.cookie.substring(offset, end);
        if (content){
          weeklyTomato=Array();
          content=content.split(".");
          for(var i in content)
            if (parseInt(content[i], 36))
              weeklyTomato.push(parseInt(content[i], 36));
        }
        logTomato("Read");
      }
    }
    function logTomato(source){
      if (weeklyTomato.length==0)
        console.log("Empty >ToMaMaTo< Store from "+source);
      else
        console.log("Len:"+weeklyTomato.length+" "+source+":"+weeklyTomato.slice(0,5));
    }
    function rottenTomato(expire){
      var date=Math.floor(new Date().getTime()/(24*3600*1000))-(!expire?expireTomato:expire);
      weeklyTomato.sort(function(a, b){return b-a;});
      for (var i in weeklyTomato)
        if (weeklyTomato[i]<date){
          weeklyTomato=weeklyTomato.slice(0, i);
          break;
        }
      canTomato();
      setTimeout("rottenTomato()", expireTomato*24*3600*1000/3);
      showTomato("Rotten");
    }
    function secondsUntilNow(future){
      return Math.round((future-new Date().getTime())/1000);
    }
    function updateMsg(tom, sliceIndex){
      if (tom){
        if (sliceIndex) tom+=tomatoMsg[0].innerHTML.slice(sliceIndex);
        if (tom.slice(-2)!=": ") tom+=": "
        tomatoMsg[0].innerHTML=tom;
      }
      timerCount=secondsUntilNow(timerEnd);
      timeString=""+frontZero(Math.floor(timerCount/60))+":"+frontZero(timerCount%60);
      tomatoMsg[1].innerHTML=timeString;
      tomatoMsg[2].innerHTML=timeString+(toStatus=='work'?" <TOM":" <ATO");
    }
    function fridgeTomato(){
      prepareTomato();
      tomatoMsg[0].innerHTML="MATO";
      tomatoMsg[1].innerHTML="TOMA";
      tomatoMsg[2].innerHTML=initialTitle;
      killShadow();
    }
    function prepareTomato(){
      //quit from tomato
      preventDecreaseShadow=false;
      lessDisturbUpdateWhenTomato=false;
      toStatus='stop';//work,rest,stop
      ispaused=false;
      weeklyTomato=Array();
      eatTomato();
      clearTimeout(timerEntity);
      updateButton();
    }
    function switchTomato(){
      switch (toStatus){
        case 'stop':
          toStatus='work';
          setTimer();
          preventDecreaseShadow=true;
          lessDisturbUpdateWhenTomato=true;
          timerEnd=new Date().getTime()+toWorkTimer*1000;
          rottenTomato();
          updateMsg("番茄开始");
          updateButton();
          break;
        case 'work':
          toStatus='rest';
          restWhenPaused=toRestTimer*1000;
          timerEnd=new Date().getTime()+restWhenPaused;
          clearTimeout(timerEntity);
          updateMsg("番茄中场");
          pauseTomato();
          break;
        case 'rest':
          toStatus='work';
          restWhenPaused=toWorkTimer*1000;
          timerEnd=new Date().getTime()+restWhenPaused;
          clearTimeout(timerEntity);
          updateMsg("番茄工作");
          pauseTomato();
          break;
      }
    }
    function setTimer(){
      clearTimeout(timerEntity);
      timerEntity=setTimeout('tomatoTimer()',1000);
    }
    function tomatoTimer(){
      if (timerEnd<new Date().getTime()){
        if (toStatus=='work')
          gatherTomato();
        switchTomato();
      } else {
        updateMsg();
        setTimer();
      }
    }
    function updateButton(){
      buttonStyle[1].color=(ispaused)?'#303030':'#a9a9a9';
      if (toStatus=='stop') buttonStyle[1].color='#000000';
      buttonStyle[0].color=['#000000', '#303030', '#a9a9a9'][['stop', 'work', 'rest'].indexOf(toStatus)];
    }
    function updateSignal(){
      if (ispaused && toStatus!='stop'){
        if (signalTired>toWorkTimer){
          tomatoMsg[2].innerHTML=initialTitle;
          for (var i in shinningSignal)
            shinningSignal[i].color='#000000';
        } else {
          if (signalTired%2==0){
            tomatoMsg[2].innerHTML='✔ * * * ✔';
            for (var i in shinningSignal)
              shinningSignal[i].color='#ffffff';
          } else {
            tomatoMsg[2].innerHTML='* RELAX *';
            for (var i in shinningSignal)
              shinningSignal[i].color='#000000';
          }
          if (signalTired==0 || signalTired==toWorkTimer)
            killShadow(true);
          signalTired++;
          setTimeout('updateSignal()', 800);
        }
      } else {
        signalTired=0;
        tomatoMsg[2].innerHTML=initialTitle;
        for (var i in shinningSignal)
          shinningSignal[i].color='#000000';
      }
    }
    function pauseTomato(){
      if (toStatus=="stop") return;
      ispaused=!ispaused
      if (ispaused){
        clearTimeout(timerEntity);
        restWhenPaused=timerEnd-new Date().getTime();
        updateMsg("暂停", -4);
      } else {
        setTimer();
        timerEnd=new Date().getTime()+restWhenPaused;
        updateMsg("番茄", -4);
      }
      updateButton();
      updateSignal();
    }
    
  /*
    Note: you need set a Nginx server to proxy the GET method to the
          calendar server to download the .ics file. Add those lines
          to your Nginx config file to avoid CROS problem as the
          request directly from your browser is banned for some
          security reason.
          
    location /ics/ {
      proxy_redirect off;
      proxy_buffering off;
      proxy_http_version 1.1;
      proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
      proxy_set_header Upgrade $http_upgrade;
      proxy_set_header Connection $http_connection;
      add_header Access-Control-Allow-Methods *;
      add_header Access-Control-Allow-Credentials true;
      add_header Access-Control-Allow-Origin $http_origin;
      if ($request_method = OPTIONS){
        return 200;
      }
      access_log off;
      proxy_pass https://XXX/pub/calendar/feeds/XXXXX/basic.ics;
    }
  */
    var tickList={};
    var tickListStatus=0;
    var tickListTaskIndex=!testStatus?addTaskOnPageChange('getIcs()', 6*3600*1000):0;
    var tickListMaxLine=21;
    var tickListReminderList={};
    var tickListFloatIndex=0;
    function dDay(t){return dHour(t, 24);}
    function dHour(t, h){return parseInt(dMs(t, (!h?1:h)*3600*1000));}
    function dMs(t, ms){return (t-getOffsetTime())/(!ms?1:ms);}
    function dateString(timeStamp, format){
      var s='';
      var all='YMdhms';
      var date=timeStamp?new Date(timeStamp):getOffsetDate();
      if (!format) format='hm';
      var res=[date.getFullYear(), date.getMonth()+1, date.getDate(), date.getHours(), date.getMinutes(), date.getSeconds()];
      for (var i=0;i<all.length;i++)
        if (format.indexOf(all[i])!=-1)
          s+=frontZero([res[i], ['-', '-', ' ', ':', ':', ' '][i]]);
      return s.slice(0,-1);
    }
    function randInt(n, from){if (from==undefined) from=0;return Math.ceil(Math.random()*(n-from))+from;}
    function countIcs(){
      var b=[];
      for (var i in tickList)
        b.push(tickList[i].length);
      return b;
    }
    function testIcs(n){
      var s='';
      if (!n) n=16;
      var d=new Date();
      d.setMinutes(d.getMinutes()+d.getTimezoneOffset()+15+1);
      for (var i=0;i<n;i++)
        s+="BEGIN:VEVENT\nDTSTART:"+(2018+randInt(3))+frontZero(randInt(12, 1))+'01T020304Z\nSUMMARY:Default\nDESCRIPTION:e\n'
        +"BEGIN:VEVENT\nDTSTART:"+d.getFullYear()+frontZero([d.getMonth()+1,d.getDate(),'T',d.getHours(),randInt(59, 0)])+'08Z'+'\nSUMMARY:Default\nDESCRIPTION: e'+space(5)+'测试测试测试测试测试测试测试测试测试测试'+'\nRRULE:FREQ=WEEKLY;INTERVAL=3\n';
      readIcs(s);
      tickListStatus++;showIcs(true);
    }
    function getIcs(){httpGet("/ics/", function a(s){readIcs(s);showIcs(true);});}
    function readIcs(s){
      s=s.replace(/\r/g,'').split('\n');
      var r=[];
      var tag=['DTSTART', 'DTSTART;VALUE=DATE', 'SUMMARY', 'DESCRIPTION', 'TRIGGER', 'RRULE'];
      for (var i=0;i<s.length;i++){
        var splitter=s[i].indexOf(':');
        var line=[s[i].slice(0,splitter).trim(), s[i].slice(splitter+1).trim()];
        if (line[0]=='BEGIN'){
          if (line[1]=='VEVENT')
            r.push({});
        } else if (tag.indexOf(line[0])!=-1&&r.length!=0&&r[r.length-1][line[0]]==undefined){
          if (line[0]==tag[0])
            line[1]=Date.parse(line[1].slice(0,4)+'-'+line[1].slice(4,6)+'-'+line[1].slice(6,11)+':'+line[1].slice(11,13)+':'+line[1].slice(13))+(new Date().getTimezoneOffset()+480)*60*1000;
          else if (line[0]==tag[1]){
            line[0]=tag[0]
            line[1]=Date.parse(line[1].slice(0,4)+'-'+line[1].slice(4,6)+'-'+line[1].slice(6,8)+'T08:00:00Z');
            r[r.length-1]['isDateOnly']=true;
          } else if (line[0]==tag[3]){
            for (var j=i+1;j<s.length&&s[j][0]==' ';j++)
              line[1]+=s[j].slice(1);
            line[1]=line[1].replace(/\\n|\\|\n/g,'').trim();
            if (line[1].slice(0,2)=='- '&&line[1].indexOf(' - ')!=-1)
              line[1]=line[1].slice(2).replace(/ - /g,' / ');
          } else if (line[0]==tag[5]){
            r[r.length-1]['FREQ']='';
            line[1]=line[1].split(';');
            for (var j in line[1]){
              line[1][j]=line[1][j].split('=');
              if (line[1][j][0]=='FREQ')
                r[r.length-1]['FREQ']+='年月周日'[['ANNUALLY','MONTHLY','WEEKLY','DAILY'].indexOf(line[1][j][1])];
              else if (line[1][j][0]=='INTERVAL')
                r[r.length-1]['FREQ']=(line[1][j][1]<=9?'零一两三四五六七八九'[parseInt(line[1][j][1])]:line[1][j][1])+r[r.length-1]['FREQ'];
            }
            continue;
          }
          r[r.length-1][line[0]]=line[1];
        }
      }
      sortIcs(r, 1);
      return tickList;
    }
    function sortIcs(r, sortNum){
      tickList={important:[],normal:[],noDate:[]};
      var func=[[function (d){return d>-14},
                 function (a,b){return b.DTSTART-a.DTSTART}],
                [function (d, freq){return d>=(freq?-7:-14)&&d<=(freq?14:90)},
                 function (a,b){
                    var c=[a.DTSTART,b.DTSTART];
                    var d=[a, b];
                    for (var i in c){
                      c[i]-=getOffsetTime();
                      var isNeg=c[i]!=(c[i]=Math.abs(c[i]));
                      c[i]*=(isNeg?c[i]>180?3:2:1)*(d[i].isDateOnly?6:1)*(d[i].FREQ?c[i]>30?5:2:1);
                      }
                    return c[0]-c[1];
                 }]][sortNum];
      for (var i in r)
        if (r[i].DTSTART){
          var dD=dDay(r[i].DTSTART);
          if (!dD)
            alarmIcs(r[i]);
          if (func[0](dD, r[i].FREQ))
            tickList.important.push(r[i]);
          else
            tickList.normal.push(r[i]);
        } else
          tickList.noDate.push(r[i]);
      tickList.important.sort(function (a,b){return a.DTSTART-b.DTSTART;});
      tickList.normal.sort(func[1]);
    }
    function showIcs(keep){
      var t=document.getElementById('tickList');
      var tickTable=t.getElementsByTagName('table')[0];
      var tickImg=document.getElementById('tickImg');
      tickTable.innerHTML='';
      if (!keep) tickListStatus++;
      if (!keep&&tickListStatus%6==1){
        tickTable.innerHTML=tickListStatus;
        getIcs();
      } else if (tickListStatus%3==0){
        deleteTaskOnPageChange(tickListFloatIndex);
        t.innerHTML='<div></div><img id="tickImg" class="tImg" style="padding:1rem"><table></table>';
      } else {
        if (tickImg) t.removeChild(tickImg);
        var limit=(tickListStatus%3==1)?tickListMaxLine:5;
        var s='<tr><td style="opacity:.3">'+dateString(0)+'<span style="opacity:0">100.00</span></td><td style="font-size:1.5rem;opacity:0;line-height:0">1000</td></tr>';
        var cross30;
        for (var j in tickList){
          var l=tickList[j];
          for (var i in l){
            if (--limit<0) break;
            var dD=dDay(l[i].DTSTART);
            var adD=Math.abs(dD);
            var td_divider='';
            if (cross30==undefined)
              cross30=adD;
            if (adD>=30&&cross30<30){
              cross30=31;
              td_divider=' style="border-top:3px dotted;"';
            } else
              td_divider='';
            var sude=(l[i].SUMMARY.length+l[i].DESCRIPTION.length>25)?[l[i].SUMMARY.slice(0,10), (l[i].SUMMARY.slice(10)+(l[i].SUMMARY.length>10&&l[i].DESCRIPTION?': ':'')+l[i].DESCRIPTION.slice(0,200-Math.min(10, l[i].SUMMARY.length)*6)).trim()]:[(l[i].SUMMARY+' '+l[i].DESCRIPTION).trim(), ''];
            var freq=(l[i].FREQ)?'<sup style="font-size:xx-small;border-radius:20%;border:solid">'+l[i].FREQ+'</sup>':'';
            s+='<tr style'+(!dD?'="font-weight:bold"':'')+'><td'+td_divider+'>'+dateString(l[i].DTSTART,'Mdhm')+'</td><td class="tl_co" style="color:hsl(0,0%,'+Math.floor(adD/(!j?120:480)*100)+'%)">'+(adD<7?'<img class="tImg" style="height:1.5rem;margin-left:-2rem"><div class="tl_to" style="height:'+Math.ceil(dD/10*3)/3*1.5+'rem"></div>':'')+(dD?dD:'')+'</td><td class="tl_sude"><span class="tl_su"> '+freq+sude[0]+'</span>'+'<span style="background:white;">'+sude[1]+'</span></td></tr>';
          }
        }
        tickTable.innerHTML=s;
        updateIcsFloatBar();
        if (tickListFloatIndex==0)
          tickListFloatIndex=addTaskOnPageChange('updateIcsFloatBar();updateIcsReminderDhour();', 2.5*3600*1000);//2.5*2=5<6<2.5*3=7.5
        else
          addTaskOnPageChange(tickListFloatIndex, 2.5*3600*1000);
      }
    }
    function updateIcsFloatBar(){
      var dH=0;
      var t=document.getElementById('tickList').children[0];
      var tr=document.getElementById('tickList').getElementsByTagName('table')[0].children[0].children;
      var ti=tickList.important.slice(0,5);
      var baitHeight=tr[0].offsetHeight;
      if (ti.length>0){
        for (var i=0;i<ti.length-1;i++)
          if (dHour(ti[i].DTSTART)>=0)
            break;
          else if (dHour(ti[i+1].DTSTART)>=0){
            dH=dHour(ti[i+1].DTSTART);
            baitHeight=tr[i+1].offsetTop+tr[i+1].offsetHeight/2+(-dMs(ti[i].DTSTART))/(ti[i+1].DTSTART-ti[i].DTSTART)*tr[i].offsetHeight;
            break;
          }
      }
      t.style.margin=baitHeight+"px 4.5rem";
      t.style.position="absolute";//font-size:larger';
      t.innerHTML='▌'+(dH?dH>24?stringLine(Math.floor(dH/48)+'D'):stringLine(dH+'H'):'↓');
      return i;
    }
    function stringLine(s){
      var ns='';
      for (var i in s)
        ns+='<br>'+s[i];
      return ns;
    }
    function alarmIcs(tick){
      var dH=dHour(tick.DTSTART);
      var d=dMs(tick.DTSTART);
      tickListAlarm='';
      remindIcs("tickListAlarm='['+'"+dateString(tick.DTSTART)+' '+tick.SUMMARY.slice(0,20)+"'+']'", (dH-12)*3600*1000);
      remindIcs("tickListAlarm=''", (dH+12)*3600*1000);
      if (d>=-3600*1000){
        remindIcs(icsReminderHtmlString(tick)+';killShadow(true);displayReminder(true)', d-15*60*1000);
        remindIcs('killShadow(true)', d-1*60*1000);
      }
    }
    function deleteReminder(tickId){
      event.stopPropagation();
      if (confirm('Job\'s done?')){
        delete tickListReminderList[tickId];
        var i=document.getElementById('tickR'+tickId);
        var p=i.parentNode;
        p.removeChild(i);
        if (!p.hasChildNodes())
          p.style.display='none';
      }
    }
    function icsReminderHtmlString(tick){
      var hash=(function(s) {
          var hash = 0, i;
          for (i = 0; i < s.length; i++) {
            hash  = ((hash << 5) - hash) + s.charCodeAt(i);
            hash |= 0; // Convert to 32bit integer
          }
          return hash;
        })(tick.SUMMARY+tick.DESCRIPTION)+Math.floor(tick.DTSTART/1000);
      var dH=dHour(tick.DTSTART);
      var s='<span style="display:block" id="'+hash+'" onclick="deleteReminder("'+hash+'")\">'+(tick.FREQ?'<sup style="font-size:small;border-radius:20%;border:solid">'+tick.FREQ+'</sup>':'')+'['+dateString(tick.DTSTART, 'Mdhm')+'+0]<br>'+tick.SUMMARY+'<br>'+tick.DESCRIPTION+'</span>';
      return 'tickListReminderList['+hash+']=\''+s+'\'';
    }
    function updateIcsReminderDhour(){
      var l=tickListReminderList;
      for (var i in l){
        var s=l[i].slice(l[i].indexOf('[')+1, l[i].indexOf(']')).split('+');
        l[i]=l[i].slice(0, l[i].indexOf('[')+1)+s[0]+'+'+(-dHour(new Date(new Date().getFullYear()+'-'+s[0]).getTime()))+l[i].slice(l[i].indexOf(']'));
      }
      displayReminder(true);
    }
    function displayReminder(on){
      var reminder=document.getElementById("reminder");
      if (!on){
        if (confirm('*CLEAN ALL?*')){
          tickListReminderList={};
          reminder.style.display='none';
        }
      } else {
        var l=Object.keys(tickListReminderList).length;
        var s='';
        if (!l)
          return;
        for (var i in tickListReminderList)
          s+=tickListReminderList[i];
        s=s?s.slice(0,-11)+'</span>':'';
        if (l>3)
          reminder.style="margin: -28rem 10rem;max-height: 25.5rem;";
        else
          reminder.style="";
        reminder.innerHTML=s;
        reminder.style.display='block';
      }
    }
    function remindIcs(cmd, timeout){addTaskOnPageChange(cmd, timeout, true);}//-12h,-15m,-1m,+12h

  /*
  sudo apt-get install python3-distutils
  sudo apt-get install python3-pip
  sudo pip3 install aiohttp [-i https://source]
  python3 sample.py 92613
  sudo nano /etc/nginx/nginx.conf
  sudo systemctl restart nginx

    location /blive/ {
      proxy_http_version 1.1;
      proxy_set_header Upgrade $http_upgrade;
      proxy_set_header Connection $http_connection;
      add_header Access-Control-Allow-Origin *;
      add_header Access-Control-Allow-Headers X-Requested-With;
      add_header Access-Control-Allow-Methods GET,POST,OPTIONS;
      access_log off;
      proxy_pass http://localhost:8099;
    }

# USED IN TAMPERMONKEY for auto-change room-id
// ==UserScript==
// @name         DANMU_ROOM
// @match        *://live.bilibili.com/*
// ==/UserScript==
(function() {
    'use strict';
    function danmuRead(i, t){
        var xmlhttp = new XMLHttpRequest();
        xmlhttp.onreadystatechange = function(){
            if (xmlhttp.readyState == 4)
                document.title=(xmlhttp.status==200?'√ ':'×'+xmlhttp.status)+t;
        }
        xmlhttp.open('GET', "https://debian10/blive/?"+i);
        xmlhttp.send();
    }
    danmuRead(window.location.pathname.split('/').filter(a=>{return a;})[0], document.title);
})();
  */
  var danmuStyle=document.getElementById('danmu_frame').style;
  var danmu=document.getElementById('danmu');
  var danmuReadCount=0;
  var isDanmuLive=0;
  var danmuStart=0;
  var streamer=[['pi', 'nc', 'dd', 'kf'],[92613,1220,16548,22259479],[]];
  var danmuControl=['history', 'bye', 'kick', 'info', 'call[:]', 'c[.up]', 'js[:]'];
  var danmuRoomId='';
  var danmuStreamer='';
  var danmuSuperChat='';
  var danmuPop=0;
  var danmuPopTrends=0;
  var danmuTaskIndexs=[0,0,0,0];//read,info,stat,title
  var danmuMax=1600;
  var danmuTryToken=0;
  var danmuOrderId=-1;
  function space(n, s){
    s=s!=undefined?String(s):'';
    for (n-=s.length*1.8;n-->0;)
      s+=' ';
    return s;
  }
  function danmuSwitch(){
    switch (isDanmuLive){
      case 0:
        danmuOn('');
        break;
      default:
        if (danmuPop<=1){
          var up=prompt('Current: '+danmuRoomId+'\nStreamer:\n'+streamer[0]+'\nControl:\n'+danmuControl);
          if (up!=null)
            danmuOn(up);
        } else
          danmuOff('+'+danmuReadCount);
    }
  }
  function danmuOn(roomId){
    if (streamer[0].indexOf(roomId)!=-1)
      roomId=streamer[1][streamer[0].indexOf(roomId)];
    danmuStart=getOffsetTime();
    danmuTryToken=0;
    streamer[2]=['','','',''];
    danmuTaskIndexs=[0,0,0];
    danmuStyle.opacity=1;
    roomId=String(roomId);
    switch (roomId.slice(0,2)){
      case 'c.':
      case 'c:':
        danmuOrderId=streamer[0].indexOf(roomId.split('.')[1]);
      case 'c':
        isDanmuLive=2;
        danmuInfo();
        break;
      default:
        isDanmuLive=1;
        danmuRead(roomId);
        danmuInfo();
    }
    danmuAlter(false);
  }
  function danmuOff(s){
    if (!isDanmuLive)
      return;
    isDanmuLive=0;
    danmuOrderId=-1;
    clearTimeout(danmuTaskIndexs[0]);
    clearTimeout(danmuTaskIndexs[1]);
    clearTimeout(danmuTaskIndexs[2]);
    clearTimeout(danmuTaskIndexs[3]);
    setTimeout('if (danmuPop==1) danmuClear()', 10*60*1000);
    danmuAlter(true);
    danmu.innerHTML='--BLIVE-OFF--'+(s!=undefined?s+'-':'')+timeFormat(getOffsetTime()-danmuStart,2)+'-<br>'+(danmu.innerHTML).slice(0,danmuMax/5)+'...';
    danmuInfo();
    danmuPop=0;
  }
  function danmuAlter(beLess){
    if (beLess){
      danmu.style.background='white';
      danmuStyle.background='';
      danmuStyle.marginTop='14rem';
      danmuStyle.marginLeft='-4rem';
      danmuStyle.height='15rem';
    } else {
      danmuRoomStatCollect();
      if (isDanmuLive==1){
        danmuRead();
        danmuInfoUpdate();//on danmuRooId change => danmuParseStreamer();
      }
      danmu.style.background='';
      danmuStyle.background='white';
      danmuStyle.marginTop='7rem';
      danmuStyle.marginLeft='-4rem';
      danmuStyle.height='25rem';
    }
  }
  function setDanmuPop(p){
    if (p!=danmuPop&&!(danmuPop==0&&p==1&&getOffsetTime()-danmuStart<2*60*1000)){
      var old=danmuPop;
      danmuPopTrends=p<danmuPop?-1:(p==danmuPop?0:1);
      danmuPop=p;
      if (old==0&&p>1)
        reduceShadow();
      if (p==1)
        danmuAlter(true);
      if (old==1&&p>1)
        danmuAlter(false);
    }
  }
  function danmuBold(s){return '<b>'+s+'</b>';}
  function danmuReverse(s){return '<span style="margin-left:2rem"><small>'+s+'</small></span>';}
  function danmuWrite(s, isBold, isReverse){
    if (isBold) s=danmuBold(s);
    if (isReverse) s=danmuReverse(s);
    var buffer=danmu.innerHTML.slice(0, danmuMax);
    danmu.innerHTML=s+(buffer?'<br>':'')+buffer;
  }
  function danmuShow(s){
    if (!s)
      return;
    var sn=s.split('<br>');
    var s=[];
    if (danmuPop==1&&sn.length>5)
      setDanmuPop(2);
    for (var i in sn){
        if ((sn[i]=sn[i].trim()).slice(0,4)=='[JS]')
          setTimeout('comment('+unescape(sn[i].slice(4))+', true)', 0);
        if (sn[i][0]=='['&&sn[i].indexOf(']')!=-1)
          sn[i]=danmuReverse(sn[i]);
        if (sn[i]&&sn[i].indexOf('[CAFFEINE]')==-1)
          s.push(sn[i]);
    }
    s=s.join("<br>");
    if (danmuPop!=1&&danmuOrderId==-1&&s.indexOf('[RECV]')==-1&&s.indexOf('[SLEEP]')!=-1)
      setDanmuPop(1);
    if (s)
      danmuWrite(s);
    if (s||danmuPop==9999)
      danmuInfo();
  }
  function danmuSC(l){
    danmuSuperChat='';
    var d=getOffsetTime(0, true);
    for (var i in l){
        l[i][0]=Math.floor((l[i][0]-d)/(60*1000));
        if (l[i][0]>=0)
          danmuSuperChat+='<b>￥'+l[i][1]+'</b><small>[+'+l[i][0]+'分]</small> '+l[i][2]+'<br>';
      }
  }
  function danmuRead(roomId, f){
    if (++danmuTryToken>=10){
      danmuOff('(〃>_<;〃) R'+danmuTryToken+'>9, Id: '+roomId);
      return;
    } else if (danmuTryToken>3)
      danmuInfo();
    httpGet("/blive/"+(roomId?'?'+roomId:''), function a(s){
      if (s.indexOf('[EXCEP]')==-1)
        danmuTryToken=0;
      if (f==undefined)
        danmuShow(s);
      else
        f(s);
    }, function b(n){
      if (isDanmuLive&&n>=400&&n<600)
        danmuWrite('[local] server return: '+n+'R'+danmuTryToken+'S'+Math.floor(getOffsetTime()/1000)%3600, false, true);
    });
    if (f==undefined){
      clearTimeout(danmuTaskIndexs[0]);
      if (isDanmuLive)
        danmuTaskIndexs[0]=setTimeout('danmuRead()', danmuTryToken<=3&&danmuPop>1?1000:danmuPop==0?10*1000:2*60*1000);
    }
  }
  function danmuInfoUpdate(s){
    clearTimeout(danmuTaskIndexs[1]);
    if (isDanmuLive){
      if (s){
        var info=JSON.parse(s);
        if (danmuRoomId!=(danmuRoomId=info.room_id))
          danmuParseStreamer();
        danmuSC(info.super_chat);
        var p=parseInt(info.pop);
        if (parseInt(info.que_size)>5&&p==1)
          p=2;
        setDanmuPop(p);
        danmuInfo();
        danmuTaskIndexs[1]=setTimeout('danmuRead("info", danmuInfoUpdate)', danmuPop==1?2*60*1000:29*1000);
      } else
        setTimeout('danmuRead("info", danmuInfoUpdate)', 3*1000);
    }
  }
  function danmuInfo(){
    var status=['◯ OFF', '▁▂▃▄▅▆▇█'[danmuReadCount%8]+' oи'+(danmuPop==9999?'☕':''), 'ᗯατcᏥ'][isDanmuLive];
    if (danmuTryToken>3)
      status=' ⁉'+danmuTryToken;
    document.getElementById('danmu_info').innerHTML=(isDanmuLive==2||!streamer[2].join('')?'人气':'<big>'+streamer[2].reduce(function a(s, n){return s+(n?'•':'◦')},'')+'</big> ')+(danmuPop<1e4?danmuPop:Math.floor(danmuPop/1e3)/10+'万')+'↓→↑'[danmuPopTrends+1]+'<span style="float:right">'+space(24, danmuStreamer?danmuStreamer:'')+(streamer[2][streamer[1].indexOf(danmuRoomId)]?status[0]+' '+streamer[2][streamer[1].indexOf(danmuRoomId)]:status)+' </span><br>'+danmuSuperChat;
  }
  function danmuRoomStatCollect(n){
    clearTimeout(danmuTaskIndexs[2]);
    if (isDanmuLive){
      if (n==undefined)
        n=0;
      danmuRead("cros:https://api.live.bilibili.com/room/v1/Room/room_init?id="+streamer[1][n++%streamer[1].length], danmuParseLive);
      danmuTaskIndexs[2]=setTimeout('danmuRoomStatCollect('+n+')', danmuPop==1||n%streamer[1].length==0||danmuTryToken>=3?240*1000:10*1000);
    }
  }
  function danmuParseStreamer(s){
    clearTimeout(danmuTaskIndexs[3]);
    if (isDanmuLive==1){
      if (s){
        var stat=JSON.parse(s);
        danmuRead("cros:https://api.bilibili.com/x/space/acc/info?mid="+stat.data.uid, function a(s){
          var stat=JSON.parse(s);
          if (stat.code==0){
            var s=[stat.data.name, stat.data.live_room.title];
            danmuStreamer=s[0].length+s[1].length>14?(s[0].slice(-3)+s[1]).slice(0,14):s[0]+s[1];
          }
        });
        danmuTaskIndexs[3]=setTimeout('danmuRead("cros:https://api.live.bilibili.com/room/v1/Room/room_init?id='+danmuRoomId+'", danmuParseStreamer)', danmuTryToken>=3?600*1000:300*1000);
      } else {
        if (danmuRoomId)
          danmuRead('cros:https://api.live.bilibili.com/room/v1/Room/room_init?id='+danmuRoomId, danmuParseStreamer);
        else
          setTimeout('danmuParseStreamer()', 30*1000);
      }
    }
  }
  function danmuParseLive(s){
    var stat=JSON.parse(s);
    if (stat.code==0){
      stat=stat.data;
      var i=streamer[1].indexOf(stat.short_id);
      if (i==-1)
        i=streamer[1].indexOf(stat.room_id);
      if (i!=-1)
        if (streamer[2][i]!=(streamer[2][i]=stat.live_time>0?Math.floor((getOffsetTime(0,true)/1000-stat.live_time)/60)+'m':''))
          danmuInfo();
      if (isDanmuLive==2)
        danmuWrite('> '+(danmuOrderId==i?'*':'')+streamer[0][i]+space(3)+space(10, streamer[1][i])+streamer[2][i]+(!i?' ---':''), streamer[2][i]!='', true);
      if (danmuOrderId!=-1&&streamer[2][danmuOrderId]){
        danmuOn(streamer[1][danmuOrderId]);
        killShadow();
        danmuOrderId=-1;
      }
    }
  }
  function danmuClear(){
    if (isDanmuLive) return;
    danmuStyle.opacity=0;
    document.getElementById('danmu_info').innerHTML='';
  }
  var isEnd=true;
  </script>
</body>
</html>