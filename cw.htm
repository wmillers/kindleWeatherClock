<!DOCTYPE html>
<html lang="zh-CN">
<head>
  <meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
  <meta name="viewport" content="width=device-width,initial-scale=1.0,maximum-scale=1.0, user-scalable=0">
  <script>
"use strict";
/***************Basic settings***************
Note: Most you need to configure are in the Basic
    settings. If you want to use extra modules, please
    follow the instructions in README.md, and add
    the `location xxx {}` things in this file to
    your nginx config.
*/
var forTestUse=false;//If you are not sure, please change it to false
var info={
    version: '1.6',
    description: '(changes are in commit logs)',
    author: 'wmillers@github',
    support: ['time', 'weather',//those two are default modules
        //'TO-DISABLE-EXTRA-MODULES//COMMENT-THE-LINE',
        'tomato',
        'ticklist',
        'danmu',
        'home',
        'lunaryear',
    ],
    license: 'LGPL2.1'
}
var isOnKindle=!/windows|chrome/i.test(navigator.userAgent);//most affect autostart
var autostart=isOnKindle?[//COMMENT unwanted auto-start modules
    'ticklist',
    //'danmu',
    'home']
    :[];
var isDanmuFullWindow=true;//danmu start in fullwindow mode (not fullscreen)
var isDanmuLiveVideo=true;//play live on roomId changed, only in fullscreen (not fullwindow) mode #danmuonly 
var danmuFontSizeFullScreen=["3", "vw"];//only under fullscreen (not fullwindow) mode #danmuonly
var hueBaseUrl = '/hue/';//'//philips-hue/api/' if no need CORS Access-Control-Allow-Origin *
var hueToken = "UDp1xs0RpZiOho4oX7PY-L7fpAOe8pYnOMTK1tfo";//replace with your token, to get: push bridge button and run hReg()
//*******************END**********************

if (!isOnKindle) console.warn('[autostart:disabled] notKindle');
window.onerror=function handler(msg, source, line, col, e){comment((line?'['+line+']':'')+(e?e.stack:msg))};
setTimeout(function isLoaded(){
    if (typeof loaded=="undefined"){
    document.getElementsByClassName('cleaner')[0].innerHTML="<center>js FAILED</center>";
    confirm('JS failed, need reload?')?f5():console.error(comment('[js:failed] reloadRejected'));
    }
}, 4000);
if (forTestUse)
    setInterval('comment(how(), true)', 7*1000);
if (typeof eval!='function')
    comment('eval not support');
function hasModule(name){
    return info.support.indexOf(name)!=-1;
}
  </script>
  <title>&nbsp;</title><!--tomatoClock-->
  <link id="ico" href="" rel="icon" type="image/x-icon" />
  <style>
    html {
        height: 100%;
        overflow: hidden;
        overflow-x: hidden;
        overflow-y: hidden;
    }
    table {
      border-spacing: 0;
    }
    .cleaner {
      background: black;
      color: white;
      position: fixed;
      width: 100%;
      height: 100%;
      display: block;
      z-index: 20;
      top: 0;
      left: 0;
    }
    .app {
      margin-top: 3rem;
      padding-top: 2rem;
      margin-left: -1.5rem;
      height: 46rem;
      width: 44rem;
      font-family: Arial,sans-serif;
      text-align: center;
      overflow: hidden;
    }
    .rotate {
      transform:rotate(270deg);
      -webkit-transform:rotate(270deg);
    }
    .home {
      position: absolute;
      left: 24rem;
      width: 20rem;
      z-index: 3;
      font-size: 3rem;
      font-weight: bold;
    }
    .home.more {
        font-size: 2.5rem;
        left: 20rem;
        width: 24rem;
    }
    .h_switch {
      height: 20rem;
      width: 4rem;
      border: black 5px solid;
      display: table-cell;
      vertical-align:middle;
      background: rgba(0, 0, 0, 0.2);
      color: white;
    }
    .tickList {
      position: absolute;
      font-size: .5rem;
      left: -3rem;
      text-align: left;
      z-index: 2;
      white-space: pre-wrap;
      overflow: hidden;
      text-shadow: 2px 2px 0 white, -2px -2px 0 white, -2px 2px 0 white, 2px -2px 0 white;
    }
    .tickList .tomato {
      display:inline;
      margin-left:-1.6rem;
      position:absolute;
      background: white;
      width: 1.5rem;
    }
    .tickList .countdown {
      text-align:right;
      font-size:1.5rem;
    }
    .tickList .content {
      display: block;
      padding: 0;
      word-break: break-all;
    }
    .tickList .summary {
      font-size: 1.5rem;
      padding: .16rem 0;
      float: left;
    }
    .danmu_fr {
      position: absolute;
      font-size: 1rem;
      margin-top: 14rem;
      margin-left: -3.4rem;
      text-align: left;
      height: 15rem;
      width: 18rem;
      overflow: hidden;
      z-index: 4;
      word-break: break-all;
      white-space: pre-wrap;
    }
    .danmu_fr.fullscreen {
        margin-top: 0;
        position: fixed;
        top: 0;
        margin-left: 0;
        width: 100%;
        height: 100%;
        background: hsl(0,0%,4%);
        color: rgba(255, 255, 255, .2);
        left: -.01rem;
    }
    .danmu_fr.less {
        margin-top: 14rem;
        height: 15rem;
    }
    .danmu_fr.more {   
        background: white;
        margin-top: 9rem;
        height: 23rem;
    }
    .danmu_fr.fullwindow {
        background: rgba(255,255,255,.8);
        margin-top: -6rem;
        height: 41.6rem;
        font-size: 6rem;
        width: 47.5rem;
    }
    .danmu_info {
      display: block;
      font-size: .6rem;
    }
    .danmu.fullscreen {
        background: rgba(0, 0, 0, .2);
        background-size: 120%;
    }
    .danmu_live {
        height: 90vh;
        width: 65vw;
        object-fit: contain;
        object-position: right;
        font-family: sans-serif;
        color: hsl(0, 0%, 40%);
        position: absolute;
        top: 5vh;
        right: 0;
        opacity: 0;
        z-index: -1;
    }
    .danmu_live.large {
        width: 90vw;
        height: 95vh;
        right: -2.5vw;
    }
    .danmu_live.rotate {
        transform: rotate(90deg);
        width: 120vh;
        height: 50vw;
        top: 5vh;
        right: -12.5vw;
    }
    .danmu_live.info {
        top: 0px;
        z-index: -2;
        opacity: .6;
    }
    .time {
      font-size: 16rem;
      font-variant-numeric: tabular-nums;
      font-weight: bold;
    }
    .tomato {
      font-size: 2rem;
      font-weight: bold;
    }
    .date {
      font-size: 2rem;
      font-weight: bold;
    }
    .weath {
      margin-top: 1rem;
      margin-left: -2rem;
      width: 22.5rem;
      height: 2.8rem;
      display: block;
      -webkit-transform: scale(2.6);
      transform: scale(2.6);
      -webkit-transform-origin: 0 0;
      transform-origin: 0 0;
    }
    .basket{
      margin-top: 6rem;
      font-size: 1rem;
      overflow: hidden;
      word-break: break-all;
      height: 2rem;
    }
    .tImg{
      content: url('data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAOUAAADUAgMAAAAegQyNAAAACVBMVEUAAAD///8AAABzxoNxAAAAAXRSTlMAQObYZgAABZ9JREFUaN7VmsuRnDAQQJnDhEA++OA7rlJzIATywRngKojS1jCtZ02PrEbrT1mH3UWrR//0o6WuXG4iMnRNpf+BhjZUYmki7yKtGvcPdGzUt9HYm5ylzVSMvWzqdKwYe83U5dgx9hp6HAfGXvLS/ANdG4y9R32PY2swtn/oG40dW0yNpcFPMTTHaWyTl6KxLeii6HCt636Opp5+0uLuuooe+lgX3mvLKUcdQZJXdNWK4Byl6uDoJy1uUxeDDnVTQb9lLh6voKsbpf+tZ2wivz/NrqLqnnWKAh8PWlNF1T2x/fagvqq7fKi21uD60IOyfgSVVlQ+hC5t6P7P0BmfNaLbvIkL3aY03GaGuwtdHwToJn40rTcyMexk8KFTQpmdOh+qvybmxOBF54RuTBIVdEnMKl9EmIgHD3rOTbtElNK5UC2fxMUyN+0FNFTn0hQMisNR9wLj8JRUSvAL9YvN1uSfidQvQlEo6ypdN/S6cPxCrEDCsl7+QuxN0BYWdC+L7bVVzlK5FWPLLoCSUN5UchIQMxvoXtC4fxGKklixvtcYoVlRFLHWv5lQuwQgdjCmGqG0nnnRO43pDW/EZi8Kb/TFG7ZT/ey2sr57CiatebQa98mivbDTW0oa8z8lzwpQ4cmYetDQdntCl8KDqVNqR3lnwYqxualrhk6K8mS+t3IJaD2rCYjVj0tMnbIYonJEQ4fY14/Lu+qbNsKIjajuk/nyAY0AW4CIDr2KXSN6srMxNtYnfY8nejZmwcBtmbFUypJQ2DHNIsursTdUmQ7QDpRpJH1JgzI0QW8sF8+n6dVPdzQ5QFmE8Igs+iVN3fNtMygLQnidg6jiC4VRGdGnWESINjQoc8OerMFU5oMoI/fSzminvZ2FMj/dtIIBalAGWKbUPamhhtq5i76Oi3EwOQG8WsgbgKqXFoSOlqMpLk67XoSWFv67osIOjQ84OlARja/HwezaazsV7cWKYupaIlWMdhl9EyjkL9CDMYyXNgx1oRNeWisb0GTWSKw29mSdBw0nOquDWbUr6Hai8kQX1jEHKqCPunq2ss9RwsoKWEbnZ2BTj9j1p3ROdHigOs5ZE2roYVAm52vo7Eka3hM6amdaH6hIcKJrhgqmXkH5XPyjKFmK6DPQzo2GB8oGJ7SjYzs6XEQXtlWdF91f0dGPRjECGrq/jU4xtC1onJk2D9qzo06pk/iiNnT6EHr8cXT5v1ABNcH5m2is2RpR+rAzMQrqHDk3i64fRcd2dGhEnSN9eouGdnRsR7vr6EKO3DHSfyO6OQ8t5WMo83B/DV0a0ZtBGea+fgg6u9G7gIYG1G4IBldYJ4MeDShbrtEd1nbUbi9Hb1gtGq6ibKWDNzYWFfe9AruBH/yxAV2cfcLkPBQdffcKcnSuBZYEEShxdkSnB41e5SO07uIs1xvwWzU6JBvR8a7oUDV1NqjU74+QBzYZgupHGXlgUFIaUr8DlIeVRAoo1g32XACU9A3taC0IxVTCQerKqBjreM2RoQTW+olPH5KtxEbfXsiPJ7G9YCpSSMuZJLeKJbFMbF7vIwUrVCScf6EvbiEFicYINScIBAMXc3yBdWueyAc16Vaq7s/WRuizoUnyktDU1psVioPxUzQ2kAHXkPF35iVQ1fgz5GyOZEBNGh0MQZC5g23y/kUoaWPjJXtkgFBb8BIoKTMTDAqmgjJjGXVNIZ9lDmWqJPksexS0HHvZTiYxsyasyHOZirEI9JjKJOsqNtVINOr6SuFg0aFvsMeZXn3HwiGqQ9/Be3RLYSYxxnrECqZmxs4OJ2FqPnl6hIr3SN4KDa6LAFao1ZfFrOpecV56sDGV4LtqYdWlP1ixpRtk5YMeHAUr7x7HX11m4cySRyat9is0Y9vFncpJT9u9HZxsiytn3aYuLFJ6LwlLUz+Jr0YeCx76DsxC7gxsfZb3AAAAAElFTkSuQmCC');
      height: 2rem;
      width: auto;
    }
    .inform {
      margin-top: 0.5rem;
      font-size: 1.5rem;
      font-weight: normal;
    }
    .reminder {
      display: none;
      margin: -25rem 10rem;
      padding: 1rem;
      max-height: 21rem;
      width: 22rem;
      position: absolute;
      border: dotted;
      background-color: rgba(255, 255, 255, .8);
      font-size: 1.5rem;
      font-weight: bold;
      overflow: scroll;
      z-index: 3;
    }
    .loader {
        display: inline-block;
        margin: 0 .5rem;
    }
    .bar {
        background-color: black;
        height: 10%;
        width: .4rem;
        float: left;
        margin-left: .1rem;
    }
    .gua {
        background-color: black;
        height: .2rem;
        width: .6rem;
        margin-top: .15rem;
        float: left;
    }
  </style>
</head>
<body onselectstart="return false">
  <div class="cleaner"><noscript><center>Javascript NOT support.</center></noscript></div>
  <div class="app"><div class="rotate">
    <div class="tickList" onclick="showIcs()"><div></div><img class="tImg" style="padding:1rem"><table></table></div>
    <div class="home" onclick="hUpdate()"><div style="padding-top: 3rem">HOME</div></div>
    <div style="height:6rem"></div>
    <div class="danmu_fr" onclick="danmuSwitch()"><span class="danmu_info"></span><span class="danmu"></span><video class="danmu_live">video live Only in #danmuOnly mode</video><div class="danmu_live info"></div></div>
    <div class="time"><span id="hour" onclick="switchTomato()">00:</span><span id="minute" onclick="pauseTomato()">00</span></div>
    <div class="tomato"><span class="old_date"></span><span class="loader"></span><span id="tom" onclick="runTime()">TOMA</span><span id="ato" onclick="initDateFromServer(true)">MATO</span></div>
    <div class="date" onclick="correctPrompt()">0月0日(零) 正月初一</div>
    <iframe class="weath" scrolling="no" frameborder="0" allowtransparency="true" src="" sandbox="allow-scripts" style="pointer-events: none;"></iframe>
    <div class="basket"></div>
    <div class="inform" onclick="fridgeTomato();weatherInterval();">同步时间：<span id="sync">0000-00-00 00:00:00</span> <span id="timeoffset">+0s</span> <span id="net">未同步</span></div>
    <div class="reminder" onclick="clearReminder()"></div>
  </div></div>
  <script src="mpegts.js"></script>
  <script>
"use strict";
var initialTitle = document.title;
var clearCommentTime = 0;
var basket = document.getElementsByClassName('basket')[0];
function comment(s, isJam) {
    var lag = 30 * 60 * 1000;
    s = s == undefined ? 'und' : String(s);
    setTimeout(clearComment, lag + 1000);
    if (basket.innerHTML.length == 0 || isJam)
        basket.innerHTML = s;
    else
        basket.innerHTML = (basket.innerHTML + '|' + s).slice(-150);
    clearCommentTime = new Date().getTime() + lag;
    return s;
}
function clearComment() {
    if (new Date().getTime() < clearCommentTime) return;
    basket.innerHTML = '';
}
function httpReq(path, f, fOnfailed, post, method, fOnBoth) {
    var xmlhttp = new XMLHttpRequest();
    xmlhttp.onreadystatechange = function () {
        if (xmlhttp.readyState == 4) {
            var s=xmlhttp.status;
            switch (String(s).slice(0,1)){
                case '2':
                case '3':
                    if (f)
                        f(xmlhttp.responseText, path);
                    break;
                case '0':
                case '4':
                case '5':
                    fOnfailed(s+(s?'Error(F12)':":CertConfirmMayRequire(F12)"), path);
                    break;
            }
            if (fOnBoth)
                fOnBoth();
        }
    }
    xmlhttp.open(method ? method : post ? 'POST' : 'GET', path);
    if (post)
        xmlhttp.setRequestHeader("Content-type", "application/json");
    xmlhttp.send(post);
}
function JsonParse(s, valueOnError){
    try {
        return JSON.parse(s);
    } catch (e) {
        console.warn('[JSON@'+dateString()+':Invalid] <'+s+'>');
        return valueOnError==undefined?false:valueOnError;
    }
}

setTimeout(function modulesControl(){
    var funcList = [['tomato', 'ticklist', 'danmu', 'home', 'lunaryear'],
    ['switchTomato', 'showIcs', 'danmuSwitch', 'hSwitch', 'getLunarDay']];
    for (var i in funcList[0])
        if (!hasModule(funcList[0][i]))
            eval(funcList[1][i] + '=' + 'function disabled(){comment("' + funcList[0][i] + ' is DISABLED");return "";}');
    if (!hasModule('home'))
        home.innerHTML = '';
});
var hash=location.hash;
var isDanmuOnly = hash != (hash = hash.replace(/#danmuonly/i, ''));
var isFastLoad = hash != (hash = hash.replace(/#fastload/i, ''))||isDanmuOnly;
if (isDanmuOnly){
    reduceShadow=function und(){};
    killShadow=reduceShadow;
    setTimeout(danmuOnly, 200);
} else {
    setTimeout(function autoStart(){
        if (!forTestUse)
            for (var i = 0; i < autostart.length; i++)
                [showIcs, danmuSwitch, hUpdate][['ticklist', 'danmu', 'home'].indexOf(autostart[i])]();
    });
}
setTimeout(function loadFromHash(){
    //resume task from #a()#b()
    var run = hash.split('#');
    for (var i = 0; i < run.length; i++)
        setTimeout(decodeURI(run[i]));
});
setTimeout(function isVisible(){
    function notVisible(){
        document.title="页面被遮挡";
        comment('页面被遮挡');
    }
    if (document.hidden || document.mozHidden || document.msHidden || document.webkitHidden)
        notVisible();
}, 10000);
/*
Note: #danmuOnly need css3 support.

# To skip password and get short link in Nginx reverse proxy 
location /kindle/ {
    access_log off;
    proxy_redirect      off;
    proxy_buffering     off;
    proxy_http_version  1.1;
    proxy_set_header Authorization "Basic c2hhcmU6c2hhcmUwMjRwYXNz";
    proxy_pass "http://NEEDTOCHANGE/PATH/TO/FOLDER/kindle/";
}
*/
var danmu_fr=document.getElementsByClassName('danmu_fr')[0];
var danmu_info=document.getElementsByClassName('danmu_info')[0];
var danmu=document.getElementsByClassName('danmu')[0];
var danmu_live = document.getElementsByClassName('danmu_live')[0];
var danmu_live_info=document.getElementsByClassName('danmu_live info')[0];
var isDanmuScrollInput=false;
var danmuScrollCurrentNum;
var danmuScrollNum='';

var isMouseHidden=false;
var mouseMoveTime=0;
//FullScreen
function danmuOnly(){
    danmuMax=4e3;
    isDanmuOnly=true;
    document.body.appendChild(danmu_fr);
    document.getElementsByClassName('app')[0].style.display='none';
    isDanmuFullWindow=true;
    danmu_info.style='font-size: '+(parseFloat(danmuFontSizeFullScreen[0])/1.5+danmuFontSizeFullScreen[1]);
    danmu_fr.classList.add('fullscreen');
    danmu_fr.style.fontSize=danmuFontSizeFullScreen.join('');
    document.getElementsByClassName('cleaner')[0].style.display='none';
    danmu.classList.add('fullscreen');
    danmu_live_info.style='font-size: '+(parseFloat(danmuFontSizeFullScreen[0])/1.7+danmuFontSizeFullScreen[1]);
    danmu_info.innerHTML='<br><br><br><center><big>Due to browser\'s requirement,<br>fullSceen & video need user-gesture to activate.<br><br><u><b>CLICK</b></u> once to start</big><center>';
    danmuAlter=function danmuAlterScreenOnly(beLess){
        if (!beLess){
            danmuRoomTime();
            if (isDanmuLive == 1) {
                danmuRead();
                danmuInfoUpdate();// on danmuRoomId change => danmuRoomTitle();
            }
        }
    };
    danmu_fr.onmousemove=function showMouse(){
        var t=4e3;
        var now=new Date().getTime();
        if (isMouseHidden){
            document.body.style.cursor='';
            isMouseHidden=false;
        }
        if (mouseMoveTime-now<500)
            setTimeout(function hideMouse(){
                if (!isMouseHidden&&new Date().getTime()+200-mouseMoveTime>t){
                    isMouseHidden=true;
                    document.body.style.cursor='none';
                }
            }, t);
        mouseMoveTime=now;
    };
    danmu_live.onpaused=function liveCheckStuck(){
        setTimeout(function act(){
            if (!isLiveOff()&&danmu_live.paused){
                liveInfo('stuckWarn', '', true);
                liveFromRoom('stuck');
            }
        }, (1+Math.random())*10e3);
    };
    danmu_live.onended=function liveAutoResume(){
        setTimeout(function act(){
            if (isLiveOff()&&danmuPop>1&&!liveRetry&&danmuRoomId){
                danmuWrite('['+dateString()+'@Resume] '+danmuRoomId);
                liveFromRoom('resume');
            }
        }, 10e3);
    };
    danmu_fr.onwheel=function changeVolume(e){
        event.preventDefault();
        var d=e.deltaY<0?1:-1;//~500
        if (isDanmuScrollInput)
            danmuScrollCurrentNum=((danmuScrollCurrentNum==undefined?0:danmuScrollCurrentNum)+d+10)%10;
        else
            liveChangeVolume(d/10);
        danmuInfo();
    }
    document.onkeydown=function fs(event){
        var e = event || window.event || arguments.callee.caller.arguments[0];
        if(e && e.keyCode==13){ // enter
            danmuFullScreen(true);
        } else if(e && e.keyCode==38 && e.keyCode==87){ // up, w
            liveChangeVolume(.2);
        } else if(e && e.keyCode==40 && e.keyCode==83){ // down, s
            liveChangeVolume(-.2);
        }
    };
}


//Lunar Year
var tgString = "甲乙丙丁戊己庚辛壬癸";
var dzString = "子丑寅卯辰巳午未申酉戌亥";
var numString = "一二三四五六七八九十";
var monString = "正二三四五六七八九十冬腊";
var sx = "鼠牛虎兔龙蛇马羊猴鸡狗猪";
var cYear, cMonth, cDay, cLastRecord;
var CalendarData = [0xA4B, 0x5164B, 0x6A5, 0x6D4, 0x415B5, 0x2B6, 0x957, 0x2092F, 0x497, 0x60C96, 0xD4A, 0xEA5, 0x50DA9, 0x5AD, 0x2B6, 0x3126E, 0x92E, 0x7192D, 0xC95, 0xD4A, 0x61B4A, 0xB55, 0x56A, 0x4155B, 0x25D, 0x92D, 0x2192B, 0xA95, 0x71695, 0x6CA, 0xB55, 0x50AB5, 0x4DA, 0xA5B, 0x30A57, 0x52B, 0x8152A, 0xE95, 0x6AA, 0x615AA, 0xAB5, 0x4B6, 0x414AE, 0xA57, 0x526, 0x31D26, 0xD95, 0x70B55, 0x56A, 0x96D, 0x5095D, 0x4AD, 0xA4D, 0x41A4D, 0xD25, 0x81AA5, 0xB54, 0xB6A, 0x612DA, 0x95B, 0x49B, 0x41497, 0xA4B, 0xA164B, 0x6A5, 0x6D4, 0x615B4, 0xAB6, 0x957, 0x5092F, 0x497, 0x64B, 0x30D4A, 0xEA5, 0x80D65, 0x5AC, 0xAB6, 0x5126D, 0x92E, 0xC96, 0x41A95, 0xD4A, 0xDA5, 0x20B55, 0x56A, 0x7155B, 0x25D, 0x92D, 0x5192B, 0xA95, 0xB4A, 0x416AA, 0xAD5, 0x90AB5, 0x4BA, 0xA5B, 0x60A57, 0x52B, 0xA93, 0x40E95];
var madd = [0, 31, 59, 90, 120, 151, 181, 212, 243, 273, 304, 334];
function GetBit(m, n) {
    return (m >> n) & 1;
}
function setLunarDay(TheDate) {
    if (!TheDate) TheDate = getOffsetDate();
    var total, m, n, k;
    var isEnd = false;
    var tmp = TheDate.getYear();
    cLastRecord = TheDate.getDate();
    if (tmp < 1900) {
        tmp += 1900;
    }
    total = (tmp - 1921) * 365 + Math.floor((tmp - 1921) / 4) + madd[TheDate.getMonth()] + TheDate.getDate() - 38;

    if (TheDate.getYear() % 4 == 0 && TheDate.getMonth() > 1) {
        total++;
    }
    for (m = 0; ; m++) {
        k = (CalendarData[m] < 0xfff) ? 11 : 12;
        for (n = k; n >= 0; n--) {
            if (total <= 29 + GetBit(CalendarData[m], n)) {
                isEnd = true; break;
            }
            total = total - 29 - GetBit(CalendarData[m], n);
        }
        if (isEnd) break;
    }
    cYear = 1921 + m;
    cMonth = k - n + 1;
    cDay = total;
    if (k == 12) {
        if (cMonth == Math.floor(CalendarData[m] / 0x10000) + 1) {
            cMonth = 1 - cMonth;
        }
        if (cMonth > Math.floor(CalendarData[m] / 0x10000) + 1) {
            cMonth--;
        }
    }
}
function getLunarDay(year, spirit, month, day, TheDate) {
    if (getOffsetDate().getDate() != cLastRecord)
        setLunarDay(TheDate);
    var tmp = "";
    var all = !(year || spirit || month || day);
    if (all || year)
        tmp += tgString.charAt((cYear - 4) % 10) + dzString.charAt((cYear - 4) % 12);
    if (all || spirit)
        tmp += sx.charAt((cYear - 4) % 12) + "年";
    if (all || month) {
        if (cMonth < 1) {
            tmp += "闰";
            tmp += monString.charAt(-cMonth - 1);
        } else {
            tmp += monString.charAt(cMonth - 1);
        }
        tmp += "月";
    }
    if (all || day) {
        tmp += (cDay < 11) ? "初" : ((cDay < 20) ? "十" : ((cDay < 30) ? "廿" : "三十"));
        if (cDay % 10 != 0 || cDay == 10) {
            tmp += numString.charAt((cDay - 1) % 10);
        }
    }
    return tmp;
}


/*                Time Display & Weather                */
var refreshRate = 8 * 3600 * 1000;
var hardwareLagRate = 6.66;//+1s/6.66h
var lastSyncTime = 0;
var timeOffset = 0;
var preventDecreaseShadow = false;//Stop when tomato
var lessDisturbUpdateWhenTomato = false;//less time update flash when tomato
var initTime = new Date().getTime();
var initTimeOffset = 0;
var averageTimeOffset = [0, 0];
var hasClockInit = false;
var networkFaliure = false;
var nextCmdList = 0;
var cmdListCount = 0;
var cmdList = {};
var tickListAlarm = '';
var timeAnimationInterval;
if (!isFastLoad) {
    initDateFromServer();
    adjustAgainstHardwareTimeLag();//extra offset cycle
    initClockWeather();
}
initBrowserPage();

function adjustAgainstHardwareTimeLag() {
    if (hasClockInit) timeOffset += 1000;
    addTaskOnPageChange("adjustAgainstHardwareTimeLag()", hardwareLagRate * 3600 * 1000, true);//add 1s offset every xxx hour
}
function initDateFromServer(force) {
    //timeDateByBlive ?time returns timestamp
    httpReq('/blive/?time', function s(a) {averageTimeOffset=[parseInt(a) - new Date().getTime(),1]; sumDateFromServer(true)});
    //Alternative: compare time from HEAD 20 times due to its 1s precision
    setTimeout('if (!timeOffset||'+force+') sumDateFromServer()', 500);
}
function sumDateFromServer(calculate) {
    if (calculate) {
        if (!averageTimeOffset[0]) return false;
        var oldHardwareLagRate = hardwareLagRate;
        var dOffsetPerSecond = "";
        var dTimeOffset = 0;
        var uptime = new Date().getTime() - initTime;
        timeOffset = Math.floor(averageTimeOffset[0] / averageTimeOffset[1]);
        if (!initTimeOffset && timeOffset) initTimeOffset = timeOffset;
        if (Math.abs(timeOffset - initTimeOffset) > 200) {
            dTimeOffset = timeOffset - initTimeOffset;
            if (uptime > 3600 * 1000) {
                var newHardwareLagRate = Math.floor((uptime / 1000 / 3600) / (dTimeOffset / 1000) * 100) / 100;
                dOffsetPerSecond = "1s/" + newHardwareLagRate + "h" + "(" + oldHardwareLagRate + ")";
                if (uptime > 3 * 24 * 3600 * 1000) hardwareLagRate = newHardwareLagRate;
            }
        }
        dTimeOffset = dTimeOffset ? "(" + timeFormat(dTimeOffset) + ")" : "";
        console.log(comment(timeOffsetFormat(2) + dTimeOffset + "#" + dOffsetPerSecond + "#" + timeFormat(uptime, 3, true) + ""));
        document.getElementById('timeoffset').innerHTML = timeOffsetFormat();
        initClockWeather();//immediately after date time got from server
        return true;
    } else {
        averageTimeOffset = [0, 0];
        for (var i=0;i<=20;i++)
            setTimeout('singleDateFromServer(' + i + ')', 50*i);
    }
}
function singleDateFromServer(n) {
    var xmlhttp = new XMLHttpRequest();
    xmlhttp.open("HEAD", noCache(), true);
    xmlhttp.onreadystatechange = function () {
        if (xmlhttp.readyState == 4) {
            if (networkFaliure) {
                networkFaliure = false;
                return;
            }
            if (n >= 20) {
                sumDateFromServer(true);
                return;
            }
            if (xmlhttp.status != 0) {
                var serverTime = new Date(xmlhttp.getResponseHeader("Date")).getTime();
                var clientTime = new Date().getTime();
                averageTimeOffset[0]+=serverTime - clientTime + 2300;
                averageTimeOffset[1]++;
                timeOffset = Math.floor(averageTimeOffset[0] / averageTimeOffset[1]);//preset lag==>+1s(screen refresh time)
                console.log(frontZero(n + 1) + "#" + Math.floor(serverTime / 1e5) + ":S" + serverTime % 1e5 / 1000 + ".:C" + clientTime % 1e5 / 1000 + ":" + timeOffsetFormat());
                //comment("Calculating..." + timeOffsetFormat(3), true);
            } else {
                networkFaliure = true;
                comment("Failed(ServerTime)#1s/" + hardwareLagRate + "h(" + timeOffsetFormat(3) + ")");
            }
        }
    }
    xmlhttp.send(null);
}
function addTaskOnPageChange(cmd, interval, isTimeout) {
    var t = getOffsetTime(interval);
    var tag = String(cmd);
    if (isTimeout) interval = true;
    if (cmdList[tag] != undefined)
        cmdList[tag] = [cmdList[tag][0], interval, t];
    else {
        tag = tag.slice(0, 4) + frontZero(++cmdListCount, 3);
        cmdList[tag] = [cmd, interval, t];
    }
    refreshTaskOnPageChange();
    return tag;
}
function runTaskOnPageChange() {
    //nextCmdList=1500, cmdList={tag0:['f()', interval, end], tag1:['f()', 86400*1000, 15000000], tag2:['',true,1500]};
    try {
        var t = getOffsetTime();
        if (nextCmdList - 59 * 1000 < t) {
            nextCmdList = 0;
            for (var i in cmdList) {
                if (cmdList[i][2] - 59 * 1000 < t) {
                    if (typeof cmdList[i][0] == 'function')
                        cmdList[i][0]();
                    else
                        eval(cmdList[i][0]);
                    if (cmdList[i][1] === true)
                        cmdList[i][1] = false
                    else
                        cmdList[i][2] = getOffsetTime(cmdList[i][1]);
                }
            }
            refreshTaskOnPageChange();
        }
    } catch (e) {
        //document.title = e.stack.replace(/ /g, '');
        comment(e);
    }
}
function deleteTaskOnPageChange(tId) {
    if (tId) delete cmdList[tId];
}
function refreshTaskOnPageChange() {
    for (var i in cmdList)
        if (cmdList[i][1] === false)
            deleteTaskOnPageChange(i);
        else
            if (nextCmdList == 0 || cmdList[i][2] < nextCmdList)
                nextCmdList = cmdList[i][2];
}
function initBrowserPage() {
    setIcon();
    killShadow();
    addTaskOnPageChange("killShadow()", 86300 * 1000);//24*3600=86400 & 1700 --> 17*24*3600
    addTaskOnPageChange("reduceShadow()", 3100 * 1000);//prime number 60*60=3600
}
function initClockWeather() {
    if (hasClockInit) return;//avoid duplicated init clock;
    hasClockInit = true;
    updateInterval();
    weatherInterval();
    timeAnimation(forTestUse?15:undefined);
}
function setIcon() {
    for (var i in document.styleSheets)
        for (var j in document.styleSheets[i].cssRules)
            if (document.styleSheets[i].cssRules[j].selectorText == '.tImg') {
                document.getElementById('ico').href = document.styleSheets[i].cssRules[j].style.content.slice(5, -2);
                return true;
            }
    return false;
}
function tasks(f, l, t, isLag, i) {
    if (i == undefined) i = 0;
    if (i < (Array.isArray(l)?l.length:l)) {
        if (!isLag)
            f(Array.isArray(l)?l[i++]:i++);
        setTimeout(function a() {tasks(f, l, t, false, i)}, t);
    }
}
function killShadow(force) {
    var t = 400;
    var cleaner = document.getElementsByClassName('cleaner')[0].style;
    if (force || !preventDecreaseShadow) {
        tasks(function a(e) {cleaner.display = e}, ["", "", "none"], t);
        tasks(function b(e) {cleaner.background = e}, ["", "white", ""], t);
        tasks(function c(e) {document.body.style.color = e}, ["", "", "", "white", ""], t);
    }
}
function reduceShadow() {
    if (!preventDecreaseShadow)
        tasks(function a(e) {document.getElementsByClassName('time')[0].style.opacity = e}, [0, 1], 600);
}
function runTime(n) {return comment(timeFormat(new Date().getTime() - initTime, n ? n : 3, true));}
function noCache() {return "?noCache=" + document.body.clientWidth + "." + document.body.clientHeight + "." + ("" + Math.random()).slice(2, 9);}
function frontZero(a, n) {
    if (!n) n = 2;
    if (typeof a != 'object')
        a = [a];
    for (var i = 0; i < a.length; i++)
        if (typeof a[i] == 'number' || !isNaN(parseInt(a[i]))) {
            a[i] = a[i].toString();
            for (var j = n - a[i].length; j > 0; j--)
                a[i] = '0' + a[i];
        }
    return a.join('');
}
function timeFormat(s, n, noPlus) {
    s = Math.floor(s);
    if (s == 0) return "";
    if (!n) n = 3;
    var str = "";
    var a = "";
    if (s > 0)
        a = "+";
    else {
        a = '-';
        s = -s;
    }
    if (s < 1000)
        str = "." + frontZero(s, 3) + "s";
    else {
        var f = [[10, 100, 60, 60, 24, 365, 100, 10], ["", "s", "m", "h", "d", "Y", "C", "T"]];
        var fsum = 1;
        for (var i in f[0])
            fsum *= f[0][i];
        for (var i = f[0].length - 1; i > 0 && n > 0; i--) {
            if (s >= fsum) {
                str += Math.floor(s / fsum) + f[1][i];
                s %= fsum;
                n--;
            }
            fsum /= f[0][i];
        }
        if (s != 0 && n > 0)
            str += frontZero(Math.floor(s / fsum), 2) + f[1][0];
    }
    return (!noPlus || a == '-' ? a : "") + str;
}
function timeOffsetFormat(n) {return timeFormat(timeOffset, !n ? 2 : n);}
function how() {
    var inspect = ['runTime(2)', 'weeklyTomato.length', 'countIcs()', 'hardwareLagRate'];
    var o = '';
    var res;
    for (var i = 0; i < inspect.length; i++) {
        res = eval(inspect[i]);
        if (typeof res == 'number' && res > 5 * 60 * 1000)
            res = timeFormat(res, 2, true);
        o += inspect[i].slice(0, 6) + ':' + res + ',';
    }
    o += '[' + (Object.keys(cmdList).length - 1) + ',' + dateString(nextCmdList) + ']:';
    for (var i in cmdList)
        o += i + (cmdList[i][1] !== true ? ',' + timeFormat(cmdList[i][1], 2, true) + ',' : 'T') + dateString(cmdList[i][2]) + '|';
    return o.slice(0, -1);
}
function wipe() {basket.innerHTML = '';}
function test() {
    forTestUse=true;
    document.getElementsByClassName('weath')[0].src = "about:blank";
    comment(how());
    testIcs();
    timeAnimation(15);
    setInterval('timeOffset+=57*1000;update()', 100);
}
function f5(href, append) {
    location.replace(location.protocol + '//' + (href ? href : location.hostname + location.pathname) + (append ? append : ''));
    location.reload();
}
var help = {
    vari: ['who', 'credit', 'help'],
    func: ['how', 'wipe', 'test', 'testIcs', 'f5'],
    who: navigator.userAgent,
    credit: JSON.stringify(info).replace(/"/g, '')
};
[].push.apply(help.help = help.func, help.vari);
function correctPrompt() {
    var userInput = prompt('Change kindle time: [;st ' + dateString('YMdhm') + ']\nDisable sleep: [~ds]\nPlease INPUT Time (hhmmss) or Cmd:\n' + 'Format: [' + dateString('hms').replace(/:/g, '') + '] ([123456] means reset)\nCMDs: [' + help.help+']');
    if (!timeCorrect(userInput))
        try {
            if (help.vari.indexOf(userInput) != -1)
                userInput = 'help.' + userInput;
            else if (help.func.indexOf(userInput) != -1)
                userInput += '()';
            comment(eval(userInput));
        } catch (e) {
            comment('<span style="color:maroon">' + e + '</span>');
        }
}
function timeCorrect(correct) {//000000~235959
    if (!correct || correct.length != 5 && correct.length != 6) return false;
    if (correct == "123456")
        timeOffset = 0;
    else {
        var hms = [correct.slice(-6, -4), correct.slice(-4, -2), correct.slice(-2)];
        var allow = [[0, 23], [0, 59], [0, 59]];
        for (var i = 0; i < hms.length; i++) {
            hms[i] = Math.floor(parseInt(hms[i]));
            if (!(hms[i] >= allow[i][0] && hms[i] <= allow[i][1])) return false;
        }
        var date = new Date();
        date.setMinutes(date.getMinutes() + date.getTimezoneOffset() + 480);
        timeOffset = (((hms[0] - date.getHours()) * 60 + (hms[1] - date.getMinutes())) * 60 + (hms[2] - date.getSeconds())) * 1000;
    }
    update();
    return true;
}
function getOffsetDate(offset, noShift) {
    var date = new Date();
    if (typeof offset != 'number') offset = 0;
    if (!noShift) date.setMinutes(date.getMinutes() + date.getTimezoneOffset() + 480);
    date.setMilliseconds(date.getMilliseconds() + timeOffset + offset);
    return date;
}
function getOffsetTime(offset, noShift) {
    return getOffsetDate(offset, noShift).getTime();
}
function updateInterval() {
    var mscs = getOffsetTime();
    setTimeout("updateInterval()", lessDisturbUpdateWhenTomato ? ((599999 - mscs % 600000) + 50) : (59999 - mscs % 60000) + 50);//(60*10)*1000+50

    runTaskOnPageChange();
    update();
}
function update() {
    var date = getOffsetDate();
    if (timeOffset == 0)//fix the bug on kindle
        date.setMinutes(date.getMinutes() + 1);
    var hour = document.getElementById("hour");
    var minute = document.getElementById("minute");
    var calendar = document.getElementsByClassName("date")[0];
    var old_date = document.getElementsByClassName("old_date")[0];
    hour.innerHTML = frontZero(date.getHours()) + ':';
    minute.innerHTML = frontZero(date.getMinutes());
    var weekday = '日一二三四五六'[date.getDay()];
    calendar.innerHTML = (date.getMonth() + 1) + '月' + date.getDate() + '日'
        + (hasModule('lunaryear') ? '(' + weekday + ') ' + getLunarDay(false, false, true, true) : ' 星期' + weekday)
        + '<span style="font-size:1.5rem;position:absolute;"> ' + (forTestUse ? '#envTest' : '') + ' ' + tickListAlarm + "</span>";
    old_date.innerHTML = "子丑寅卯辰巳午未申酉戌亥"[Math.floor((date.getHours()>=23?0:date.getHours()+1)/2)];// + "初正"[1-date.getHours()%2];
    return date;
}
function weatherInterval() {
    var date = getOffsetDate();
    var nextRefresh = 0;
    document.getElementById('net').innerHTML = '初始化同步';
    if (date.getTime() - lastSyncTime > refreshRate + 100000)
        nextRefresh = 10 * 60 * 1000;
    else if (date.getHours() + refreshRate / 1000 / 3600 < 24)
        nextRefresh = refreshRate;
    else//calculate time till 00:00
        nextRefresh = 24 * 3600 * 1000 - date.getTime() % (24 * 3600 * 1000) + 50;
    addTaskOnPageChange("weatherInterval()", nextRefresh, true);

    if (date.getTime() - lastSyncTime > 10000)
        setTimeout(function onlineWeather() {
            var _doc = document.body;
            var script = document.createElement('img');
            script.setAttribute('src', '//www.163.com/favicon.ico' + noCache());
            _doc.appendChild(script);
            script.onload = script.onreadystatechange = function () {
                weather(!this.readyState || this.readyState == 'loaded' || this.readyState == 'complete');
                script.onload = script.onreadystatechange = null;
            }
            _doc.removeChild(script);
        }, 10);
}
function weather(connected) {
    if (!connected)
        document.getElementById('net').innerHTML = '无网络连接';
    var date = getOffsetDate();
    lastSyncTime = date.getTime();
    if (!forTestUse && isOnKindle){
        var ifrm = document.getElementsByClassName('weath')[0];
        ifrm.src = "//i.tianqi.com/index.php?c=code&id=2&bdc=%23&icon=5&num=3&site=15";//change iframe
        document.getElementById('net').innerHTML = '完成上一次同步';
    } else {
        console.warn('[iframeRefresh:disabled] notTestAndWindows');
        document.getElementById('net').innerHTML = '测试模式';
    }
    document.getElementById('sync').innerHTML = date.getFullYear() + '-' + frontZero([date.getMonth() + 1, '-', date.getDate(), ' ', date.getHours(), ':', date.getMinutes(), ':', date.getSeconds()]);
    document.getElementById('timeoffset').innerHTML = timeOffsetFormat();
}
function timeAnimation(sixty, isAlter){
    clearTimeout(timeAnimationInterval);
    var loader=document.getElementsByClassName('loader')[0];
    if (!sixty)
        sixty=60;
    if (isAlter){
        // 00 -> 10 -> 11 -> 01 -> 00
        var base=6;
        var frames=15;// 1/(60/2/base/frames)=3fps
        var growth=range(10, 50, frames+1, function act(i){return i+"%"});// 2 3 2 1

        if (!timeAnimationInterval){
            loader.innerHTML='<div style="height: 2rem; transform: scaleY(-1)">'
                +repeat('<div class="bar"></div>', base)+"</div>";
        }
        var seconds=getOffsetTime()/1e3%sixty;
        var circle=sixty/2/base;
        var next=(circle-seconds%circle)*1e3;
        //console.log(Math.floor(seconds/circle)%base, circle-seconds%circle, circle, seconds);
        tasks(function act(e){
            loader.children[0].children[Math.floor(seconds/circle)%base].style.height=e;
            }, (seconds<(sixty/2)?growth:growth.reverse()).slice(1), circle/frames*1e3, true);
    } else {
        // bagua
        var loader=document.getElementsByClassName('loader')[0];
        if (!timeAnimationInterval){
            loader.innerHTML='<div style="width: 1.5rem">'+repeat('<div class="gua"></div><div class="gua" style="width: .3rem"></div><div class="gua"></div>', 6)+'</div>';
        }

        var state=decBin(getOffsetTime()/1e3%sixty/sixty*64, 6);
        var next=sixty/64;
        for (var i=0;i<state.length;i++)
            loader.children[0].children[i*3+1].style.opacity=state[i]?"1":"0";
    }
    timeAnimationInterval=setTimeout("timeAnimation("+sixty+", "+isAlter+")", next+10);//bug on timer activate 0.000999927520751s earlier

    function decBin(d, n){
        var r=[];
        var s=Math.floor(d).toString(2);
        var l=s.length;
        for (var i=0;i<l;i++)
            r.push(s[i]=="1"?1:0);
        for (var j=r.length;j<n;j++)
            r.unshift(0);
        return r;
    }

    function range(start, end, n, f){
        var res=[];
        for (var i=start;i<=end;i+=(end-start)/(n-1))
            res.push(f(i));
        return res;
    }

    function repeat(s, n){
        var r='';
        for (;n>0;n--)
            r+=s;
        return r;
    }
}


/*                TOMATO: Tomato Timer                */
var toStatus, ispaused, weeklyTomato = [];
var timerEntity;
var signalTired = 0;
var toWorkTimer = 25 * 60;//Second
var timerEnd, restWhenPaused;
var toRestTimer = 5 * 60
var expireTomato = 30;//Day
var tomatoMsg = [document.getElementById('tom'), document.getElementById('ato')];
var buttonStyle = [document.getElementById('hour').style, document.getElementById('minute').style]
var shinningSignal = [document.getElementById('ato').style, document.getElementsByClassName('inform')[0].style, document.getElementsByClassName('date')[0].style];
var isHomeShrink = false;
//dumpTomato();gatherTomato(719);
function dumpTomato() {rottenTomato(-1);}
function gatherTomato(fakeTomatos) {
    if (!weeklyTomato.length) eatTomato();
    if (fakeTomatos)
        for (var i = 0; i < fakeTomatos; i++)
            weeklyTomato.push(-1);
    else
        weeklyTomato.push(Math.floor(new Date().getTime() / (24 * 3600 * 1000)));
    canTomato();
    showTomato("Gather");
}
function canTomato() {document.cookie = "tomato=" + compressTomato() + ";expires=" + new Date(0x7fffffff * 1e3).toUTCString();}
function compressTomato() {
    var compressed = "";
    for (var i = 0; i < weeklyTomato.length; i++) {
        if (i != 0) compressed += '.';
        compressed += Math.floor(weeklyTomato[i]).toString(36);
    }
    return compressed;
}
function showTomato(source) {
    basket.textContent = "";
    var f = [1, 2, 20, 60, 180];
    var res = 0;
    var tomatos = weeklyTomato.length;
    for (var i = f.length - 1; i >= 0 && tomatos != 0; i--) {
        res = Math.floor(tomatos / f[i]);
        tomatos %= f[i];
        for (var j = 0; j < res; j++)
            enchantTomato(basket, ['opacity: 0.5;', "", 'border:0.1rem dashed black;', 'border:0.1rem solid black;', 'border:0.1rem solid black; background-color: #c0c0c0'][i]);
    }
    if (weeklyTomato.length != 0) basket.insertAdjacentHTML("beforeend", weeklyTomato.length);
    logTomato(source);
}
function enchantTomato(e, magicType) {
    var script = document.createElement('img');
    script.setAttribute('class', 'tImg');
    if (magicType) script.setAttribute('style', magicType);
    e.appendChild(script);
}
function eatTomato() {
    var offset = document.cookie.indexOf("tomato=");
    var end = document.cookie.indexOf(";", offset);
    if (offset != -1) {
        offset += "tomato=".length
        if (end == -1) end = document.cookie.length;
        var content = document.cookie.substring(offset, end);
        if (content) {
            weeklyTomato = Array();
            content = content.split(".");
            for (var i in content)
                if (parseInt(content[i], 36))
                    weeklyTomato.push(parseInt(content[i], 36));
        }
        logTomato("Read");
    }
}
function logTomato(source) {
    if (weeklyTomato.length == 0)
        console.log("Empty >ToMaMaTo< Store from " + source);
    else
        console.log("Len:" + weeklyTomato.length + " " + source + ":" + weeklyTomato.slice(0, 5));
}
function rottenTomato(expire) {
    var date = Math.floor(new Date().getTime() / (24 * 3600 * 1000)) - (!expire ? expireTomato : expire);
    weeklyTomato.sort(function (a, b) {return b - a;});
    for (var i = 0; i < weeklyTomato.length; i++)
        if (weeklyTomato[i] < date) {
            weeklyTomato = weeklyTomato.slice(0, i);
            break;
        }
    canTomato();
    setTimeout("rottenTomato()", expireTomato * 24 * 3600 * 1000 / 3);
    showTomato("Rotten");
}
function updateMsg(tom, sliceIndex) {
    if (tom) {
        if (sliceIndex) tom += tomatoMsg[0].innerHTML.slice(sliceIndex);
        if (tom.slice(-2) != ": ") tom += ": "
        tomatoMsg[0].innerHTML = tom;
    }
    var s = Math.round((timerEnd - new Date().getTime()) / 1000);
    var timeString = "" + frontZero(Math.floor(s / 60)) + ":" + frontZero(s % 60);
    if (!document.hidden) {
        tomatoMsg[0].style.background = toStatus == 'work' ? 'gray' : '';
        tomatoMsg[1].innerHTML = timeString;
    } else
        document.title = timeString + (toStatus == 'work' ? " <TOM" : " <ATO");
}
function fridgeTomato() {
    killShadow();
    tomatoMsg[0].style.background = '';
    tomatoMsg[0].innerHTML = toStatus && toStatus != 'stop' ? 'MATO' : 'TOMA';
    tomatoMsg[1].innerHTML = toStatus && toStatus != 'stop' ? 'TOMA' : 'MATO';
    prepareTomato();
    document.title = initialTitle;
    if (isHomeShrink) {
        isHomeShrink = false;
        var butts = document.getElementsByClassName('h_switch');
        for (var i = 0; i < butts.length; i++)
            butts[i].style.height = '';
    }
}
function prepareTomato() {
    //quit from tomato
    preventDecreaseShadow = false;
    lessDisturbUpdateWhenTomato = false;
    killShadow();
    toStatus = 'stop';//work,rest,stop
    ispaused = false;
    eatTomato();
    clearTimeout(timerEntity);
    updateButton();
}
function switchTomato() {
    if (!toStatus) {
        prepareTomato();
        showTomato('INIT');
    }
    switch (toStatus) {
        case 'stop':
            toStatus = 'work';
            setTimer();
            preventDecreaseShadow = true;
            lessDisturbUpdateWhenTomato = true;
            timerEnd = new Date().getTime() + toWorkTimer * 1000;
            updateMsg("番茄开始");
            updateButton();
            if (!isHomeShrink) {
                isHomeShrink = true;
                var butts = document.getElementsByClassName('h_switch');
                for (var i = 0; i < butts.length; i++)
                    butts[i].style.height = '8rem';
            }
            break;
        case 'work':
            toStatus = 'rest';
            restWhenPaused = toRestTimer * 1000;
            timerEnd = new Date().getTime() + restWhenPaused;
            clearTimeout(timerEntity);
            updateMsg("番茄中场");
            pauseTomato();
            break;
        case 'rest':
            toStatus = 'work';
            restWhenPaused = toWorkTimer * 1000;
            timerEnd = new Date().getTime() + restWhenPaused;
            clearTimeout(timerEntity);
            updateMsg("番茄工作");
            pauseTomato();
            break;
    }
}
function setTimer() {
    clearTimeout(timerEntity);
    timerEntity = setTimeout(function tomatoTimer() {
        if (timerEnd < new Date().getTime()) {
            if (toStatus == 'work')
                gatherTomato();
            switchTomato();
        } else {
            updateMsg();
            setTimer();
        }
    }, 1000);
}
function updateButton() {
    buttonStyle[1].color = (ispaused) ? '#303030' : '#a9a9a9';
    if (toStatus == 'stop') buttonStyle[1].color = '#000000';
    buttonStyle[0].color = ['#000000', '#303030', '#a9a9a9'][['stop', 'work', 'rest'].indexOf(toStatus)];
}
function updateSignal() {
    if (ispaused && toStatus != 'stop') {
        if (signalTired > toWorkTimer) {
            document.title = initialTitle;
            for (var i = 0; i < shinningSignal.length; i++)
                shinningSignal[i].color = '#000000';
        } else {
            if (signalTired % 2 == 0) {
                document.title = '✔ * * * ✔';
                for (var i = 0; i < shinningSignal.length; i++)
                    shinningSignal[i].color = '#ffffff';
            } else {
                document.title = '* RELAX *';
                for (var i = 0; i < shinningSignal.length; i++)
                    shinningSignal[i].color = '#000000';
            }
            if (signalTired == 0 || signalTired == toWorkTimer)
                killShadow(true);
            signalTired++;
            setTimeout('updateSignal()', 800);
        }
    } else {
        signalTired = 0;
        document.title = initialTitle;
        for (var i = 0; i < shinningSignal.length; i++)
            shinningSignal[i].color = '#000000';
    }
}
function pauseTomato() {
    if (!toStatus || toStatus == "stop") return;
    ispaused = !ispaused
    if (ispaused) {
        clearTimeout(timerEntity);
        restWhenPaused = timerEnd - new Date().getTime();
        updateMsg("暂停", -4);
    } else {
        setTimer();
        timerEnd = new Date().getTime() + restWhenPaused;
        updateMsg("番茄", -4);
    }
    updateButton();
    updateSignal();
}


/*                TICKLIST: Ticktick Reminder
Note: you need set a Nginx server to proxy the GET method to the
        calendar server to download the .ics file. Add those lines
        to your Nginx config file to avoid CORS problem as the
        request directly from your browser is banned for some
        security reason.
        
location /ics/ {
    proxy_redirect off;
    proxy_buffering off;
    proxy_http_version 1.1;
    proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
    proxy_set_header Upgrade $http_upgrade;
    proxy_set_header Connection $http_connection;
    add_header Access-Control-Allow-Methods *;
    add_header Access-Control-Allow-Credentials true;
    add_header Access-Control-Allow-Origin $http_origin;
    if ($request_method = OPTIONS){
    return 200;
    }
    access_log off;
    proxy_pass https://XXX/pub/calendar/feeds/XXXXX/basic.ics;
}
*/
var tickList = {};
var tickListStatus = 0;
var tickListTaskIndex = 0;
var tickListMaxLine = 21;
var tickListReminderList = {};
var reminder = document.getElementsByClassName('reminder')[0];
function dDay(t) {return dHour(t, 24);}
function dHour(t, h) {return parseInt(dMs(t, (!h ? 1 : h) * 3600 * 1000));}
function dMs(t, ms) {return (t - getOffsetTime()) / (!ms ? 1 : ms);}
function dateString(timeStamp, format) {
    var s = '';
    var all = 'YMdhms';
    var date = getOffsetDate();
    if (timeStamp)
        if (String(timeStamp).match(/\d/))
            date = new Date(timeStamp);
        else if (!format)
            format = timeStamp;
    if (!format) format = 'hm';
    var res = [date.getFullYear(), date.getMonth() + 1, date.getDate(), date.getHours(), date.getMinutes(), date.getSeconds()];
    for (var i = 0; i < all.length; i++)
        if (format.indexOf(all[i]) != -1)
            s += frontZero([res[i], '-- :: '[i]]);
    return s.slice(0, -1);
}
function randInt(n, from) {if (from == undefined) from = 0; return Math.ceil(Math.random() * (n - from)) + from;}
function countIcs() {
    var b = [];
    for (var i = 0; i < tickList.length; i++)
        b.push(tickList[i].length);
    return b;
}
function testIcs(n) {
    var s = '';
    if (!n) n = 16;
    var d = new Date();
    d.setMinutes(d.getMinutes() + d.getTimezoneOffset() + 15 + 1);
    for (var i = 0; i < n; i++)
        s += "BEGIN:VEVENT\nDTSTART:" + (2018 + randInt(3)) + frontZero(randInt(12, 1)) + '01T020304Z\nSUMMARY:Default\nDESCRIPTION:e\n'
            + "BEGIN:VEVENT\nDTSTART:" + d.getFullYear() + frontZero([d.getMonth() + 1, d.getDate(), 'T', d.getHours(), randInt(59, 0)]) + '08Z' + '\nSUMMARY:Default\nDESCRIPTION: e' + space(5) + '测试测试测试测试测试测试测试测试测试测试' + '\nRRULE:FREQ=WEEKLY;INTERVAL=3\n';
    readIcs(s);
    tickListStatus++; showIcs(true);
}
function getIcs() {httpReq("/ics/", function a(s) {readIcs(s); showIcs(true);}, comment);}
function readIcs(s) {
    s = s.replace(/\r/g, '').split('\n');
    var r = [];
    var tag = ['DTSTART', 'DTSTART;VALUE=DATE', 'SUMMARY', 'DESCRIPTION', 'TRIGGER', 'RRULE', 'DTSTART;TZID=Asia/Shanghai'];//TIMEZONE-NOTE
    for (var i = 0; i < s.length; i++) {
        var splitter = s[i].indexOf(':');
        var line = [s[i].slice(0, splitter).trim(), s[i].slice(splitter + 1).trim()];
        if (line[0] == 'BEGIN') {
            if (line[1] == 'VEVENT')
                r.push({});
        } else if (tag.indexOf(line[0]) != -1 && r.length != 0 && r[r.length - 1][line[0]] == undefined) {
            switch (line[0]){
            case tag[6]:
                line[0]=tag[0];
            case tag[0]:
                line[1] = Date.parse(line[1].slice(0, 4) + '-' + line[1].slice(4, 6) + '-' + line[1].slice(6, 11) + ':' + line[1].slice(11, 13) + ':' + line[1].slice(13) + (line[1].slice(-1).toUpperCase()!='Z'?'Z':'')) + (new Date().getTimezoneOffset() + 480) * 60 * 1000;//TIMEZONE-NOTE
                break;
            case tag[1]:
                line[0] = tag[0]
                line[1] = Date.parse(line[1].slice(0, 4) + '-' + line[1].slice(4, 6) + '-' + line[1].slice(6, 8) + 'T08:00:00Z');
                r[r.length - 1]['isDateOnly'] = true;
                break;
            case tag[3]:
                for (var j = i + 1; j < s.length && s[j][0] == ' '; j++)
                    line[1] += s[j].slice(1);
                line[1] = line[1].replace(/\\n|\\|\n/g, '').trim();
                if (line[1].slice(0, 2) == '- ' && line[1].indexOf(' - ') != -1)
                    line[1] = line[1].slice(2).replace(/ - /g, ' / ');
                break;
            case tag[5]:
                r[r.length - 1]['FREQ'] = '';
                line[1] = line[1].split(';');
                for (var j in line[1]) {
                    line[1][j] = line[1][j].split('=');
                    if (line[1][j][0] == 'FREQ')
                        r[r.length - 1]['FREQ'] += '年月周日'[['ANNUALLY', 'MONTHLY', 'WEEKLY', 'DAILY'].indexOf(line[1][j][1])];
                    else if (line[1][j][0] == 'INTERVAL')
                        r[r.length - 1]['FREQ'] = (line[1][j][1] <= 9 ? '零一两三四五六七八九'[parseInt(line[1][j][1])] : line[1][j][1]) + r[r.length - 1]['FREQ'];
                }
                continue;
            }
            r[r.length - 1][line[0]] = line[1];
        }
    }
    sortIcs(r, 1);
    return tickList;
}
function sortIcs(r, sortNum) {
    clearReminder(true);
    tickList = {important: [], normal: [], noDate: []};
    var func = [[function (d) {return d > -14},
    function (a, b) {return b.DTSTART - a.DTSTART}],
    [function (d, freq) {return d >= (freq ? -7 : -14) && d <= (freq ? 3 : 90)},
    function (a, b) {
        var c = [a.DTSTART, b.DTSTART];
        var d = [a, b];
        for (var i = 0; i < c.length; i++) {
            c[i] -= getOffsetTime();
            var isNeg = c[i] != (c[i] = Math.abs(c[i]));
            c[i] *= (isNeg ? c[i] > 180 ? 3 : 2 : 1) * (d[i].isDateOnly ? c[i] > 180 ? 6 : 3 : 1) * (d[i].FREQ ? c[i] > 4 ? 8 : 3 : 1);
        }
        return c[0] - c[1];
    }]][sortNum];
    for (var i = 0; i < r.length; i++)
        if (r[i].DTSTART) {
            var dD = dDay(r[i].DTSTART);
            if (dD<=0&&dD>-3)
                alarmIcs(r[i]);
            if (func[0](dD, r[i].FREQ))
                tickList.important.push(r[i]);
            else
                tickList.normal.push(r[i]);
        } else
            tickList.noDate.push(r[i]);
    tickList.important.sort(function (a, b) {return a.DTSTART - b.DTSTART;});
    tickList.normal.sort(func[1]);
}
function showIcs(keep) {
    if (!tickListTaskIndex && !forTestUse)
        tickListTaskIndex = addTaskOnPageChange('getIcs()', 6 * 3600 * 1000);
    var t = document.getElementsByClassName('tickList')[0];
    var tickTable = t.getElementsByTagName('table')[0];
    tickTable.innerHTML = '';
    var tickImg = t.getElementsByClassName('tImg')[0];
    if (!keep) tickListStatus++;
    if (!keep && tickListStatus % 6 == 1) {
        tickTable.innerHTML = tickListStatus;
        getIcs();
    } else if (tickListStatus % 3 == 0) {
        t.innerHTML = '<div></div><img class="tImg" style="padding:1rem"><table></table>';
    } else {
        if (tickImg) t.removeChild(tickImg);
        var limit = (tickListStatus % 3 == 1) ? 5 : tickListMaxLine;
        var s = '<tr><td style="opacity:.3">' + dateString() + '<span style="opacity:0">100.00</span></td><td style="font-size:1.5rem;opacity:0;line-height:0">1000</td></tr>';
        var cross30;
        for (var j in tickList) {
            var l = tickList[j];
            for (var i = 0; i < l.length; i++) {
                if (--limit < 0) break;
                var dD = dDay(l[i].DTSTART);
                var adD = Math.abs(dD);
                var td_divider = '';
                if (cross30 == undefined)
                    cross30 = adD;
                if (adD >= 30 && cross30 < 30) {
                    cross30 = 31;
                    td_divider = 'background: lightgray; ';
                }
                if (l[i].SUMMARY.length + l[i].DESCRIPTION.length > 25){
                    var sum='<b>'+l[i].SUMMARY.slice(0, 10)+'</b>';
                    var des=(l[i].SUMMARY.slice(10) + (l[i].SUMMARY.length > 10 && l[i].DESCRIPTION ? ': ' : '') + l[i].DESCRIPTION.slice(0, 200 - Math.min(10, l[i].SUMMARY.length) * 6)).trim();
                } else {
                    var sum=('<b>'+l[i].SUMMARY + '</b> ' + l[i].DESCRIPTION).trim();
                    var des='';
                }
                var freq = (l[i].FREQ) ? '<sup style="font-size:xx-small;border-radius:20%;border:solid">' + l[i].FREQ + '</sup>' : '';
                s += '<tr style="' + (!dD ? 'font-weight:bold; ' : '') + '"><td style="' + td_divider + (l[i].isDateOnly?'text-align: center;':"") + '">' + dateString(l[i].DTSTART, l[i].isDateOnly?'Md':'Mdhm') + '</td><td class="countdown" style="color:hsl(0,0%,' + Math.floor(adD / (!j ? 120 : 480) * 100) + '%);'+(dD<0?'font-size: 1.2rem':'')+'">' + (adD < 7 ? '<img class="tImg" style="height:1.5rem;margin-left:-2rem"><div class="tomato" style="height:' + Math.ceil(adD / 10 * 2) / 2 * 1.5 + 'rem"></div>' : '') + (dD ? dD : '') + '</td><td class="content"><span class="summary"> ' + (!dD ? '<i>' + dHour(l[i].DTSTART) + 'h</i> ' : '') + freq + sum + '</span>' + '<span style="background:white;">' + des + '</span></td></tr>';
            }
        }
        tickTable.innerHTML = s;
        addTaskOnPageChange('displayReminder()', 2.5 * 3600 * 1000, true);//2.5*2=5<6<2.5*3=7.5
    }
}
function alarmIcs(tick) {
    var dH = dHour(tick.DTSTART);
    var d = dMs(tick.DTSTART);
    tickListAlarm = '';
    remindIcs("tickListAlarm='['+'" + dateString(tick.DTSTART) + ' ' + tick.SUMMARY.slice(0, 20) + "'+']'", (dH - 12) * 3600 * 1000);
    remindIcs("tickListAlarm=''", (dH + 12) * 3600 * 1000);
    if (dH >= -1) {
        remindIcs(function remind() {
            tickListReminderList[hashString(tick)] = tick;
            killShadow(true);
            displayReminder()
        }, d - 15 * 60 * 1000);
        remindIcs('killShadow(true)', d - 1 * 60 * 1000);
    }
}
function deleteReminder(tickId) {
    event.stopPropagation();
    if (confirm('Job\'s done?')) {
        delete tickListReminderList[String(tickId)];
        var i = document.getElementById('tick' + tickId);
        var p = i.parentNode;
        p.removeChild(i);
        if (!p.hasChildNodes())
            p.style.display = 'none';
    }
}
function hashString(tick) {
    var s = tick.SUMMARY + tick.DESCRIPTION;
    var hash = 0, i;
    for (i = 0; i < s.length; i++) {
        hash = ((hash << 5) - hash) + s.charCodeAt(i);
        hash |= 0; // Convert to 32bit integer
    }
    return (hash + Math.floor(tick.DTSTART / 1000)).toString(36);
}
function displayReminder() {
    var l = Object.keys(tickListReminderList).length;
    var s = '';
    if (!l)
        return;
    for (var i in tickListReminderList) {
        var tick = tickListReminderList[i];
        s += '<span style="display:block" id="tick' + i + '" onclick="deleteReminder(\'' + i + '\')">' + (tick.FREQ ? '<sup style="font-size:small;border-radius:20%;border:solid">' + tick.FREQ + '</sup>' : '') + '[' + dateString(tick.DTSTART, 'Mdhm') + timeFormat(dMs(tick.DTSTART), 1) + ']<br>' + tick.SUMMARY + '<br>' + tick.DESCRIPTION + '</span>';
    }
    s = s ? s.slice(0, -11) + '</span>' : '';
    if (l > 3)
        reminder.style.cssText = "margin: -28rem 10rem;max-height: 25.5rem;";
    else
        reminder.style.cssText = "";
    reminder.innerHTML = s;
    reminder.style.display = 'block';
    (function shinning(){
        if (Object.keys(tickListReminderList).length){
            tasks(function f(e){reminder.firstChild.style.opacity=e;}, [0, 1, 0, 1, 0, 1], 1e3);
            setTimeout(shinning, 60e3);
        }
    })();
}
function clearReminder(force) {
    var r = force?force:confirm('*CLEAN ALL?*');
    if (r) {
        tickListReminderList = {};
        reminder.style.display = 'none';
    }
    return r;
}
function remindIcs(cmd, timeout) {addTaskOnPageChange(cmd, timeout, true);}//-12h,-15m,-1m,+12h


/*                DANMU: Bilibili Live Danmu
sudo apt-get install python3-distutils
sudo apt-get install python3-pip
sudo pip3 install aiohttp [-i https://source]
python3 sample.py 92613
sudo nano /etc/nginx/nginx.conf
sudo systemctl restart nginx

location /blive/ {
    proxy_http_version 1.1;
    proxy_set_header Upgrade $http_upgrade;
    proxy_set_header Connection $http_connection;
    add_header Access-Control-Allow-Origin *;
    add_header Access-Control-Allow-Headers X-Requested-With;
    add_header Access-Control-Allow-Methods GET,POST,PUT,OPTIONS;
    access_log off;
    proxy_pass http://localhost:8099;
}

# USED IN TAMPERMONKEY for auto-change room-id
// ==UserScript==
// @name         DANMU_ROOM
// @match        *://live.bilibili.com/*
// ==/UserScript==
(function() {
'use strict';
var i=location.pathname.split('/')[1];
if (!isNaN(parseInt(i))){
    var xmlhttp = new XMLHttpRequest();
    xmlhttp.onreadystatechange = function(){
        if (xmlhttp.readyState == 4){
            document.title=(xmlhttp.status==200?'√ ':'['+xmlhttp.status)+document.title;
            console.log("["+i+"] "+xmlhttp.status+" "+xmlhttp.responseText)
        }
    }
    xmlhttp.open('GET', "https://debian10/blive/?"+i);
    xmlhttp.send();
}
})();
*/
var danmuReadCount = 0;
var isDanmuLive = 0;// 0 off, 1 live, other
var danmuStartTime = 0;
var streamer = [['dd', 'wt', 'us', 'fu', 'hs', 'dv', 'tr', 'tr1', 'tz'],
    [16548, 733, 4650105, 1954990, 23251644, 23306811, 2155342, 23132295, 3807617]];
streamer[2] = space(streamer[0].length-1).split(' ');
streamer[3] = streamer[2].slice();
streamer[4] = [.4, .8, .3, .15, .5, .3, .5, .5, 1];
streamer[4][-1]=.5;
var danmuControl = ['history 历史弹幕', 'bye 停止', 'kick 下线', 'info 统计', 'w 切换 watch', 'js[:] 远程脚本', 'time 时间戳', 'f 全屏', 'url 添加 #danmuonly'];
var danmuRoomId = '';
var danmuRoomIndex=-1;
var danmuFirstRoom='';
var danmuSuperChat = '';
var danmuPop = 0;
var danmuPopTrends = 0;
var danmuTaskIndexs = [0, 0, 0, 0];//read,info,stat,title
var danmuMax = 1600;
var danmuRetry = 0;
var danmuLast = '';
var isDanmuWatch=true;
var livePlayer;
var liveRetry=0;
var liveRetryTimer=0;
var liveFrameTimer=0;
function space(n, s) {
    s = s != undefined ? String(s) : '';
    for (n -= s.length * 1.8; n-- > 0;)
        s += ' ';
    return s;
}
function danmuSwitch() {
    switch (isDanmuLive) {
        case 0:
            danmu_info.onclick=function sink(){event.stopPropagation()};
            danmuOn();
            break;
        default:
            if (danmuPop <= 1 || isDanmuOnly) {
                var up = prompt('Current: ' + danmuRoomId + '\nStreamer:\n' + streamer[0] + '\nControl:\n' + danmuControl);
                if (up != null)
                    if (up == '' && (danmuPop <= 1||isDanmuOnly))
                        danmuOff('<b>quit</b>');
                    else
                        danmuOn(up, true);// due to user-gesture policy, fs disabled here
            } else
                danmuOff('<b>connect</b>' + danmuReadCount);
    }
}
function danmuOn(roomId, withoutFullScreen) {
    if (isDanmuOnly&&!withoutFullScreen)
        danmuFullScreen(true);
    roomId=roomId==undefined?'':String(roomId);
    if (roomId.indexOf('http')==0)
        roomId=roomId.replace(/https?:\/\/live\.bilibili\.com\/(\d+)\S*/,'$1');
    if (streamer[0].indexOf(roomId) != -1)
        roomId = streamer[1][streamer[0].indexOf(roomId)];
    if (!roomId)
        danmuWrite('[ON@'+dateString()+']', true, true);
    danmuStartTime = getOffsetTime();
    danmuRetry = 0;
    danmuPop = 0;
    danmu_fr.style.opacity = 1;
    switch (roomId.slice(0, 2)) {
        case 'url':
            f5('', '#danmuonly');
            break;
        case 'w':
            isDanmuWatch=!isDanmuWatch;
            break;
        case 'f':
            isDanmuFullWindow=!isDanmuFullWindow;
            break;
        default:
            isDanmuLive = 1;
            danmuRead(roomId);
    }
    danmuAlter(false);
    setDanmuRoomId(roomId, true);
    danmuInfo();
}
function danmuOff(s) {
    if (!isDanmuLive)
        return;
    isDanmuLive = 0;
    liveOff(false, 'maually');
    clearTimeout(danmuTaskIndexs[0]);
    clearTimeout(danmuTaskIndexs[1]);
    clearTimeout(danmuTaskIndexs[2]);
    clearTimeout(danmuTaskIndexs[3]);
    streamer[2]=[];
    streamer[3]=[];
    setTimeout(function danmuClear() {
        if (!isDanmuLive&&!isDanmuOnly){
            danmu_fr.style.opacity = 0;
            danmu_info.innerHTML = '';
        }
    }, 10 * 60e3);
    danmuAlter(true);
    danmu.innerHTML = '<b>[OFF@'+ dateString() +']</b> ' + (s != undefined ? s + ' ' : '') + '<b>run</b>' + timeFormat(getOffsetTime() - danmuStartTime, 2, true) + '<br>' + (danmu.innerHTML).slice(0, danmuMax / 5) + '...';
    danmuPop = 0;
    danmuInfo();
}
function danmuTitle(s, end, i){// IF end == undefined [s == string] ELSE [start], i for index
    if (i==undefined)
        i=danmuRoomIndex;
    if (typeof end=="number")
        streamer[3][i]=streamer[3][i].slice(s, end);
    else if (typeof s=="string")
        streamer[3][i]=s;
    return streamer[3][i]==undefined||!streamer[3][i].trim()?'... ':streamer[3][i];
}
function danmuAlter(beLess) {
    if (isDanmuFullWindow&&(beLess||danmuPop==1))
        danmuTitle(0,12);
    if (beLess) {
        danmu.style.background = 'white';
        danmu_fr.classList.remove('more');
        danmu_fr.classList.remove('fullwindow');
        danmu_fr.classList.add('less');
        danmu_info.style.fontSize="";
        danmu_info.style.fontWeight="";
    } else {
        danmuRoomTime();
        if (isDanmuLive == 1) {
            danmuRead();
            danmuInfoUpdate();//on danmuRoomId change => danmuRoomTitle();
        }
        danmu.style.background = '';
        danmu_fr.classList.remove('less');
        danmu_fr.classList.add('more');
        danmu_fr.classList.add('fullwindow');
        danmu_info.style.fontSize=isDanmuFullWindow?"1.6rem":"";
        danmu_info.style.fontWeight=isDanmuFullWindow?"bold":"";
    }
}
function setDanmuPop(p) {
    if (isDanmuLive && p != danmuPop && !(danmuPop == 0 && p == 1 && getOffsetTime() - danmuStartTime < 2 * 60 * 1000) || (danmuPop == 9999 && p != 1)) {
        var old = danmuPop;
        danmuPopTrends = p < danmuPop ? -1 : (p == danmuPop ? 0 : 1);
        danmuPop = p;
        if (old == 0 && p > 1)
            reduceShadow();
        if (p == 9999)
            danmuAlter(true);
        else if (p == 1) {
            danmuAlter(true);
            danmuWrite('TRANSMIT' + dateString(), true);
        } else if (old == 9999 || (old == 1 && p > 1))
            danmuAlter(false);
        if (old<=1&&p>1&&p!=9999&&danmuRoomId&&isDanmuOnly&&isDanmuLiveVideo){
            if (forTestUse)
                console.log(p);
            setLiveWidth();
            if (isLiveOff())
                liveFromRoom('changePop');
        }
        danmuInfo();
    }
}
function danmuWrite(s, isBold, isReverse, isInSameLine, stillShowDuplicate) {
    if (!stillShowDuplicate&&danmuLast == (danmuLast = s)) return;
    if (isBold) s = '<b>' + s + '</b>';
    if (isReverse) s = ' <small>' + s + '</small>';
    var buffer = danmu.innerHTML;
    danmu.innerHTML = (s + (buffer ? (isInSameLine ? ' |' : '<br>') + buffer : '')).slice(0, danmuMax);
}
function danmuShow(s) {
    if (!s)
        return;
    var sn = s.split('<br>');
    var s = [];
    if (danmuPop == 1 && sn.length > 5)
        setDanmuPop(2);
    for (var i = 0; i < sn.length; i++) {
        if (!(sn[i] = sn[i].trim()))
            continue;
        if (sn[i].slice(0, 4) == '[JS]') {
            var r = decodeURI(sn[i].slice(4)).split(';');
            setTimeout(function run() {
                comment('', true);
                try {
                    for (var j = 0; j < r.length; j++)
                        if (r[j])
                            comment(eval(r[j]));
                } catch (e) {
                    comment(e);
                }
            }, 0);
        }
        if (sn[i][0] == '[' && sn[i].indexOf(']') != -1)
            sn[i] = ' > '+sn[i];
        if (sn[i] && sn[i].indexOf('[CAFFEINE]') == -1)
            s.push((danmuPop <= 1 ? '<small>' + dateString() + ' </small>' : '') + sn[i]);
    }
    s = s.join("<br>");
    if (danmuPop != 1 && s.indexOf('[RECV]') == -1 && s.indexOf('[SLEEP]') != -1)
        setDanmuPop(1);
    else if (s.indexOf('[LIVE]') != -1)
        danmuAlter(false);
    if (s)
        danmuWrite(s);
    if (s || danmuPop == 9999)
        danmuInfo();
}
function danmuSC(l) {
    danmuSuperChat = '';
    var d = getOffsetTime(0, true);
    for (var i = 0; i < l.length; i++) {
        l[i][0] = Math.floor((l[i][0] - d) / (60 * 1000));
        if (l[i][0] >= 0)
            danmuSuperChat += '<b>￥' + l[i][1] + '</b><small>[+' + l[i][0] + '分]</small> ' + l[i][2] + '<br>';
    }
}
function danmuRead(roomId, f) {
    if (++danmuRetry >= 10) {
        danmuOff('<b>(〃>_<;〃) R</b>' + danmuRetry + '>9 <b>Id</b>' + roomId?roomId:danmuRoomId);
        return;
    } else if (danmuRetry > 3)
        danmuInfo();
    var danmuLoadTime = getOffsetTime();
    httpReq("/blive/" + (roomId ? '?' + roomId : ''), function succ(s) {
        if (s.indexOf('[EXCEP]') == -1)
            danmuRetry = 0;
        if (f == undefined)
            danmuShow(s);
        else
            f(s);
        danmuReadCount++;
    }, function fail(s, p) {
        if (isDanmuLive){
            s='[local:' + s + '] ' + p;
            console.warn(dateString(), danmuRetry, s);
            danmuWrite(s, false, true);
        }
    }, '', '', f == undefined ? function both() {
        var t = getOffsetTime() - danmuLoadTime;
        if (forTestUse&&t >= 5e3)
            comment(Math.floor(t / 1000), getOffsetTime() - danmuStartTime > 10 * 60e3);
        clearTimeout(danmuTaskIndexs[0]);
        if (isDanmuLive)
            danmuTaskIndexs[0] = setTimeout('danmuRead()', danmuRetry > 5 || danmuPop == 1 ? 2 * 60e3 : danmuPop > 5e4 ? 2e3 : 10e3);
    } : undefined);
}
function danmuFullScreen(forceFullScreen){
    if (!isDanmuOnly)
        return;
    try {
        if (!forceFullScreen && (document.fullscreenElement || document.mozFullScreenElement || document.webkitFullScreenElement || document.msFullscreenElement)){
            if (document.exitFullscreen) {
                document.exitFullscreen();
            } else if (document.mozCancelFullScreen) {
                document.mozCancelFullScreen();
            } else if (document.webkitCancelFullScreen) {
                document.webkitCancelFullScreen();
            } else if (document.msCancelFullscreen) {
                document.msCancelFullscreen();
            }
        } else {
            if (danmu_fr.requestFullscreen) {
                danmu_fr.requestFullscreen();
            } else if (danmu_fr.mozRequestFullScreen) {
                danmu_fr.mozRequestFullScreen();
            } else if (danmu_fr.webkitRequestFullScreen) {
                danmu_fr.webkitRequestFullScreen();
            } else if (danmu_fr.msRequestFullscreen) {
                danmu_fr.msRequestFullscreen();
            }
        }
    } catch (e){
        console.warn('[danmuFullScreen] '+e.message);
    }
}
function setDanmuRoomId(s, force){
    if (parseInt(s)){
        if (danmuRoomId != (danmuRoomId = String(s))||force){
            danmuRoomIndex=streamer[1].indexOf(parseInt(danmuRoomId));
            if (!danmuFirstRoom)
                danmuFirstRoom=danmuRoomId;
            if (isDanmuOnly&&isDanmuLiveVideo)
                liveFromRoom('changeRoom');
            danmuRoomTitle();
        }
    } else if (!s)
        setTimeout(danmuRoomTitle, 10e3);
}
function danmuInfoUpdate(s) {
    clearTimeout(danmuTaskIndexs[1]);
    if (isDanmuLive) {
        danmuTaskIndexs[1] = setTimeout('danmuRead("info", danmuInfoUpdate)', !s ? 3 * 1000 : danmuPop == 1 ? 3 * 60e3 : 60e3);
        if (s){
            var info = JsonParse(s);
            if (info) {
                setDanmuRoomId(info.room_id);
                danmuSC(info.super_chat);
                var p = parseInt(info.pop);
                setDanmuPop(parseInt(info.que_size) > 5 && p == 1 ? 2 : p);
            }
        }
    }
}
function danmuInfo() {
    var status = ['OFF', streamer[2][danmuRoomIndex] ? streamer[2][danmuRoomIndex] : 'oи' + (danmuPop == 9999 ? '☕' : ''), 'ᗯατcᏥ'][isDanmuLive];//watch is not used now
    var liveStatus='';
    var extraButton=isDanmuOnly?atag(' ▲<small>'+(!isLiveOff()&&livePlayer.volume!=undefined?Math.floor(livePlayer.volume*10):'')+'</small> ', false, 'hSwitch(1)', '灯 \nLet there be light')+atag('▼'+(isDanmuScrollInput?danmuScrollNum+(danmuScrollCurrentNum!=undefined?danmuScrollCurrentNum:'N'):' '), false, 'danmuScrollInput()', '滚轮输入数字，单击输入下一位，双击确认 \nscroll to input number, click once to next, twice to confirm'):'';
    if (!isOnKindle)
        for (var i=0;i<streamer[0].length;i++)
            if (isDanmuWatch&&streamer[2][i]&&danmuRoomId!=i)
                liveStatus+='| '+atag(streamer[2][i]+' '+(streamer[3][i]==undefined?'':streamer[3][i]), false, "danmuOn("+streamer[1][i]+")", streamer[0][i]);
    var dTrends = danmuPop < 1e4 ? (danmuPop < 1e3 ? String(danmuPop) : Math.floor(danmuPop / 1e2) / 10 + 'K'): Math.floor(danmuPop / 1e3) / 10 + '万';
    if (dTrends.indexOf('.') != -1) {
        dTrends = dTrends.split('.');
        var a = ['sub', 'small', 'sup'][danmuPopTrends + 1];
        dTrends[1] = '<' + a + '>' + dTrends[1][0] + '</' + a + '>' + dTrends[1].slice(1);
        dTrends = dTrends.join('');
    }
    var signal=Math.floor(streamer[2].filter(function f(s){return s!=''}).length/streamer[2].length*5);
    signal=new Array(signal+1).join('•')+new Array(5-signal+1).join('◦');
    if (danmuRetry > 3)
        status = ' ⁉' + danmuRetry;
    danmu_info.innerHTML = atag(!isDanmuLive ? '热度' : isDanmuLive == 2 || !streamer[2].join('') ? '人气' : '<big>' + signal + '</big> ', false, 'danmuFullScreen()', 'FullScreen') + atag(dTrends, false, 'liveRotate()', 'Rotate') + extraButton + '<span style="float:right">'+atag(danmuTitle(), 'https://live.bilibili.com/blanc/'+danmuRoomId) + '<b>' + atag(status, false, "f5('', '#danmuOnly')", 'Refresh') + '</b></span><br>' + (liveStatus?'<b><small '+(isDanmuOnly?'style="background: rgba(0, 0, 0, .4)"':'')+'>' +liveStatus.slice(1) + atag(' [' +dateString() + ']', false, "danmuOn("+danmuFirstRoom+")", danmuFirstRoom)+'</b></small><br>':'') + danmuSuperChat;

    function atag(inner, href, onclick, title){
        return (isOnKindle?'<a':'<a style="text-decoration: none;color: inherit;' + (href?'" href="'+href+'" target="_blank"':'cursor: pointer"'))+(onclick?' onclick="'+onclick+'"':'') +(title?' title="'+title+'"':'')+'>' + inner + '</a>';
    }
}
function danmuScrollInput(){
    if (isDanmuScrollInput){
        if (danmuScrollCurrentNum==undefined){
            isDanmuScrollInput=false;
            danmuOn(danmuScrollNum);
            danmuScrollNum='';
        } else
            danmuScrollNum+=String(danmuScrollCurrentNum);
    } else
        isDanmuScrollInput=true;
    danmuScrollCurrentNum=undefined;
    danmuInfo();
}
function danmuRoomTime(n) {
    clearTimeout(danmuTaskIndexs[2]);
    if (isDanmuLive) {
        if (n == undefined)
            n = 0;
        danmuRead("cors:https://api.live.bilibili.com/room/v1/Room/room_init?id=" + streamer[1][n++ % streamer[1].length], parseTime);
        danmuTaskIndexs[2] = setTimeout('danmuRoomTime(' + n + ')', danmuPop == 1 || n % streamer[1].length == 0 || danmuRetry >= 3 ? 5*60e3 : 3e3);
    }
    function parseTime(s) {//'101m'
        var stat = JsonParse(s);
        if (stat.code == 0) {
            stat = stat.data;
            var i = streamer[1].indexOf(stat.short_id);
            if (i == -1)
                i = streamer[1].indexOf(stat.room_id);
            if (i != -1 && streamer[2][i] != (streamer[2][i] = humanTill(stat.live_time)))
                danmuInfo();
        }
        function humanTill(t){
            if (t>0){
                t=getOffsetTime(0, true) / 1000 - t;
                if (t<5*3600)
                    return Math.floor(t / 60) + 'm';
                else
                    return Math.floor(t / 60 / 60) + 'h';
            } else
                return '';
        }
    }
}
function danmuRoomTitle(n) {
    clearTimeout(danmuTaskIndexs[3]);
    if (isDanmuLive == 1) {
        var i, t;
        if (n==undefined){
            n=0;
            i=danmuRoomId;
            t=danmuRoomId?10e3:60e3;
        } else {
            n=(n+1)%streamer[1].length;
            i=streamer[1][n];
            t=danmuRetry >= 3 || danmuPop==1 ? 600e3 : (streamer[3].indexOf('')==-1? 300e3 : 60e3);
        }
        danmuTaskIndexs[3] = setTimeout("danmuRoomTitle("+n+")", t);
        danmuRead("cors:https://api.live.bilibili.com/room/v1/Room/room_init?id=" + i, function collect(s){parseTitle(s, i);});
    }
    function parseTitle(s, i){
        var data = JsonParse(s).data;
        if (data)
            danmuRead("cors:https://api.bilibili.com/x/space/acc/info?mid=" + data.uid, function a(s) {
                var stat = JsonParse(s);
                if (stat.code == 0) {
                    s = [stat.data.name, stat.data.live_room.title];
                    var limit=isDanmuFullWindow?23:13;
                    danmuTitle(((s[0].length + s[1].length > limit ? s[0].slice(-3) + s[1] : s[0] + s[1])+ ' ').slice(0, limit), '', streamer[1].indexOf(i));
                    danmuInfo();
                }
            });
    }
}
function liveInfo(title, detail, forceLog, bgColor){
    if (detail==undefined)
        detail='';
    danmu_live_info.innerHTML=('<b>['+dateString()+'@'+title+'] '+detail+'</b><br>'+danmu_live_info.innerHTML).slice(0, 600)+'..';
    var res=' > ['+title+'] '+detail;
    var s=dateString('dhm')+res;
    if (forTestUse||forceLog){
        if (bgColor)
            console.log('%c'+s, 'color: white; background: '+bgColor);
        else
            console.log(s);
    }
    return res;
}
function isLiveOff(){
    return livePlayer==undefined;
}
function liveFromRoom(description){
    if (!mpegts.isSupported())
        comment('mpegts.js is not supported.');
    var room=danmuRoomId;
    liveRetry=0;
    clearTimeout(liveRetryTimer);
    liveGetLock('roomLock');//alse to get livePlayer locked
    liveInfo('Load:'+room+(description?':'+description:''), 'get url', true, 'SeaGreen');//10000 400 250 150 80 != [4, 0]
    danmuRead('cors:https://api.live.bilibili.com/room/v1/Room/playUrl?cid='+room+'&platform=web&otype=json&quality=3', function parse(s){
        s=JsonParse(s);
        if (typeof s.data!="undefined"&&s.data.durl){
            liveFromUrl(s.data.durl.slice(-2)[0].url);
            danmuWrite(liveInfo('Live:qn'+s.data.current_qn, 'Start'), true, true, true);//4,10000 3,400 2,250 1,150 0,80
        }
    });
    var lastUrlCache='';
    function liveFromUrl(url, audioOnly){
        if (url)
            lastUrlCache=url;
        else {
            if (lastUrlCache)
                url=lastUrlCache;
            else {
                liveInfo('Quit:'+liveRetry, 'Empty lastUrlCache', true);
                return false;
            }
        }
        liveGetLock('urlLock');// necessary
        livePlayer = mpegts.createPlayer({
            type: 'flv',  // mse, mpegts, m2ts, flv
            isLive: true,
            url: url,
            hasVideo: !audioOnly,
        }, {
            liveBufferLatencyChasing: true,
            liveBufferLatencyMaxLatency: 30,
            liveBufferLatencyMinRemain: 2,
        });
        livePlayer.on(mpegts.Events.ERROR, function c(errType, errDetail){
            clearTimeout(liveRetryTimer);
            if (++liveRetry<5){// errDetail=="HttpStatusCodeInvalid"
                liveInfo('Reload:'+liveRetry+':'+errType, errDetail, true, 'burlywood');
                liveRetryTimer=setTimeout(liveFromUrl, Math.pow(liveRetry+1, 2)*1e3);
            } else {
                liveInfo('Quit:'+liveRetry+':'+errType, errDetail);
                liveOff(false, liveRetry+':'+errDetail);
            }
        });
        livePlayer.attachMediaElement(danmu_live);
        mpegts.LoggingControl.enableAll=false;
        if (forTestUse){
            mpegts.LoggingControl.enableError=true;// only on http code error, useless
            mpegts.LoggingControl.enableWarn=true;// too many audio frame correction warns
        }
        livePlayer.load();
        livePlayer.volume=streamer[4][danmuRoomIndex];
        livePlayer.muted=false;
        danmu_live.playbackRate=1;
        livePlayer.play();
        danmu_live.style.opacity='1';
        clearTimeout(liveFrameTimer);
        liveFrameTimer=setTimeout(function lowLoadWatcher(){
            if (livePlayer&&livePlayer.mediaInfo&&livePlayer.mediaInfo.hasVideo){
                var drop=livePlayer.statisticsInfo.droppedFrames;
                var ratio=Math.floor(livePlayer.statisticsInfo.decodedFrames/drop*100)/100;
                if (drop>1000)
                    if (ratio<1){
                        liveFromUrl('', true);
                        return liveInfo('reduceDrop'+drop+':audio', ratio+' < 1', true);
                    } else if (ratio<1.7){
                        danmu_live.playbackRate=.8;
                        return liveInfo('reduceDrop'+drop+':slow.8', ratio+' < 1.7', true);
                    } else if (ratio<1.85){
                        danmu_live.playbackRate=.9;
                        return liveInfo('reduceDrop'+drop+':slow.9', ratio+' < 1.85', true);
                    }
                return liveInfo('frameInfo', 'D'+drop+':R'+ratio);
            }
        }, 120e3);
    }
}
function setLiveWidth(isLager){
    if (danmuPop>1&&isLager==undefined)//(1, 1e4) [2e4, 7e4) [8e4, )
        if (danmuPop<1e4){
            isLager=true;
            danmu_fr.style.fontSize=(parseFloat(danmuFontSizeFullScreen[0])/1.35+danmuFontSizeFullScreen[1]);
        } else if (danmuPop>=2e4&&danmuPop<7e4)
            isLager=true;
        else if (danmuPop>=8e4){
            isLager=false;
            danmu_fr.style.fontSize=danmuFontSizeFullScreen.join('');
        }
    if (isLager){
        danmu_live.classList.add('large');
        danmu.style.color='';
    } else if (isLager!=undefined){
        danmu_live.classList.remove('large');
        danmu.style.color='rgba(255, 255, 255, .3)';
    }
}
function liveChangeVolume(value){
    if (livePlayer&&typeof livePlayer.volume=='number'){
        value=Math.floor(value*10);
        var oldv=Math.floor(livePlayer.volume*10);
        var newv=Math.floor(oldv+value);
        newv=newv>10?10:newv<0?0:newv;
        livePlayer.volume=newv/10;
        return newv;
    }
}
function liveGetLock(s){
    liveOff(true, s?s:'getLock', 'DimGray');
}
function liveRotate(){
    danmu_live.classList.toggle('rotate');

}
function liveOff(getLock, s, bgColor){
    if (livePlayer&&livePlayer.destroy){
        livePlayer.destroy();
        liveInfo('Ended:'+(s?s:'danmu_live'), '', true, bgColor?bgColor:'pink');
    }
    livePlayer=getLock?{}:undefined;
    danmu_live.style.opacity='0';
    setTimeout(function clearInfo(){
        if (!livePlayer)
            danmu_live_info.opacity='0';
    }, 10*60e3);
}


/*               HOME: for Hue
http://philips-hue/debug/clip.html
https://developers.meethue.com/develop/get-started-2/

location /hue/ {
    proxy_redirect off;
    proxy_buffering off;
    proxy_http_version 1.1;
    proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
    proxy_set_header Upgrade $http_upgrade;
    proxy_set_header Connection $http_connection;
    add_header Access-Control-Allow-Methods *;
    add_header Access-Control-Allow-Credentials true;
    add_header Access-Control-Allow-Origin $http_origin;
    if ($request_method = OPTIONS){
    return 200;
    }
    access_log off;
    proxy_pass https://philips-hue/api/;
}
*/
var home = document.getElementsByClassName('home')[0];
var hueUser = {"devicetype": 'A 3-switch kindle-based controller.'};
var switchs = {};//{1:{on:false, name:"Somelight", reachable:true}}
var hLast = 0;
var hPreventNetworkError=hueBaseUrl!='/hue/';
function hHelp() {
    hFail('1. Press the Hue Link button 2. Run hReg() 3. Change the hueToken in this page file');
    alert('hueToken in *Basic Settings* is invalid');
}
function hCollect(f) {
    if (!hueToken) {
        hHelp();
        return;
    }
    hLast = new Date().getTime();
    httpReq(hueBaseUrl + hueToken + '/lights/', function hParse(s) {
        var s = JsonParse(s);
        if (Array.isArray(s)) {
            comment(JSON.stringify(s[0]));
            hueToken = '';
        } else {
            switchs = {};
            for (var i in s)
                switchs[i] = {on: s[i].state.on, name: s[i].name, reachable: s[i].state.reachable};
            if (typeof f == "function")
                f();
            else
                hUpdate();
        }
    }, hFail);
}
function hFail(s) {
    console.warn(s);
    comment('<a href="'+hueBaseUrl+hueToken+'">'+s+'</a>');
}
function hReg() {
    httpReq(hueBaseUrl, function hParse(s) {
        var s = JsonParse(s)[0];
        if ("success" in s)
            hueToken = s.success.username;
        else
            comment(JSON.stringify(s));
    }, hFail, JSON.stringify(hueUser));
}
function hSwitch(n) {
    if (event)
        event.stopPropagation();
    if (!hueToken) {
        hHelp();
        return;
    }
    var butt = document.getElementsByClassName('hs' + n)[0];
    if (butt)
        butt.style.background = "rgba(128,128,128,.2)";
    if (hPreventNetworkError && hLast && new Date().getTime() - hLast > 3 * 3600 * 1000 && !isHomeShrink)
        f5('', '#hSwitch(' + n + ')');
    else
        setTimeout(function act() {
            hCollect(function hChange() {
                httpReq(hueBaseUrl + hueToken + '/lights/' + n + '/state/', function hParse(s) {
                    var s = JsonParse(s)[0];
                    if ("success" in s)
                        hCollect();
                    else
                        comment(JSON.stringify(s));
                }, hFail, JSON.stringify({'on': !switchs[n].on}), 'PUT', isFastLoad&&!isDanmuOnly?window.close:undefined);
            });
        });
}
function hUpdate() {
    var l = Object.keys(switchs).length;
    if (!hueToken)
        hHelp();
    else if (!l)
        hCollect();
    else {
        home.innerHTML = '';
        if (l>=3)
            home.classList.add('more');
        else
            home.classList.remove('more');
        for (var i in switchs) {
            var hs = document.createElement('div');
            var sdcolor=(switchs[i].on ? "black" : "white");
            hs.setAttribute('class', 'h_switch hs' + i);
            hs.setAttribute('onclick', 'hSwitch(' + i + ')');
            hs.appendChild(document.createTextNode(switchs[i].name));
            home.appendChild(hs);
            hs.style.cssText = (switchs[i].reachable ? "" : "border-color: gray;")
                + "width: " + (switchs[i].reachable ? "12rem;" : "8rem;")
                + (isHomeShrink || (toStatus && toStatus != 'stop') ? "height: 8rem;" : "")
                + (switchs[i].on ? "background: rgba(255,255,255, .2);" : "")
                + (switchs[i].on ? "" : "color: black;")
                + "text-shadow: 4px 4px 0 "+sdcolor+", -4px -4px 0 "+sdcolor+", -4px 4px 0 "+sdcolor+", 4px -4px 0 "+sdcolor;
        }
        if (!isOnKindle)
            home.innerHTML += "<div class='h_switch' " + (isHomeShrink ? "style='height:8rem'" : "") + " onclick=\"location.hash='#hSwitch(1)#fastload'\">Star</div>";
    }
}

var loaded = true;
  </script>
</body>
</html>
